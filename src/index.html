<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨ - åŸå‹</title>
    <style>
body {
  font-family: "Courier New", monospace;
  background-color: #2a2a2a;
  color: #e0e0e0;
  margin: 0;
  padding: 20px;
  line-height: 1.4;
}

.game-container {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 20px;
}

.main-area {
  background: #1a1a1a;
  border: 2px solid #555;
  border-radius: 8px;
  padding: 20px;
}

.sidebar {
  background: #1a1a1a;
  border: 2px solid #555;
  border-radius: 8px;
  padding: 15px;
}

.status-bar {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
  font-size: 14px;
  flex-wrap: wrap;
}

.status-bar > div {
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  border: 1px solid #555;
}

/* æ ¹æ“šç‹€æ…‹è®ŠåŒ–é¡è‰² */
#buildingDefenseText {
  color: #66ccff;
}

#landlordHungerText {
  color: #ffcc66;
}

/* å±éšªç‹€æ…‹çš„ç´…è‰²è­¦å‘Š */
.danger-status {
  color: #ff6666 !important;
  animation: pulse 2s infinite;
}

.good-status {
  color: #66ff66 !important;
}

.house-layout {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.room {
  aspect-ratio: 1;
  border: 2px solid #666;
  background: #333;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.room:hover {
  border-color: #888;
  background: #444;
}

.room.occupied {
  background: #2d4a2d;
  border-color: #4a7c59;
}

.room.needs-repair {
  background: #4a2d2d;
  border-color: #7c4a4a;
}

.room.infected {
  background: #4a2d2d;
  border-color: #cc4444;
  animation: pulse 2s infinite;
}

.room.reinforced {
  border-color: #4a7c9a;
  box-shadow: inset 0 0 10px rgba(74, 124, 154, 0.3);
}

@keyframes pulse {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

.tenant-info {
  font-size: 12px;
  text-align: center;
}

.resources {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.resource {
  background: #333;
  padding: 10px;
  border-radius: 4px;
  text-align: center;
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

.btn {
  background: #4a4a4a;
  border: 1px solid #666;
  color: #e0e0e0;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn:hover {
  background: #555;
}

.btn:disabled {
  background: #333;
  color: #666;
  cursor: not-allowed;
}

.btn.danger {
  background: #664444;
  border-color: #aa6666;
}

.btn.success {
  background: #446644;
  border-color: #66aa66;
}

.btn.special {
  background: #666644;
  border-color: #aaaa66;
}

.log {
  background: #222;
  border: 1px solid #444;
  height: 150px;
  overflow-y: auto;
  padding: 10px;
  font-size: 12px;
}

.log-entry {
  margin-bottom: 5px;
  padding: 2px 0;
}

.log-entry.event {
  color: #ffcc66;
}

.log-entry.rent {
  color: #66ff66;
}

.log-entry.danger {
  color: #ff6666;
}

.log-entry.skill {
  color: #66ccff;
}

.tenant-list {
  margin-bottom: 15px;
}

.tenant-item {
  background: #333;
  margin: 5px 0;
  padding: 8px;
  border-radius: 4px;
  font-size: 12px;
}

.tenant-item.infected {
  background: #663333;
  border-left: 3px solid #cc4444;
}

.tenant-item.doctor {
  border-left: 3px solid #66cc66;
}

.tenant-item.worker {
  border-left: 3px solid #cc8866;
}

.tenant-item.soldier {
  border-left: 3px solid #cc6666;
}

.tenant-item.farmer {
  border-left: 3px solid #66aa44;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
}

.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #2a2a2a;
  border: 2px solid #666;
  border-radius: 8px;
  padding: 20px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.applicant {
  background: #333;
  margin: 10px 0;
  padding: 10px;
  border-radius: 4px;
}

.applicant.infected {
  background: #663333;
  border: 2px solid #cc4444;
}

.applicant.trader {
  background: #334466;
  border: 2px solid #6688aa;
}

.status-bar {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
  font-size: 14px;
}

.modal-content p {
  margin: 6px 0;
  font-size: 13px;
  line-height: 1.5;
}

.modal-content strong {
  color: #ffcc66;
}

.modal-content .status-good {
  color: #66ff66;
  font-weight: bold;
}

.modal-content .status-bad {
  color: #ff6666;
  font-weight: bold;
}

.modal-content .status-neutral {
  color: #ccc;
  font-weight: bold;
}

.modal-content .tenant-detail-block {
  background: #1e1e1e;
  padding: 10px 15px;
  border-left: 4px solid #666;
  border-radius: 6px;
  margin-bottom: 10px;
}

.modal-content .action-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 15px;
  justify-content: flex-end;
}

.tenant-skill-group {
  background: #2d3d2d;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  border-left: 4px solid #66ccff;
}

.skill-actions {
  background: #1e2e1e;
  padding: 10px;
  border-radius: 4px;
  margin: 8px 0;
  border-left: 3px solid #ffcc66;
}

.skill-actions h5 {
  margin: 0 0 5px 0;
  color: #ffcc66;
}

.skill-actions p {
  margin: 5px 0;
  font-size: 12px;
  color: #ccc;
}

.skill-actions .btn {
  margin-top: 8px;
}
.skill-actions h4 {
  margin: 0 0 10px 0;
  color: #66ccff;
}

.skill-cooldown {
  color: #ff9966;
  font-size: 11px;
}

    </style>
</head>
<body>
<div class="game-container">
  <div class="main-area">
    <div class="status-bar">
      <div>ç¬¬ <span id="day">1</span> å¤©</div>
      <div>æ™‚é–“: <span id="time">ç™½å¤©</span></div>
      <div>ğŸ’° ç¾é‡‘: $<span id="cash">50</span></div>
      <div>ğŸ›¡ï¸ é˜²ç¦¦: <span id="buildingDefenseText">è„†å¼±(0)</span></div>
      <div>ğŸ½ï¸ é£¢é¤“: <span id="landlordHungerText">é£½è¶³(0)</span></div>
    </div>

    <div class="house-layout">
      <div class="room" id="room1" onclick="selectRoom(1)">
        <div class="tenant-info" id="room1-info">ç©ºæˆ¿</div>
      </div>
      <div class="room" id="room2" onclick="selectRoom(2)">
        <div class="tenant-info" id="room2-info">ç©ºæˆ¿</div>
      </div>
    </div>

    <div class="resources">
      <div class="resource">
        ğŸ– é£Ÿç‰©: <span id="food">20</span>
      </div>
      <div class="resource">
        ğŸ”§ å»ºæ: <span id="materials">15</span>
      </div>
      <div class="resource">
        ğŸ’Š é†«ç™‚: <span id="medical">10</span>
      </div>
      <div class="resource">
        â›½ ç‡ƒæ–™: <span id="fuel">8</span>
      </div>
    </div>

    <div class="controls">
      <button class="btn success" onclick="collectRent()">æ”¶ç§Ÿ</button>
      <button class="btn" onclick="showVisitors()">æŸ¥çœ‹è¨ªå®¢</button>
      <button class="btn" onclick="showScavengeMenu()">æ´¾é£æœåˆ® (<span id="scavengeCount">0</span>/2)</button>
      <button class="btn" onclick="harvestYard()">é™¢å­æ¡é›†</button>
      <button class="btn special" onclick="showSkillMenu()">ä½¿ç”¨æŠ€èƒ½</button>
      <button class="btn danger" onclick="nextDay()">ä¸‹ä¸€å¤©</button>
    </div>

    <div class="log" id="gameLog">
      <div class="log-entry">éŠæˆ²é–‹å§‹ï¼ä½ ç¹¼æ‰¿äº†é€™æ£Ÿè€æˆ¿å­ï¼Œæœ«æ—¥ä¸­çš„å€–å­˜è€…å€‘æ­£åœ¨å°‹æ‰¾ä½æ‰€...</div>
    </div>
  </div>

  <div class="sidebar">
    <h3>ç§Ÿå®¢åˆ—è¡¨</h3>
    <div class="tenant-list" id="tenantList">
      <div class="tenant-item">æš«ç„¡ç§Ÿå®¢</div>
    </div>

    <h3>éŠæˆ²èªªæ˜</h3>
    <div style="font-size: 11px;">
      <p>â€¢ é»æ“Šæˆ¿é–“æŸ¥çœ‹è©³æƒ…</p>
      <p>â€¢ é‚€è«‹è¨ªå®¢ç§Ÿæˆ¿æˆ–äº¤æ˜“</p>
      <p>â€¢ å•†äººè¨ªå®¢æä¾›å„ç¨®äº¤æ˜“</p>
      <p>â€¢ ç§Ÿå®¢å¯ç”¨è³‡æºæŠµä»˜æˆ¿ç§Ÿ</p>
      <p>â€¢ å–„ç”¨ç§Ÿå®¢æŠ€èƒ½æ±‚ç”Ÿ</p>
      <p>â€¢ æˆ¿æ±ä¹Ÿéœ€è¦é£Ÿç‰©ç¶­ç”Ÿ</p>
      <p>â€¢ ç•™æ„å•†éšŠå’Œæµæµªå•†äºº</p>
    </div>
  </div>
</div>

<!-- è¨ªå®¢æ¨¡æ…‹æ¡† -->
<div class="modal" id="visitorModal">
  <div class="modal-content">
    <h3>ä»Šæ—¥è¨ªå®¢</h3>
    <div id="visitorList"></div>
    <button class="btn" onclick="closeModal()">é—œé–‰</button>
  </div>
</div>

<!-- ç§Ÿå®¢ç®¡ç†æ¨¡æ…‹æ¡† -->
<div class="modal" id="tenantModal">
  <div class="modal-content">
    <h3 id="tenantModalTitle">ç§Ÿå®¢ç®¡ç†</h3>
    <div id="tenantModalContent"></div>
    <div id="tenantModalActions" class="action-buttons"></div>
  </div>
</div>

<!-- æ´¾é£æœåˆ®æ¨¡æ…‹æ¡† -->
<div class="modal" id="scavengeModal">
  <div class="modal-content">
    <h3>é¸æ“‡æ´¾é£äººå“¡</h3>
    <p>å‰©ä½™æ´¾é£æ¬¡æ•¸: <span id="remainingScavenges">2</span></p>
    <div id="availableTenants"></div>
    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
  </div>
</div>

<!-- æŠ€èƒ½é¸å–®æ¨¡æ…‹æ¡† -->
<div class="modal" id="skillModal">
  <div class="modal-content">
    <h3>ç§Ÿå®¢æŠ€èƒ½</h3>
    <div id="skillList"></div>
    <button class="btn" onclick="closeModal()">é—œé–‰</button>
  </div>
</div>

<!-- äº‹ä»¶æ¨¡æ…‹æ¡† -->
<div class="modal" id="eventModal">
  <div class="modal-content">
    <h3 id="eventTitle">äº‹ä»¶</h3>
    <p id="eventDescription"></p>
    <div id="eventChoices"></div>
  </div>
</div>

    <script>
// éŠæˆ²ç‹€æ…‹ - å¢å¼·ç‰ˆ
let gameState = {
  day: 1,
  time: "day",
  resources: { food: 20, materials: 15, medical: 10, fuel: 8, cash: 50 },
  totalIncome: 0,
  rooms: [
    { id: 1, tenant: null, needsRepair: false, reinforced: false },
    { id: 2, tenant: null, needsRepair: false, reinforced: false }
  ],
  applicants: [],
  visitors: [],
  gameLog: [],
  landlordHunger: 0,
  harvestUsed: false,
  harvestCooldown: 0,
  scavengeUsed: 0,
  maxScavengePerDay: 2,
  rentCollected: false,
  buildingDefense: 0,
  buildingQuality: 0,

  // æ–°å¢ï¼šç§Ÿå®¢æ»¿æ„åº¦å’Œé—œä¿‚ç³»çµ±
  tenantSatisfaction: {},
  tenantRelationships: [],
  conflictHistory: [],
  harmoniumBonus: 0,

  // æ–°å¢ï¼šå…¨å±€æ•ˆæœè¿½è¹¤
  emergencyTraining: false,
  foodPreservation: false,
  patrolSystem: false,
  socialNetwork: false,
  nightWatchActive: false,

  // æ–°å¢ï¼šåŠ æˆæ•ˆæœ
  harvestBonus: false,
  scavengeBonus: false,

  conflictCooldown: 0,
  lastConflictDay: 0
};

// ç§Ÿå®¢é¡å‹ï¼ˆå¢å¼·ç‰ˆï¼‰
const tenantTypes = [
  {
    name: "é†«ç”Ÿ",
    type: "doctor",
    rent: 15,
    skill: "é†«ç™‚",
    infectionRisk: 0.1,
    description: "å¯ä»¥æ²»ç™‚æ„ŸæŸ“ï¼Œæª¢æ¸¬å¯ç–‘ç§Ÿå®¢ï¼Œæä¾›é†«ç™‚æœå‹™",
    personalResources: { food: 3, medical: 5, cash: 20 },
    skills: {
      healInfection: { cooldown: 0, cost: { medical: 3, cash: 12 } },
      healthCheck: { cooldown: 0, cost: { medical: 1, cash: 8 } },
      medicalProduction: { passive: true },
      emergencyTraining: { special: true, cost: { cash: 15 } }
    }
  },
  {
    name: "å·¥äºº",
    type: "worker",
    rent: 12,
    skill: "ç¶­ä¿®",
    infectionRisk: 0.2,
    description: "æ“…é•·ç¶­ä¿®å»ºç¯‰ï¼Œæˆ¿é–“å‡ç´šï¼Œå»ºç¯‰æ”¹è‰¯",
    personalResources: { food: 4, materials: 8, cash: 15 },
    skills: {
      efficientRepair: { cooldown: 0, cost: { cash: 10 } },
      reinforceRoom: { cooldown: 0, cost: { materials: 4, cash: 18 } },
      dailyMaintenance: { passive: true },
      buildingUpgrade: { special: true, cost: { materials: 8, cash: 25 } }
    }
  },
  {
    name: "è¾²å¤«",
    type: "farmer",
    rent: 10,
    skill: "ç¨®æ¤",
    infectionRisk: 0.15,
    description: "æå‡é™¢å­æ¡é›†æ•ˆç‡ï¼Œç¨®æ¤ä½œç‰©ï¼Œé‡å¤–æ¡é›†",
    personalResources: { food: 8, materials: 2, cash: 12 },
    skills: {
      harvestBonus: { passive: true },
      plantCrops: { cooldown: 3, cost: { food: 3, cash: 8 } },
      wildForaging: { cooldown: 2, cost: { cash: 6 } },
      foodPreservation: { special: true, cost: { cash: 20 } }
    }
  },
  {
    name: "è»äºº",
    type: "soldier",
    rent: 18,
    skill: "æˆ°é¬¥",
    infectionRisk: 0.25,
    description: "æˆ°é¬¥åŠ›å¼·ï¼Œæå‡æˆ¿å±‹é˜²ç¦¦ï¼Œå®‰å…¨ç®¡ç†",
    personalResources: { food: 5, materials: 3, cash: 25 },
    skills: {
      combatBonus: { passive: true },
      nightWatch: { cooldown: 0, cost: { cash: 15 } },
      defensiveConstruction: { cooldown: 0, cost: { materials: 5, cash: 22 } },
      patrolSystem: { special: true, cost: { cash: 30 } }
    }
  },
  {
    name: "è€äºº",
    type: "elder",
    rent: 8,
    skill: "ç¶“é©—",
    infectionRisk: 0.3,
    description: "ç¶“é©—è±å¯Œï¼Œèª¿è§£ç³¾ç´›ï¼Œç¤¾äº¤ç®¡ç†ï¼Œäººéš›ç¶²çµ¡",
    personalResources: { food: 2, medical: 3, cash: 30 },
    skills: {
      peacemaker: { passive: true },
      conflictMediation: { cooldown: 0, cost: { cash: 12 } },
      lifeGuidance: { cooldown: 2, cost: { cash: 10 } },
      establishNetwork: { special: true, cost: { cash: 25 } }
    }
  }
];

// å¢å¼·çš„ç³¾ç´›äº‹ä»¶ç³»çµ±
const conflictEvents = [
  {
    title: "è³‡æºåˆ†é…ç³¾ç´›",
    description: "ç§Ÿå®¢å€‘å°å…±ç”¨è³‡æºçš„ä½¿ç”¨ç”¢ç”Ÿåˆ†æ­§ï¼Œæ°£æ°›ç·Šå¼µ",
    trigger: () => {
      const occupiedCount = getOccupiedRooms().length;
      return (
        occupiedCount >= 2 &&
        (gameState.resources.food < occupiedCount * 4 ||
          gameState.resources.fuel < 5)
      );
    },
    getChoices: () => {
      const elders = getElderTenants();
      const choices = [];

      choices.push({
        text: "å¢åŠ å…±ç”¨è³‡æº (-6é£Ÿç‰©, -3ç‡ƒæ–™)",
        condition: () =>
          gameState.resources.food >= 6 && gameState.resources.fuel >= 3,
        effect: () => {
          gameState.resources.food -= 6;
          gameState.resources.fuel -= 3;
          addLog("å¢åŠ å…±ç”¨è³‡æºï¼Œå¹³æ¯äº†åˆ†é…ç³¾ç´›", "event");

          Object.keys(gameState.tenantSatisfaction).forEach((name) => {
            gameState.tenantSatisfaction[name] += 3;
          });
        }
      });

      choices.push({
        text: "åˆ¶å®šä½¿ç”¨è¦å‰‡ (-$8åˆ¶ä½œè¦ç« )",
        condition: () => gameState.resources.cash >= 8,
        effect: () => {
          gameState.resources.cash -= 8;
          addLog("åˆ¶å®šäº†è³‡æºä½¿ç”¨è¦ç« ï¼Œå‹‰å¼·è§£æ±ºç³¾ç´›", "event");

          Object.keys(gameState.tenantSatisfaction).forEach((name) => {
            gameState.tenantSatisfaction[name] -= 2;
          });
        }
      });

      if (elders.length > 0) {
        choices.push({
          text: `è«‹ ${elders[0].name} é€²è¡Œè³‡æºèª¿è§£`,
          effect: () => {
            const elder = elders[0];
            const tenants = gameState.rooms
              .filter((r) => r.tenant)
              .map((r) => r.tenant);
            let totalThanksFee = 0;

            tenants.forEach((tenant) => {
              if (tenant !== elder && tenant.personalResources.cash >= 4) {
                const thanksFee = Math.floor(Math.random() * 3) + 3;
                tenant.personalResources.cash -= thanksFee;
                totalThanksFee += thanksFee;
              }
            });

            elder.personalResources.cash += totalThanksFee;

            let sharedFood = 0;
            tenants.forEach((tenant) => {
              if (tenant !== elder && tenant.personalResources.food >= 3) {
                tenant.personalResources.food -= 1;
                sharedFood += 1;
              }
            });
            gameState.resources.food += sharedFood;

            addLog(`é•·è€… ${elder.name} æˆåŠŸèª¿è§£è³‡æºç³¾ç´›`, "skill");
            addLog(`ç§Ÿå®¢å€‘å…±äº«äº† ${sharedFood} é£Ÿç‰©åˆ°å…¬ç”¨å€åŸŸ`, "event");
            addLog(`${elder.name} ç²å¾— $${totalThanksFee} èª¿è§£æ„Ÿè¬è²»`, "rent");

            Object.keys(gameState.tenantSatisfaction).forEach((name) => {
              gameState.tenantSatisfaction[name] += 8;
            });
            gameState.harmoniumBonus += 1;
          }
        });
      }

      choices.push({
        text: "ä»»ç”±ç³¾ç´›ç™¼å±•",
        effect: () => {
          if (Math.random() < 0.4) {
            const occupiedRooms = getOccupiedRooms();
            const leavingRoom =
              occupiedRooms[Math.floor(Math.random() * occupiedRooms.length)];
            addLog(`${leavingRoom.tenant.name} å› ç‚ºè³‡æºç³¾ç´›è€Œæ¬èµ°äº†`, "danger");
            leavingRoom.tenant = null;
          } else {
            addLog("ç³¾ç´›æŒçºŒï¼Œç§Ÿå®¢å€‘å¿ƒæƒ…ä½è½", "danger");
            Object.keys(gameState.tenantSatisfaction).forEach((name) => {
              gameState.tenantSatisfaction[name] -= 12;
            });
          }
        }
      });

      return choices;
    }
  },

  {
    title: "å™ªéŸ³æŠ•è¨´",
    description: "æœ‰ç§Ÿå®¢å› ç‚ºé„°å±…çš„å™ªéŸ³è€Œç„¡æ³•ä¼‘æ¯ï¼Œé›™æ–¹ç™¼ç”Ÿçˆ­åŸ·",
    trigger: () => getOccupiedRooms().length >= 2,
    getChoices: () => {
      const elders = getElderTenants();
      const workers = getWorkerTenants();
      const choices = [];

      if (workers.length > 0) {
        choices.push({
          text: `è«‹ ${workers[0].name} å®‰è£éš”éŸ³è¨­æ–½ (-2å»ºæ)`,
          condition: () => gameState.resources.materials >= 2,
          effect: () => {
            const worker = workers[0];
            gameState.resources.materials -= 2;

            const tenants = gameState.rooms
              .filter((r) => r.tenant)
              .map((r) => r.tenant);
            let totalWage = 0;

            tenants.forEach((tenant) => {
              if (tenant !== worker && tenant.personalResources.cash >= 3) {
                const wage = 3;
                tenant.personalResources.cash -= wage;
                totalWage += wage;
              }
            });

            worker.personalResources.cash += totalWage;

            addLog(`å·¥äºº ${worker.name} å®‰è£äº†éš”éŸ³è¨­æ–½`, "skill");
            addLog(`${worker.name} ç²å¾— $${totalWage} å·¥è³‡`, "rent");
            addLog("å™ªéŸ³å•é¡Œå¾¹åº•è§£æ±º", "event");
          }
        });
      }

      if (elders.length > 0) {
        choices.push({
          text: `è«‹ ${elders[0].name} èª¿è§£å™ªéŸ³ç³¾ç´›`,
          effect: () => {
            const elder = elders[0];
            const tenants = gameState.rooms
              .filter((r) => r.tenant)
              .map((r) => r.tenant);
            let totalThanksFee = 0;

            tenants.forEach((tenant) => {
              if (tenant !== elder && tenant.personalResources.cash >= 2) {
                const thanksFee = Math.floor(Math.random() * 2) + 2;
                tenant.personalResources.cash -= thanksFee;
                totalThanksFee += thanksFee;
              }
            });

            elder.personalResources.cash += totalThanksFee;

            addLog(`é•·è€… ${elder.name} è€å¿ƒèª¿è§£ï¼Œé›™æ–¹é”æˆä½œæ¯å…±è­˜`, "skill");
            addLog(`${elder.name} ç²å¾— $${totalThanksFee} èª¿è§£æ„Ÿè¬è²»`, "rent");

            gameState.tenantRelationships.forEach((rel) => {
              rel.relationship = Math.min(100, rel.relationship + 12);
            });
            gameState.harmoniumBonus += 1;
          }
        });
      }

      choices.push({
        text: "æ”¯æŒæŠ•è¨´æ–¹ (-2é£Ÿç‰©å®‰æ’«)",
        condition: () => gameState.resources.food >= 2,
        effect: () => {
          gameState.resources.food -= 2;
          addLog("æ”¯ä»˜é£Ÿç‰©å®‰æ’«æŠ•è¨´æ–¹ï¼Œæš«æ™‚å¹³æ¯ç³¾ç´›", "event");
        }
      });

      return choices;
    }
  },

  {
    title: "å·¥ä½œåˆ†é…çˆ­è­°",
    description: "ç§Ÿå®¢å€‘å°èª°æ‡‰è©²è² è²¬å“ªäº›æ—¥å¸¸å·¥ä½œç”¢ç”Ÿåˆ†æ­§",
    trigger: () => {
      const occupiedCount = getOccupiedRooms().length;
      return occupiedCount >= 3;
    },
    getChoices: () => {
      const elders = getElderTenants();
      const workers = getWorkerTenants();
      const choices = [];

      if (workers.length > 0) {
        choices.push({
          text: `å§”è¨— ${workers[0].name} çµ±ä¸€å®‰æ’å·¥ä½œ`,
          effect: () => {
            const worker = workers[0];
            const tenants = gameState.rooms
              .filter((r) => r.tenant)
              .map((r) => r.tenant);
            let totalManagementFee = 0;

            tenants.forEach((tenant) => {
              if (tenant !== worker && tenant.personalResources.cash >= 4) {
                const managementFee = 4;
                tenant.personalResources.cash -= managementFee;
                totalManagementFee += managementFee;
              }
            });

            worker.personalResources.cash += totalManagementFee;

            addLog(`å·¥äºº ${worker.name} åˆç†å®‰æ’äº†å·¥ä½œåˆ†é…`, "skill");
            addLog(`${worker.name} ç²å¾— $${totalManagementFee} ç®¡ç†è²»`, "rent");
          }
        });
      }

      if (elders.length > 0) {
        choices.push({
          text: `è«‹ ${elders[0].name} å”èª¿å·¥ä½œå®‰æ’`,
          effect: () => {
            const elder = elders[0];
            const tenants = gameState.rooms
              .filter((r) => r.tenant)
              .map((r) => r.tenant);
            let totalCoordinationFee = 0;

            tenants.forEach((tenant) => {
              if (tenant !== elder && tenant.personalResources.cash >= 5) {
                const coordinationFee = Math.floor(Math.random() * 3) + 4;
                tenant.personalResources.cash -= coordinationFee;
                totalCoordinationFee += coordinationFee;
              }
            });

            elder.personalResources.cash += totalCoordinationFee;

            addLog(`é•·è€… ${elder.name} æ ¹æ“šå„è‡ªèƒ½åŠ›å…¬å¹³åˆ†é…äº†å·¥ä½œ`, "skill");
            addLog(
              `${elder.name} ç²å¾— $${totalCoordinationFee} å”èª¿è²»`,
              "rent"
            );

            Object.keys(gameState.tenantSatisfaction).forEach((name) => {
              gameState.tenantSatisfaction[name] += 10;
            });
            gameState.harmoniumBonus += 2;
          }
        });
      }

      choices.push({
        text: "æˆ¿æ±ç›´æ¥åˆ†é… (-$10åˆ¶ä½œå·¥ä½œè¡¨)",
        condition: () => gameState.resources.cash >= 10,
        effect: () => {
          gameState.resources.cash -= 10;
          addLog("åˆ¶ä½œè©³ç´°å·¥ä½œåˆ†é…è¡¨ï¼Œå¼·åˆ¶åŸ·è¡Œ", "event");

          Object.keys(gameState.tenantSatisfaction).forEach((name) => {
            gameState.tenantSatisfaction[name] -= 5;
          });
        }
      });

      return choices;
    }
  }
];

// åŸæœ‰äº‹ä»¶ç³»çµ±ï¼ˆç•¥å¾®èª¿æ•´ï¼‰
const events = [
  {
    title: "æ®­å±è¥²æ“Š",
    description: "ä¸€ç¾¤æ®­å±æ­£åœ¨é è¿‘æˆ¿å±‹ï¼",
    trigger: () => true,
    choices: [
      {
        text: "åŠ å›ºé˜²ç¦¦ (-5å»ºæ)",
        condition: () => gameState.resources.materials >= 5,
        effect: () => {
          gameState.resources.materials -= 5;
          const soldiers = getSoldierTenants();
          if (soldiers.length > 0) {
            addLog("è»äººç§Ÿå®¢å”åŠ©é˜²ç¦¦ï¼Œæ•ˆæœæ›´ä½³ï¼", "skill");
            gameState.buildingDefense += 2;
          }
          addLog("æˆåŠŸæŠµç¦¦è¥²æ“Š", "event");
        }
      },
      {
        text: "å†’éšªåæ“Š",
        effect: () => {
          const soldiers = getSoldierTenants();
          const successRate = soldiers.length > 0 ? 0.8 : 0.6;

          if (Math.random() < successRate) {
            addLog(
              soldiers.length > 0
                ? "è»äººç§Ÿå®¢å¸¶é ˜æˆåŠŸæ“Šé€€æ®­å±ï¼"
                : "æˆåŠŸæ“Šé€€æ®­å±ï¼",
              "event"
            );
          } else {
            addLog("åæ“Šå¤±æ•—ï¼Œæˆ¿å±‹å—æ", "danger");
            gameState.rooms[Math.floor(Math.random() * 2)].needsRepair = true;
          }
        }
      }
    ]
  },
  {
    title: "å•†éšŠéè·¯",
    description: "ä¸€å€‹å•†éšŠç¶“éé™„è¿‘ï¼Œä»–å€‘é¡˜æ„é€²è¡Œç‰©è³‡äº¤æ˜“",
    trigger: () =>
      gameState.resources.fuel >= 2 || gameState.resources.cash >= 20,
    choices: [
      {
        text: "ç”¨ç‡ƒæ–™æ›é£Ÿç‰© (-3ç‡ƒæ–™, +10é£Ÿç‰©)",
        condition: () => gameState.resources.fuel >= 3,
        effect: () => {
          gameState.resources.fuel -= 3;
          gameState.resources.food += 10;
          addLog("èˆ‡å•†éšŠäº¤æ˜“ï¼šç‡ƒæ–™æ›é£Ÿç‰©", "rent");
        }
      },
      {
        text: "ç”¨ç¾é‡‘è²·é†«ç™‚ç”¨å“ (-$15, +4é†«ç™‚)",
        condition: () => gameState.resources.cash >= 15,
        effect: () => {
          gameState.resources.cash -= 15;
          gameState.resources.medical += 4;
          addLog("èˆ‡å•†éšŠäº¤æ˜“ï¼šç¾é‡‘æ›é†«ç™‚ç”¨å“", "rent");
        }
      },
      {
        text: "å‡ºå”®å»ºææ›ç¾é‡‘ (-6å»ºæ, +$20)",
        condition: () => gameState.resources.materials >= 6,
        effect: () => {
          gameState.resources.materials -= 6;
          gameState.resources.cash += 20;
          addLog("èˆ‡å•†éšŠäº¤æ˜“ï¼šå»ºææ›ç¾é‡‘", "rent");
        }
      },
      {
        text: "æ‹’çµ•äº¤æ˜“",
        effect: () => {
          addLog("æ‹’çµ•äº†å•†éšŠçš„äº¤æ˜“æè­°", "event");
        }
      }
    ]
  }
];

// å·¥å…·å‡½æ•¸
function getDefenseStatusText(defense) {
  if (defense <= 0) return `è„†å¼±(${defense})`;
  if (defense <= 2) return `åŸºæœ¬(${defense})`;
  if (defense <= 5) return `ç©©å›º(${defense})`;
  if (defense <= 8) return `å …å›º(${defense})`;
  if (defense <= 12) return `è¦å¡(${defense})`;
  return `éŠ…ç‰†éµå£(${defense})`;
}

function getHungerStatusText(hunger) {
  if (hunger <= 0) return `é£½è¶³(${hunger})`;
  if (hunger <= 1) return `å¾®é¤“(${hunger})`;
  if (hunger <= 2) return `æœ‰é»é¤“(${hunger})`;
  if (hunger <= 3) return `é£¢é¤“(${hunger})`;
  if (hunger <= 4) return `å¾ˆé¤“(${hunger})`;
  if (hunger <= 6) return `æ¥µåº¦é£¢é¤“(${hunger})`;
  return `ç€•è‡¨é¤“æ­»(${hunger})`;
}

function getDoctorTenants() {
  return gameState.rooms
    .filter(
      (room) =>
        room.tenant && room.tenant.type === "doctor" && !room.tenant.infected
    )
    .map((room) => room.tenant);
}

function getWorkerTenants() {
  return gameState.rooms
    .filter(
      (room) =>
        room.tenant && room.tenant.type === "worker" && !room.tenant.infected
    )
    .map((room) => room.tenant);
}

function getSoldierTenants() {
  return gameState.rooms
    .filter(
      (room) =>
        room.tenant && room.tenant.type === "soldier" && !room.tenant.infected
    )
    .map((room) => room.tenant);
}

function getFarmerTenants() {
  return gameState.rooms
    .filter(
      (room) =>
        room.tenant && room.tenant.type === "farmer" && !room.tenant.infected
    )
    .map((room) => room.tenant);
}

function getElderTenants() {
  return gameState.rooms
    .filter(
      (room) =>
        room.tenant && room.tenant.type === "elder" && !room.tenant.infected
    )
    .map((room) => room.tenant);
}

function getHealthyTenants() {
  return gameState.rooms
    .filter((room) => room.tenant && !room.tenant.infected)
    .map((room) => room.tenant);
}

function getInfectedTenants() {
  return gameState.rooms
    .filter((room) => room.tenant && room.tenant.infected)
    .map((room) => room.tenant);
}

function getOccupiedRooms() {
  return gameState.rooms.filter((room) => room.tenant);
}

// æ–°å¢ï¼šç§Ÿå®¢æ»¿æ„åº¦æ›´æ–°
function updateTenantSatisfaction() {
  gameState.rooms.forEach((room) => {
    if (room.tenant) {
      const tenant = room.tenant;
      let satisfaction = gameState.tenantSatisfaction[tenant.name] || 50;

      // åŸºç¤ç”Ÿæ´»æ¢ä»¶å½±éŸ¿
      if (room.reinforced) satisfaction += 3;
      if (room.needsRepair) satisfaction -= 8;
      if (tenant.personalResources.food < 2) satisfaction -= 10;
      if (tenant.personalResources.cash > 25) satisfaction += 5;
      if (gameState.buildingDefense >= 8) satisfaction += 4;
      if (gameState.buildingDefense <= 2) satisfaction -= 6;

      // å…¨å±€æ•ˆæœå½±éŸ¿
      if (gameState.emergencyTraining) satisfaction += 2;
      if (gameState.buildingQuality >= 1) satisfaction += 3;
      if (gameState.patrolSystem) satisfaction += 4;
      if (gameState.socialNetwork) satisfaction += 3;

      // è€äººå’Œè«§æ°›åœåŠ æˆ
      const elderCount = getElderTenants().length;
      satisfaction += elderCount * 2;

      satisfaction = Math.max(0, Math.min(100, satisfaction));
      gameState.tenantSatisfaction[tenant.name] = satisfaction;
    }
  });
}

// æ–°å¢ï¼šç³¾ç´›æ©Ÿç‡è¨ˆç®—
function calculateConflictChance() {
  const occupiedCount = getOccupiedRooms().length;
  if (occupiedCount < 2) return 0;

  let baseChance = 0.25;

  const avgSatisfaction =
    Object.values(gameState.tenantSatisfaction).reduce((a, b) => a + b, 0) /
    occupiedCount;
  baseChance -= (avgSatisfaction - 50) * 0.003;

  baseChance += (occupiedCount - 2) * 0.08;

  if (gameState.resources.food < occupiedCount * 3) baseChance += 0.1;
  if (gameState.resources.fuel < 3) baseChance += 0.05;

  const elderCount = getElderTenants().length;
  baseChance -= elderCount * 0.12;

  baseChance -= gameState.harmoniumBonus * 0.02;

  return Math.max(0.02, Math.min(0.6, baseChance));
}

function addLog(message, type = "") {
  const log = document.getElementById("gameLog");
  const entry = document.createElement("div");
  entry.className = `log-entry ${type}`;
  entry.textContent = `ç¬¬${gameState.day}å¤©: ${message}`;
  log.appendChild(entry);
  log.scrollTop = log.scrollHeight;
}

function updateDisplay() {
  document.getElementById("day").textContent = gameState.day;
  document.getElementById("time").textContent =
    gameState.time === "day" ? "ç™½å¤©" : "å¤œæ™š";
  document.getElementById("cash").textContent = gameState.resources.cash;
  document.getElementById(
    "buildingDefenseText"
  ).textContent = getDefenseStatusText(gameState.buildingDefense);
  document.getElementById(
    "landlordHungerText"
  ).textContent = getHungerStatusText(gameState.landlordHunger);
  document.getElementById("scavengeCount").textContent = gameState.scavengeUsed;

  Object.keys(gameState.resources).forEach((resource) => {
    document.getElementById(resource).textContent =
      gameState.resources[resource];
  });

  gameState.rooms.forEach((room) => {
    const roomElement = document.getElementById(`room${room.id}`);
    const infoElement = document.getElementById(`room${room.id}-info`);

    roomElement.className = "room";

    if (room.tenant) {
      roomElement.classList.add("occupied");
      if (room.tenant.infected) {
        roomElement.classList.add("infected");
      }

      // é¡¯ç¤ºæ»¿æ„åº¦
      const satisfaction = gameState.tenantSatisfaction[room.tenant.name] || 50;
      const satisfactionText =
        satisfaction >= 70 ? "ğŸ˜Š" : satisfaction >= 40 ? "ğŸ˜" : "ğŸ˜";

      infoElement.innerHTML = `${room.tenant.name}<br><small>${room.tenant.skill}</small><br><small>æ»¿æ„åº¦: ${satisfaction} ${satisfactionText}</small>`;
    } else {
      infoElement.textContent = "ç©ºæˆ¿";
    }

    if (room.needsRepair) {
      roomElement.classList.add("needs-repair");
      infoElement.innerHTML +=
        '<br><small style="color:#ff6666">éœ€è¦ç¶­ä¿®</small>';
    }

    if (room.reinforced) {
      roomElement.classList.add("reinforced");
      infoElement.innerHTML +=
        '<br><small style="color:#66ccff">å·²åŠ å›º</small>';
    }
  });

  updateStatusColors();
  updateTenantList();
  updateScavengeButton();
  updateRentButton();
  updateSkillButton();
  updateTenantSatisfaction();
}

function updateStatusColors() {
  const defenseElement = document.getElementById("buildingDefenseText");
  const hungerElement = document.getElementById("landlordHungerText");

  defenseElement.className = "";
  if (gameState.buildingDefense <= 0) {
    defenseElement.classList.add("danger-status");
  } else if (gameState.buildingDefense >= 8) {
    defenseElement.classList.add("good-status");
  }

  hungerElement.className = "";
  if (gameState.landlordHunger >= 5) {
    hungerElement.classList.add("danger-status");
  } else if (gameState.landlordHunger <= 0) {
    hungerElement.classList.add("good-status");
  }
}

function updateTenantList() {
  const tenantList = document.getElementById("tenantList");
  const tenants = gameState.rooms
    .filter((room) => room.tenant)
    .map((room) => room.tenant);

  if (tenants.length === 0) {
    tenantList.innerHTML = '<div class="tenant-item">æš«ç„¡ç§Ÿå®¢</div>';
  } else {
    tenantList.innerHTML = tenants
      .map((tenant) => {
        let statusText = "";
        if (tenant.infected) {
          statusText = '<br><small style="color:#ff6666">å·²æ„ŸæŸ“ï¼</small>';
        } else if (tenant.onMission) {
          statusText = '<br><small style="color:#ffaa66">åŸ·è¡Œä»»å‹™ä¸­</small>';
        }

        const resourceStatus = tenant.personalResources
          ? `<br><small style="color:#cccccc">å€‹äºº: $${
              tenant.personalResources.cash || 0
            } é£Ÿç‰©${tenant.personalResources.food || 0}</small>`
          : "";

        const satisfaction = gameState.tenantSatisfaction[tenant.name] || 50;
        const satisfactionBar = `<div class="satisfaction-bar"><div class="satisfaction-fill" style="width: ${satisfaction}%"></div></div>`;

        return `<div class="tenant-item ${tenant.infected ? "infected" : ""} ${
          tenant.type
        }">
                                    ${tenant.name} (${tenant.type})<br>
                                    <small>æˆ¿ç§Ÿ: ${tenant.rent} | ${
          tenant.skill
        }</small>
                                    ${resourceStatus}
                                    <small>æ»¿æ„åº¦: ${satisfaction}%</small>
                                    ${satisfactionBar}
                                    ${statusText}
                                </div>`;
      })
      .join("");
  }
}

// å¢å¼·çš„æŠ€èƒ½ç³»çµ±
function getSkillsForTenant(tenant) {
  const skills = [];

  switch (tenant.type) {
    case "doctor":
      // ä¸»å‹•æŠ€èƒ½1ï¼šæ²»ç™‚æ„ŸæŸ“
      const infectedCount = getInfectedTenants().length;
      if (
        infectedCount > 0 &&
        gameState.resources.medical >= 3 &&
        gameState.resources.cash >= 12
      ) {
        skills.push({
          name: "æ²»ç™‚æ„ŸæŸ“",
          description: `æ²»ç™‚æ„ŸæŸ“çš„ç§Ÿå®¢ï¼ˆæ¶ˆè€—ï¼š3é†«ç™‚ç”¨å“ + $12é…¬å‹ï¼‰`,
          action: "healInfection",
          cost: { medical: 3, cash: 12 }
        });
      }

      // ä¸»å‹•æŠ€èƒ½2ï¼šå¥åº·æª¢æŸ¥
      if (gameState.resources.medical >= 1 && gameState.resources.cash >= 8) {
        skills.push({
          name: "å…¨é¢å¥åº·æª¢æŸ¥",
          description: `æª¢æŸ¥æ‰€æœ‰äººçš„å¥åº·ç‹€æ³ï¼ˆæ¶ˆè€—ï¼š1é†«ç™‚ç”¨å“ + $8é…¬å‹ï¼‰`,
          action: "healthCheck",
          cost: { medical: 1, cash: 8 }
        });
      }

      // ç‰¹æ®ŠæŠ€èƒ½ï¼šæ€¥æ•‘åŸ¹è¨“
      if (!tenant.emergencyTrainingUsed && gameState.resources.cash >= 15) {
        skills.push({
          name: "æ€¥æ•‘åŸ¹è¨“",
          description: `åŸ¹è¨“æ‰€æœ‰ç§Ÿå®¢æ€¥æ•‘çŸ¥è­˜ï¼Œæ°¸ä¹…é™ä½å—å‚·é¢¨éšªï¼ˆ$15ï¼Œé™ç”¨1æ¬¡ï¼‰`,
          action: "emergencyTraining",
          cost: { cash: 15 }
        });
      }
      break;

    case "worker":
      // ä¸»å‹•æŠ€èƒ½1ï¼šé«˜æ•ˆç¶­ä¿®
      const repairRooms = gameState.rooms.filter((r) => r.needsRepair);
      if (repairRooms.length > 0 && gameState.resources.cash >= 10) {
        skills.push({
          name: "å°ˆæ¥­ç¶­ä¿®",
          description: `ä»¥æ›´å°‘å»ºæç¶­ä¿®æˆ¿é–“ï¼ˆåªéœ€1å»ºæ + $10å·¥è³‡ï¼‰`,
          action: "efficientRepair",
          cost: { cash: 10 }
        });
      }

      // ä¸»å‹•æŠ€èƒ½2ï¼šæˆ¿é–“å‡ç´š
      const unReinforcedRooms = gameState.rooms.filter(
        (r) => r.tenant && !r.reinforced
      );
      if (
        unReinforcedRooms.length > 0 &&
        gameState.resources.materials >= 4 &&
        gameState.resources.cash >= 18
      ) {
        skills.push({
          name: "æˆ¿é–“åŠ å›º",
          description: `åŠ å›ºæŒ‡å®šæˆ¿é–“ï¼Œæå‡ç§Ÿé‡‘å’Œå®‰å…¨æ€§ï¼ˆ4å»ºæ + $18å·¥è³‡ï¼‰`,
          action: "reinforceRoom",
          cost: { materials: 4, cash: 18 }
        });
      }

      // ç‰¹æ®ŠæŠ€èƒ½ï¼šå»ºç¯‰å‡ç´š
      if (
        !tenant.buildingUpgradeUsed &&
        gameState.resources.materials >= 8 &&
        gameState.resources.cash >= 25
      ) {
        skills.push({
          name: "æˆ¿å±‹å‡ç´š",
          description: `æ°¸ä¹…æå‡æˆ¿å±‹å“è³ªå’Œé˜²ç¦¦ï¼ˆ8å»ºæ + $25ï¼Œé™ç”¨1æ¬¡ï¼‰`,
          action: "buildingUpgrade",
          cost: { materials: 8, cash: 25 }
        });
      }
      break;

    case "farmer":
      // ä¸»å‹•æŠ€èƒ½1ï¼šç¨®æ¤ä½œç‰©
      if (
        !tenant.cropPlanted &&
        gameState.resources.food >= 3 &&
        gameState.resources.cash >= 8
      ) {
        skills.push({
          name: "ç¨®æ¤ä½œç‰©",
          description: `ç¨®æ¤ä½œç‰©ï¼Œ3å¤©å¾Œå¤§é‡æ”¶ç©«ï¼ˆæ¶ˆè€—ï¼š3é£Ÿç‰© + $8å·¥è³‡ï¼‰`,
          action: "plantCrops",
          cost: { food: 3, cash: 8 }
        });
      }

      // ä¸»å‹•æŠ€èƒ½2ï¼šé‡å¤–æ¡é›†
      if (!tenant.foragingUsed && gameState.resources.cash >= 6) {
        skills.push({
          name: "é‡å¤–æ¡é›†",
          description: `å¤–å‡ºå°‹æ‰¾é‡ç”Ÿé£Ÿç‰©ï¼ˆæ¯2å¤©1æ¬¡ï¼Œ$6å·¥è³‡ï¼‰`,
          action: "wildForaging",
          cost: { cash: 6 }
        });
      }

      // ç‰¹æ®ŠæŠ€èƒ½ï¼šé£Ÿç‰©ä¿å­˜æŠ€è¡“
      if (!tenant.preservationTechUsed && gameState.resources.cash >= 20) {
        skills.push({
          name: "é£Ÿç‰©ä¿å­˜æŠ€è¡“",
          description: `å‚³æˆä¿å­˜æŠ€è¡“ï¼Œæ°¸ä¹…æ¸›å°‘é£Ÿç‰©è…æ•—ï¼ˆ$20ï¼Œé™ç”¨1æ¬¡ï¼‰`,
          action: "foodPreservation",
          cost: { cash: 20 }
        });
      }
      break;

    case "soldier":
      // ä¸»å‹•æŠ€èƒ½1ï¼šå¤œé–“è­¦æˆ’
      if (gameState.resources.cash >= 15) {
        skills.push({
          name: "å¤œé–“è­¦æˆ’",
          description: `åŠ å¼·ä»Šæ™šé˜²ç¦¦ï¼Œé™ä½çªè¥²é¢¨éšªï¼ˆ$15å·¥è³‡ï¼‰`,
          action: "nightWatch",
          cost: { cash: 15 }
        });
      }

      // ä¸»å‹•æŠ€èƒ½2ï¼šé˜²ç¦¦å·¥äº‹
      if (
        gameState.resources.materials >= 5 &&
        gameState.resources.cash >= 22
      ) {
        skills.push({
          name: "å»ºé€ é˜²ç¦¦å·¥äº‹",
          description: `æ°¸ä¹…æå‡å»ºç¯‰é˜²ç¦¦åŠ›ï¼ˆ5å»ºæ + $22å·¥è³‡ï¼‰`,
          action: "defensiveConstruction",
          cost: { materials: 5, cash: 22 }
        });
      }

      // ç‰¹æ®ŠæŠ€èƒ½ï¼šå®‰å…¨å·¡é‚ç³»çµ±
      if (!tenant.patrolSystemUsed && gameState.resources.cash >= 30) {
        skills.push({
          name: "å»ºç«‹å·¡é‚ç³»çµ±",
          description: `å»ºç«‹å®‰å…¨å·¡é‚åˆ¶åº¦ï¼Œæ°¸ä¹…é™ä½å¨è„…ï¼ˆ$30ï¼Œé™ç”¨1æ¬¡ï¼‰`,
          action: "patrolSystem",
          cost: { cash: 30 }
        });
      }
      break;

    case "elder":
      // ä¸»å‹•æŠ€èƒ½1ï¼šç³¾ç´›èª¿è§£
      const hasConflictPotential = getOccupiedRooms().length >= 2;
      if (hasConflictPotential && gameState.resources.cash >= 12) {
        skills.push({
          name: "ç³¾ç´›èª¿è§£",
          description: `ä¸»å‹•è§£æ±ºç§Ÿå®¢é–“çš„çŸ›ç›¾ï¼Œç²å¾—æ„Ÿè¬è²»ï¼ˆ$12æœå‹™è²»ï¼‰`,
          action: "conflictMediation",
          cost: { cash: 12 }
        });
      }

      // ä¸»å‹•æŠ€èƒ½2ï¼šç”Ÿæ´»æŒ‡å°
      if (!tenant.lifeGuidanceUsed && gameState.resources.cash >= 10) {
        skills.push({
          name: "ç”Ÿæ´»æŒ‡å°",
          description: `å‚³æˆç”Ÿæ´»æ™ºæ…§ï¼Œæå‡æ‰€æœ‰ç§Ÿå®¢æ»¿æ„åº¦ï¼ˆæ¯2å¤©1æ¬¡ï¼Œ$10è«®è©¢è²»ï¼‰`,
          action: "lifeGuidance",
          cost: { cash: 10 }
        });
      }

      // ç‰¹æ®ŠæŠ€èƒ½ï¼šäººéš›ç¶²çµ¡
      if (!tenant.networkEstablished && gameState.resources.cash >= 25) {
        skills.push({
          name: "å»ºç«‹äººéš›ç¶²çµ¡",
          description: `å»ºç«‹å¤–éƒ¨è¯ç¹«ï¼Œå¢åŠ å•†äººå’Œè¨ªå®¢å“è³ªï¼ˆ$25ï¼Œé™ç”¨1æ¬¡ï¼‰`,
          action: "establishNetwork",
          cost: { cash: 25 }
        });
      }
      break;
  }

  return skills;
}

function canAffordSkill(cost) {
  return Object.keys(cost).every((resource) => {
    if (resource === "cash") {
      return gameState.resources.cash >= cost[resource];
    } else {
      return (gameState.resources[resource] || 0) >= cost[resource];
    }
  });
}

function paySkillCost(cost) {
  let totalPayment = 0;
  Object.keys(cost).forEach((resource) => {
    if (resource === "cash") {
      gameState.resources.cash -= cost[resource];
      totalPayment += cost[resource];
    } else {
      gameState.resources[resource] -= cost[resource];
    }
  });
  return totalPayment;
}

function ensurePersonalResources(tenant) {
  if (!tenant.personalResources) {
    tenant.personalResources = {
      food: 0,
      materials: 0,
      medical: 0,
      fuel: 0,
      cash: 0
    };
  }
}

function useSkill(tenantName, skillAction) {
  const tenant = gameState.rooms
    .filter((room) => room.tenant && room.tenant.name === tenantName)
    .map((room) => room.tenant)[0];

  if (!tenant) return;

  const skill = getSkillsForTenant(tenant).find(
    (s) => s.action === skillAction
  );
  if (!skill || !canAffordSkill(skill.cost)) {
    addLog(`è³‡æºä¸è¶³ï¼Œç„¡æ³•è«‹ ${tenant.name} åŸ·è¡ŒæŠ€èƒ½`, "danger");
    return;
  }

  const payment = paySkillCost(skill.cost);
  if (payment > 0) {
    ensurePersonalResources(tenant);
    tenant.personalResources.cash += payment;
    addLog(`ğŸ’° æ”¯ä»˜ ${tenant.name} å·¥è³‡ $${payment}`, "rent");
  }

  // åŸ·è¡ŒæŠ€èƒ½æ•ˆæœ
  switch (skillAction) {
    // é†«ç”ŸæŠ€èƒ½
    case "healInfection":
      const infected = getInfectedTenants();
      if (infected.length > 0) {
        const patient = infected[Math.floor(Math.random() * infected.length)];
        patient.infected = false;
        addLog(`é†«ç”Ÿ ${tenant.name} æˆåŠŸæ²»ç™’äº† ${patient.name}ï¼`, "skill");
      }
      break;

    case "healthCheck":
      let foundIssues = false;
      if (gameState.visitors.length > 0) {
        gameState.visitors.forEach((visitor) => {
          if (visitor.infected && !visitor.revealedInfection) {
            visitor.revealedInfection = true;
            addLog(`é†«ç”Ÿæª¢æ¸¬ç™¼ç¾è¨ªå®¢ ${visitor.name} å·²è¢«æ„ŸæŸ“ï¼`, "danger");
            foundIssues = true;
          }
        });
      }
      getHealthyTenants().forEach((t) => {
        if (Math.random() < 0.12) {
          t.infected = true;
          addLog(`é†«ç”Ÿæª¢æŸ¥ç™¼ç¾ ${t.name} å‡ºç¾æ—©æœŸæ„ŸæŸ“ç—‡ç‹€ï¼`, "danger");
          foundIssues = true;
        }
      });
      if (!foundIssues) {
        addLog(`é†«ç”Ÿ ${tenant.name} å®Œæˆå¥åº·æª¢æŸ¥ï¼Œæ‰€æœ‰äººå¥åº·ç‹€æ³è‰¯å¥½`, "skill");
      }
      break;

    case "emergencyTraining":
      tenant.emergencyTrainingUsed = true;
      gameState.emergencyTraining = true;
      addLog(`é†«ç”Ÿ ${tenant.name} åŸ¹è¨“äº†æ‰€æœ‰äººçš„æ€¥æ•‘çŸ¥è­˜`, "skill");
      break;

    // å·¥äººæŠ€èƒ½
    case "efficientRepair":
      const repairRoom = gameState.rooms.find((r) => r.needsRepair);
      if (repairRoom) {
        if (gameState.resources.materials >= 1) {
          gameState.resources.materials -= 1;
          repairRoom.needsRepair = false;
          addLog(
            `å·¥äºº ${tenant.name} å°ˆæ¥­ç¶­ä¿®äº†æˆ¿é–“ ${repairRoom.id}`,
            "skill"
          );
        }
      }
      break;

    case "reinforceRoom":
      const targetRoom = gameState.rooms.find((r) => r.tenant === tenant);
      if (targetRoom) {
        targetRoom.reinforced = true;
        gameState.buildingDefense += 1;
        addLog(`å·¥äºº ${tenant.name} åŠ å›ºäº†æˆ¿é–“ ${targetRoom.id}`, "skill");
      }
      break;

    case "buildingUpgrade":
      tenant.buildingUpgradeUsed = true;
      gameState.buildingDefense += 3;
      gameState.buildingQuality = (gameState.buildingQuality || 0) + 1;
      addLog(`å·¥äºº ${tenant.name} å‡ç´šäº†æ•´é«”æˆ¿å±‹å“è³ª`, "skill");
      break;

    // è¾²å¤«æŠ€èƒ½
    case "plantCrops":
      tenant.cropPlanted = gameState.day + 3;
      addLog(`è¾²å¤« ${tenant.name} ç¨®æ¤äº†ä½œç‰©ï¼Œ3å¤©å¾Œå¯æ”¶ç©«`, "skill");
      break;

    case "wildForaging":
      const foragingResult = Math.floor(Math.random() * 6) + 4;
      gameState.resources.food += foragingResult;
      tenant.foragingUsed = true;
      tenant.foragingCooldown = gameState.day + 2;
      addLog(
        `è¾²å¤« ${tenant.name} é‡å¤–æ¡é›†ç²å¾—äº† ${foragingResult} é£Ÿç‰©`,
        "skill"
      );
      break;

    case "foodPreservation":
      tenant.preservationTechUsed = true;
      gameState.foodPreservation = true;
      addLog(`è¾²å¤« ${tenant.name} å‚³æˆäº†é£Ÿç‰©ä¿å­˜æŠ€è¡“`, "skill");
      break;

    // è»äººæŠ€èƒ½
    case "nightWatch":
      gameState.nightWatchActive = true;
      gameState.buildingDefense += 4;
      addLog(`è»äºº ${tenant.name} é–‹å§‹å¤œé–“è­¦æˆ’`, "skill");
      break;

    case "defensiveConstruction":
      gameState.buildingDefense += 2;
      addLog(`è»äºº ${tenant.name} å»ºé€ äº†é˜²ç¦¦å·¥äº‹`, "skill");
      break;

    case "patrolSystem":
      tenant.patrolSystemUsed = true;
      gameState.patrolSystem = true;
      addLog(`è»äºº ${tenant.name} å»ºç«‹äº†å®‰å…¨å·¡é‚ç³»çµ±`, "skill");
      break;

    // è€äººæŠ€èƒ½
    case "conflictMediation":
      const elder = tenant;
      const otherTenants = gameState.rooms
        .filter((r) => r.tenant && r.tenant !== elder)
        .map((r) => r.tenant);

      if (otherTenants.length === 0) {
        addLog(`æ²’æœ‰å…¶ä»–ç§Ÿå®¢éœ€è¦èª¿è§£`, "event");
        break;
      }

      let totalThanksFee = 0;
      let participatingTenants = [];

      otherTenants.forEach((t) => {
        if (t.personalResources.cash >= 6) {
          const thanksFee = Math.floor(Math.random() * 4) + 4;
          const actualFee = Math.min(thanksFee, t.personalResources.cash - 3);

          if (actualFee > 0) {
            t.personalResources.cash -= actualFee;
            totalThanksFee += actualFee;
            participatingTenants.push(`${t.name}($${actualFee})`);
          }
        }
      });

      elder.personalResources.cash += totalThanksFee;

      if (gameState.tenantRelationships) {
        gameState.tenantRelationships.forEach((rel) => {
          rel.relationship = Math.min(100, rel.relationship + 15);
        });
      }

      Object.keys(gameState.tenantSatisfaction || {}).forEach((name) => {
        gameState.tenantSatisfaction[name] = Math.min(
          100,
          (gameState.tenantSatisfaction[name] || 50) + 12
        );
      });

      addLog(`é•·è€… ${elder.name} æˆåŠŸèª¿è§£äº†æ½›åœ¨ç³¾ç´›`, "skill");
      if (totalThanksFee > 0) {
        addLog(
          `æ„Ÿè¬çš„ç§Ÿå®¢ ${participatingTenants.join(
            ", "
          )} å…±æ”¯ä»˜äº† $${totalThanksFee} æ„Ÿè¬è²»`,
          "rent"
        );
      }
      gameState.harmoniumBonus += 1;
      break;

    case "lifeGuidance":
      tenant.lifeGuidanceUsed = true;
      tenant.guidanceCooldown = gameState.day + 2;

      const guidedTenants = gameState.rooms
        .filter((r) => r.tenant && r.tenant !== tenant)
        .map((r) => r.tenant);

      if (guidedTenants.length === 0) {
        addLog(`æ²’æœ‰å…¶ä»–ç§Ÿå®¢éœ€è¦ç”Ÿæ´»æŒ‡å°`, "event");
        break;
      }

      guidedTenants.forEach((t) => {
        gameState.tenantSatisfaction = gameState.tenantSatisfaction || {};
        gameState.tenantSatisfaction[t.name] = Math.min(
          100,
          (gameState.tenantSatisfaction[t.name] || 50) + 15
        );
      });

      let totalTips = 0;
      let tippingTenants = [];

      guidedTenants.forEach((t) => {
        if (t.personalResources.cash >= 4 && Math.random() < 0.7) {
          const tip = Math.floor(Math.random() * 3) + 2;
          const actualTip = Math.min(tip, t.personalResources.cash - 2);

          if (actualTip > 0) {
            t.personalResources.cash -= actualTip;
            totalTips += actualTip;
            tippingTenants.push(t.name);
          }
        }
      });

      tenant.personalResources.cash += totalTips;

      addLog(`é•·è€… ${tenant.name} çš„ç”Ÿæ´»æŒ‡å°è®“æ‰€æœ‰ç§Ÿå®¢æ›´æ»¿æ„`, "skill");
      if (totalTips > 0) {
        addLog(
          `${tippingTenants.join(", ")} çµ¦äº† ${
            tenant.name
          } ç¸½è¨ˆ $${totalTips} å°è²»`,
          "rent"
        );
      }
      gameState.harmoniumBonus += 1;
      break;

    case "establishNetwork":
      tenant.networkEstablished = true;
      gameState.socialNetwork = true;
      addLog(`é•·è€… ${tenant.name} å»ºç«‹äº†å¯¶è²´çš„äººéš›ç¶²çµ¡`, "skill");
      break;
  }

  closeModal();
  updateDisplay();
}

function showSkillMenu() {
  const modal = document.getElementById("skillModal");
  const skillList = document.getElementById("skillList");

  const skillsByTenant = [];

  gameState.rooms.forEach((room) => {
    if (room.tenant && !room.tenant.infected) {
      const tenant = room.tenant;
      const tenantSkills = getSkillsForTenant(tenant);

      if (tenantSkills.length > 0) {
        skillsByTenant.push({
          tenant: tenant,
          skills: tenantSkills
        });
      }
    }
  });

  if (skillsByTenant.length === 0) {
    skillList.innerHTML = "<p>ç›®å‰æ²’æœ‰å¯ç”¨çš„æŠ€èƒ½</p>";
  } else {
    skillList.innerHTML = skillsByTenant
      .map((tenantData) => {
        const tenant = tenantData.tenant;
        const skills = tenantData.skills;

        return `
                        <div class="tenant-skill-group">
                          <h4 style="color: #66ccff; margin: 15px 0 10px 0;">
                            ${tenant.name} (${
          tenant.type
        }) - æˆ¿é–“${getRoomIdByTenant(tenant)}
                          </h4>
                          <div style="font-size: 11px; color: #aaa; margin-bottom: 10px;">
                            å€‹äººç¾é‡‘: $${tenant.personalResources?.cash || 0}
                          </div>
                          ${skills
                            .map(
                              (skill) => `
                            <div class="skill-actions">
                              <h5 style="margin: 5px 0; color: #ffcc66;">${skill.name}</h5>
                              <p style="margin: 5px 0; font-size: 12px;">${skill.description}</p>
                              <button class="btn success" onclick="useSkill('${tenant.name}', '${skill.action}')">
                                ä½¿ç”¨æŠ€èƒ½
                              </button>
                            </div>
                          `
                            )
                            .join("")}
                        </div>
                      `;
      })
      .join("");
  }

  modal.style.display = "block";
}

function updateSkillButton() {
  const skillBtn = document.querySelector('button[onclick="showSkillMenu()"]');
  const availableSkills = getAvailableSkills();

  if (availableSkills.length > 0) {
    skillBtn.disabled = false;
    skillBtn.textContent = `ä½¿ç”¨æŠ€èƒ½ (${availableSkills.length})`;
  } else {
    skillBtn.disabled = true;
    skillBtn.textContent = "ä½¿ç”¨æŠ€èƒ½ (ç„¡å¯ç”¨)";
  }
}

function getAvailableSkills() {
  const skills = [];
  gameState.rooms.forEach((room) => {
    if (room.tenant && !room.tenant.infected) {
      const tenant = room.tenant;
      const skillsForType = getSkillsForTenant(tenant);
      skillsForType.forEach((skill) => skills.push({ tenant, ...skill }));
    }
  });
  return skills;
}

function getRoomIdByTenant(tenant) {
  const room = gameState.rooms.find((r) => r.tenant === tenant);
  return room ? room.id : "æœªçŸ¥";
}

function selectRoom(roomId) {
  const room = gameState.rooms.find((r) => r.id === roomId);
  const modal = document.getElementById("tenantModal");
  const title = document.getElementById("tenantModalTitle");
  const content = document.getElementById("tenantModalContent");
  const actions = document.getElementById("tenantModalActions");

  content.innerHTML = "";
  actions.innerHTML = "";

  if (room.needsRepair) {
    const workers = getWorkerTenants();
    const repairCost = workers.length > 0 ? 2 : 3;

    if (gameState.resources.materials >= repairCost) {
      title.textContent = `æˆ¿é–“ ${roomId} - éœ€è¦ç¶­ä¿®`;
      content.innerHTML = `
                        <p>æ­¤æˆ¿é–“éœ€è¦ç¶­ä¿®ï¼ŒèŠ±è²» ${repairCost} å–®ä½å»ºæã€‚</p>
                        ${
                          workers.length > 0
                            ? '<p style="color:#66ccff">æœ‰å·¥äººç§Ÿå®¢å¯ä»¥é™ä½ç¶­ä¿®æˆæœ¬ï¼</p>'
                            : ""
                        }
                    `;
      actions.innerHTML = `
                        <button class="btn" onclick="repairRoom(${roomId})">ç«‹å³ç¶­ä¿® (-${repairCost}å»ºæ)</button>
                        <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                    `;
    } else {
      alert("å»ºæä¸è¶³ï¼Œç„¡æ³•ç¶­ä¿®ï¼");
      return;
    }
  } else if (room.tenant) {
    const tenant = room.tenant;
    const satisfaction = gameState.tenantSatisfaction[tenant.name] || 50;

    title.textContent = `æˆ¿é–“ ${roomId} - ${tenant.name}`;
    content.innerHTML = `
                  <p><strong>å§“åï¼š</strong>${tenant.name}</p>
                  <p><strong>é¡å‹ï¼š</strong>${tenant.type}</p>
                  <p><strong>æŠ€èƒ½ï¼š</strong>${tenant.skill}</p>
                  <p><strong>æˆ¿ç§Ÿï¼š</strong>${tenant.rent} / å¤©</p>
                  <p><strong>æ»¿æ„åº¦ï¼š</strong>${satisfaction}% ${
      satisfaction >= 70 ? "ğŸ˜Š" : satisfaction >= 40 ? "ğŸ˜" : "ğŸ˜"
    }</p>
                  <p><strong>ç‹€æ…‹ï¼š</strong>${
                    tenant.onMission
                      ? "åŸ·è¡Œä»»å‹™ä¸­"
                      : tenant.infected
                      ? "å·²æ„ŸæŸ“"
                      : "å¥åº·"
                  }</p>
                  ${
                    tenant.personalResources
                      ? `
                    <p><strong>å€‹äººè³‡æºï¼š</strong></p>
                    <small>ğŸ’° ç¾é‡‘: ${
                      tenant.personalResources.cash || 0
                    }</small><br>
                    <small>ğŸ– é£Ÿç‰©: ${
                      tenant.personalResources.food || 0
                    }</small><br>
                    <small>ğŸ”§ å»ºæ: ${
                      tenant.personalResources.materials || 0
                    }</small><br>
                    <small>ğŸ’Š é†«ç™‚: ${
                      tenant.personalResources.medical || 0
                    }</small><br>
                    <small>â›½ ç‡ƒæ–™: ${
                      tenant.personalResources.fuel || 0
                    }</small>
                  `
                      : ""
                  }
                  ${
                    room.reinforced
                      ? `<p style="color:#66ccff;"><strong>æˆ¿é–“å·²åŠ å›º (+20%æˆ¿ç§Ÿ)</strong></p>`
                      : ""
                  }
                  ${
                    tenant.infected
                      ? `<p style="color:#ff6666;"><strong>âš  å·²æ„ŸæŸ“</strong></p>`
                      : ""
                  }
                `;

    if (tenant.infected) {
      const doctors = getDoctorTenants();
      const healButton =
        doctors.length > 0 && gameState.resources.medical >= 3
          ? `<button class="btn success" onclick="healTenantInRoom(${roomId})">é†«ç”Ÿæ²»ç™‚</button>`
          : "";

      actions.innerHTML = `
                        ${healButton}
                        <button class="btn danger" onclick="evictTenant(${roomId}, true)">é©…é€ï¼ˆæ„ŸæŸ“ï¼‰</button>
                        <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                    `;
    } else {
      actions.innerHTML = `
                        <button class="btn" onclick="closeModal()">é—œé–‰</button>
                        <button class="btn danger" onclick="evictTenant(${roomId}, false)">è¦æ±‚é€€ç§Ÿ</button>
                    `;
    }
  } else {
    title.textContent = `æˆ¿é–“ ${roomId} - ç©ºç½®ä¸­`;
    content.innerHTML = `
                  <p>æ­¤æˆ¿é–“ç›®å‰æ²’æœ‰ç§Ÿå®¢ã€‚</p>
                  <p>ä½ å¯ä»¥å‰å¾€æŸ¥çœ‹ç”³è«‹è€…ï¼Œé¸æ“‡åˆé©çš„ç§Ÿå®¢å…¥ä½ã€‚</p>
                  ${
                    room.reinforced
                      ? `<p style="color:#66ccff;">æ­¤æˆ¿é–“å·²åŠ å›ºï¼Œé˜²ç¦¦åŠ›è¼ƒé«˜</p>`
                      : ""
                  }
                `;
    actions.innerHTML = `
                  <button class="btn" onclick="closeModal()">é—œé–‰</button>
                  <button class="btn success" onclick="openVisitorsFromRoom()">æŸ¥çœ‹è¨ªå®¢</button>
                `;
  }

  modal.style.display = "block";
}

function healTenantInRoom(roomId) {
  const room = gameState.rooms.find((r) => r.id === roomId);
  const doctors = getDoctorTenants();

  if (
    doctors.length > 0 &&
    gameState.resources.medical >= 3 &&
    room.tenant.infected
  ) {
    gameState.resources.medical -= 3;
    room.tenant.infected = false;
    addLog(`é†«ç”Ÿæ²»ç™’äº†æˆ¿é–“ ${roomId} çš„ ${room.tenant.name}`, "skill");
    closeModal();
    updateDisplay();
  }
}

function collectRent() {
  if (gameState.rentCollected) {
    alert("ä»Šå¤©å·²ç¶“æ”¶éæˆ¿ç§Ÿäº†ï¼");
    return;
  }

  let totalCashRent = 0;
  let resourcePayments = [];

  gameState.rooms.forEach((room) => {
    if (room.tenant && !room.tenant.infected) {
      const tenant = room.tenant;
      let rentPaid = false;
      let rentOwed = tenant.rent;

      if (
        tenant.personalResources &&
        tenant.personalResources.cash >= tenant.rent
      ) {
        tenant.personalResources.cash -= tenant.rent;
        totalCashRent += tenant.rent;
        addLog(`${tenant.name} æ”¯ä»˜ç¾é‡‘æˆ¿ç§Ÿ $${tenant.rent}`, "rent");
        rentPaid = true;
      } else {
        const resourceValue = {
          food: 1.5,
          materials: 3,
          medical: 4,
          fuel: 3
        };

        let paymentDetails = [];
        let totalPaid = 0;

        if (tenant.personalResources && tenant.personalResources.cash > 0) {
          const cashPayment = Math.min(rentOwed, tenant.personalResources.cash);
          rentOwed -= cashPayment;
          totalPaid += cashPayment;
          tenant.personalResources.cash -= cashPayment;
          paymentDetails.push(`ç¾é‡‘ $${cashPayment}`);
        }

        Object.keys(resourceValue).forEach((resource) => {
          if (
            rentOwed > 0 &&
            tenant.personalResources &&
            tenant.personalResources[resource] > 0
          ) {
            const resourceNeeded = Math.ceil(
              rentOwed / resourceValue[resource]
            );
            const resourceAvailable = tenant.personalResources[resource];
            const resourceUsed = Math.min(resourceNeeded, resourceAvailable);
            const valueProvided = resourceUsed * resourceValue[resource];

            if (resourceUsed > 0) {
              tenant.personalResources[resource] -= resourceUsed;
              gameState.resources[resource] += resourceUsed;
              rentOwed -= valueProvided;
              totalPaid += valueProvided;

              const resourceNames = {
                food: "é£Ÿç‰©",
                materials: "å»ºæ",
                medical: "é†«ç™‚ç”¨å“",
                fuel: "ç‡ƒæ–™"
              };

              paymentDetails.push(
                `${resourceUsed}ä»½${resourceNames[resource]} (åƒ¹å€¼$${Math.floor(
                  valueProvided
                )})`
              );
            }
          }
        });

        if (paymentDetails.length > 0) {
          const shortfall = Math.max(0, tenant.rent - totalPaid);

          if (shortfall > 0) {
            addLog(`ğŸ“‹ ${tenant.name} æˆ¿ç§Ÿæ”¯ä»˜æ˜ç´°ï¼š`, "rent");
            addLog(`   â€¢ æ‡‰ä»˜æˆ¿ç§Ÿï¼š$${tenant.rent}`, "rent");
            addLog(`   â€¢ å¯¦éš›æ”¯ä»˜ï¼š${paymentDetails.join(" + ")}`, "rent");
            addLog(`   â€¢ æ”¯ä»˜ç¸½å€¼ï¼š$${Math.floor(totalPaid)}`, "rent");
            addLog(`   â€¢ å‰©é¤˜æ¬ æ¬¾ï¼š$${Math.floor(shortfall)}`, "danger");
          } else {
            addLog(`âœ… ${tenant.name} æˆ¿ç§Ÿæ”¯ä»˜æ˜ç´°ï¼š`, "rent");
            addLog(
              `   â€¢ æˆ¿ç§Ÿï¼š$${tenant.rent} (${paymentDetails.join(" + ")})`,
              "rent"
            );
          }
          rentPaid = true;
        }
      }

      if (room.reinforced && rentPaid) {
        const bonus = Math.floor(tenant.rent * 0.2);
        totalCashRent += bonus;
        addLog(`ğŸ›¡ï¸ åŠ å›ºæˆ¿é–“ ${room.id} é¡å¤–æ”¶å– $${bonus}`, "rent");
      }

      if (!rentPaid && rentOwed > 0) {
        addLog(
          `âŒ ${tenant.name} ç„¡æ³•æ”¯ä»˜æˆ¿ç§Ÿï¼Œç¸½æ¬ æ¬¾ $${Math.floor(rentOwed)}`,
          "danger"
        );
      }
    }
  });

  if (totalCashRent > 0) {
    gameState.resources.cash += totalCashRent;
    addLog(`ğŸ’° ç¾é‡‘æˆ¿ç§Ÿæ”¶å…¥ç¸½è¨ˆï¼š$${totalCashRent}`, "rent");
  }

  if (totalCashRent === 0 && resourcePayments.length === 0) {
    addLog("ğŸ“­ ä»Šæ—¥æ²’æœ‰ç§Ÿå®¢ç¹³ç´æˆ¿ç§Ÿ", "event");
  }

  gameState.rentCollected = true;
  updateDisplay();
}

function updateRentButton() {
  const rentBtn = document.querySelector('button[onclick="collectRent()"]');
  if (gameState.rentCollected) {
    rentBtn.disabled = true;
    rentBtn.textContent = "æ”¶ç§Ÿ (å·²æ”¶å–)";
  } else {
    rentBtn.disabled = false;
    rentBtn.textContent = "æ”¶ç§Ÿ";
  }
}

function generateApplicants() {
  gameState.applicants = [];
  const count = Math.floor(Math.random() * 3) + 1;

  for (let i = 0; i < count; i++) {
    const type = tenantTypes[Math.floor(Math.random() * tenantTypes.length)];
    const applicant = {
      ...type,
      name: generateName(),
      infected: Math.random() < type.infectionRisk,
      id: Date.now() + i
    };

    if (applicant.infected) {
      applicant.appearance = getInfectedAppearance();
    } else {
      applicant.appearance = getNormalAppearance();
    }

    gameState.applicants.push(applicant);
  }
}

function generateName() {
  const names = [
    "å°æ˜",
    "å°è¯",
    "å°æ",
    "è€ç‹",
    "é˜¿å¼·",
    "å°ç¾",
    "é˜¿ç",
    "å¤§é›„",
    "éœé¦™",
    "èƒ–è™",
    "å°å¼µ",
    "é˜¿é™³",
    "å°æ—",
    "è€åŠ‰",
    "é˜¿èŠ±",
    "å°ç‰",
    "é˜¿å¯¶",
    "å°é³³",
    "é˜¿ç¾©",
    "å°é›²"
  ];
  return names[Math.floor(Math.random() * names.length)];
}

function getInfectedAppearance() {
  const suspiciousTraits = [
    "çœ¼ç¥æœ‰é»å‘†æ»¯ï¼Œåæ‡‰é²éˆ",
    "çš®è†šè’¼ç™½ï¼Œæ‰‹æœ‰è¼•å¾®é¡«æŠ–",
    "èªªè©±æ™‚å¶çˆ¾åœé “ï¼Œåƒåœ¨æƒ³ä»€éº¼",
    "è¡£æœæœ‰äº›è¡€è·¡ï¼Œèªªæ˜¯æ„å¤–å—å‚·",
    "é«”æº«ä¼¼ä¹åä½ï¼Œä¸€ç›´åœ¨ç™¼æŠ–",
    "æœ‰è‚¡å¥‡æ€ªçš„å‘³é“ï¼Œåƒæ˜¯è…è‚‰",
    "èµ°è·¯å§¿å‹¢ç•¥é¡¯åƒµç¡¬",
    "é¿å…çœ¼ç¥æ¥è§¸ï¼Œé¡¯å¾—å¾ˆç·Šå¼µ"
  ];
  return suspiciousTraits[Math.floor(Math.random() * suspiciousTraits.length)];
}

function getNormalAppearance() {
  const normalTraits = [
    "çœ‹èµ·ä¾†ç²¾ç¥ç‹€æ…‹ä¸éŒ¯",
    "è¡£è‘—æ•´æ½”ï¼Œè«‡åå¾—é«”",
    "çœ¼ç¥æ¸…æ¾ˆï¼Œåæ‡‰éˆæ•",
    "æ¡æ‰‹æ™‚æ‰‹æŒæº«æš–æœ‰åŠ›",
    "èªªè©±æ¢ç†æ¸…æ™°ï¼Œå¾ˆæœ‰æ¢ç†",
    "çœ‹èµ·ä¾†å¾ˆå¥åº·ï¼Œæ°£è‰²ä¸éŒ¯",
    "å‹•ä½œè‡ªç„¶æµæš¢",
    "ç¬‘å®¹çœŸèª ï¼Œè®“äººæ„Ÿåˆ°èˆ’é©"
  ];
  return normalTraits[Math.floor(Math.random() * normalTraits.length)];
}

function showApplicants() {
  if (gameState.applicants.length === 0) {
    generateApplicants();
  }

  const modal = document.getElementById("applicantModal");
  const list = document.getElementById("applicantList");

  list.innerHTML = gameState.applicants
    .map((applicant) => {
      const infectionStatus = applicant.revealedInfection
        ? '<br><span style="color:#ff6666; font-weight:bold;">âš  å·²æª¢æ¸¬å‡ºæ„ŸæŸ“ï¼</span>'
        : "";

      return `<div class="applicant ${
        applicant.revealedInfection ? "infected" : ""
      }">
                      <strong>${applicant.name}</strong> - ${applicant.type}<br>
                      <small>${applicant.description}</small><br>
                      <small style="color: #aaa;">å¤–è§€: ${
                        applicant.appearance
                      }</small><br>
                      æˆ¿ç§Ÿ: ${applicant.rent}/å¤©${infectionStatus}<br>
                      <button class="btn ${
                        applicant.revealedInfection ? "danger" : ""
                      }" 
                              onclick="hireTenant(${applicant.id})" 
                              ${
                                applicant.revealedInfection
                                  ? 'title="é›‡ç”¨æ„ŸæŸ“è€…é¢¨éšªå¾ˆé«˜ï¼"'
                                  : ""
                              }>
                        é›‡ç”¨${applicant.revealedInfection ? " (å±éšª)" : ""}
                      </button>
                    </div>`;
    })
    .join("");

  modal.style.display = "block";
}

function hireTenant(applicantId) {
  const applicant = gameState.applicants.find((a) => a.id === applicantId);
  const emptyRoom = gameState.rooms.find((room) => !room.tenant);

  if (!emptyRoom) {
    alert("æ²’æœ‰ç©ºæˆ¿é–“ï¼");
    return;
  }

  emptyRoom.tenant = applicant;
  gameState.applicants = gameState.applicants.filter(
    (a) => a.id !== applicantId
  );

  // åˆå§‹åŒ–ç§Ÿå®¢æ»¿æ„åº¦
  gameState.tenantSatisfaction[applicant.name] = 50;

  addLog(`æ–°ç§Ÿå®¢ ${applicant.name} å…¥ä½æˆ¿é–“ ${emptyRoom.id}`, "rent");
  closeModal();
  updateDisplay();
}

function showScavengeMenu() {
  if (gameState.scavengeUsed >= gameState.maxScavengePerDay) {
    alert("ä»Šå¤©çš„æ´¾é£æ¬¡æ•¸å·²ç”¨å®Œï¼");
    return;
  }

  const availableTenants = gameState.rooms
    .filter(
      (room) => room.tenant && !room.tenant.infected && !room.tenant.onMission
    )
    .map((room) => room.tenant);

  if (availableTenants.length === 0) {
    alert("æ²’æœ‰å¯æ´¾é£çš„ç§Ÿå®¢ï¼");
    return;
  }

  const modal = document.getElementById("scavengeModal");
  const tenantList = document.getElementById("availableTenants");
  const remainingSpan = document.getElementById("remainingScavenges");

  remainingSpan.textContent =
    gameState.maxScavengePerDay - gameState.scavengeUsed;

  tenantList.innerHTML = availableTenants
    .map((tenant) => {
      const successRate = getTenantScavengeRate(tenant);
      return `<div class="applicant">
                        <strong>${tenant.name}</strong> - ${tenant.type}<br>
                        <small>æŠ€èƒ½: ${tenant.skill}</small><br>
                        <small>æˆåŠŸç‡: ${successRate}%</small><br>
                        <button class="btn" onclick="sendSpecificTenant('${tenant.name}')">æ´¾é£</button>
                    </div>`;
    })
    .join("");

  modal.style.display = "block";
}

function getTenantScavengeRate(tenant) {
  const baseRates = {
    soldier: 85,
    worker: 75,
    farmer: 65,
    doctor: 50,
    elder: 40
  };

  let rate = baseRates[tenant.type] || 60;

  if (gameState.scavengeBonus) {
    rate += 15;
  }

  return Math.min(95, rate);
}

function sendSpecificTenant(tenantName) {
  const tenant = gameState.rooms
    .filter((room) => room.tenant && room.tenant.name === tenantName)
    .map((room) => room.tenant)[0];

  if (!tenant) {
    alert("æ‰¾ä¸åˆ°æŒ‡å®šçš„ç§Ÿå®¢ï¼");
    return;
  }

  const successRate = getTenantScavengeRate(tenant);
  const success = Math.random() * 100 < successRate;

  gameState.scavengeUsed++;
  tenant.onMission = true;

  if (success) {
    let foodGain,
      materialGain,
      medicalGain = 0;

    switch (tenant.type) {
      case "soldier":
        foodGain = Math.floor(Math.random() * 6) + 5;
        materialGain = Math.floor(Math.random() * 4) + 3;
        break;
      case "worker":
        foodGain = Math.floor(Math.random() * 5) + 3;
        materialGain = Math.floor(Math.random() * 6) + 4;
        break;
      case "doctor":
        foodGain = Math.floor(Math.random() * 4) + 2;
        materialGain = Math.floor(Math.random() * 3) + 1;
        medicalGain = Math.floor(Math.random() * 4) + 3;
        break;
      case "farmer":
        foodGain = Math.floor(Math.random() * 8) + 4;
        materialGain = Math.floor(Math.random() * 3) + 2;
        break;
      default:
        foodGain = Math.floor(Math.random() * 5) + 3;
        materialGain = Math.floor(Math.random() * 4) + 2;
    }

    gameState.resources.food += foodGain;
    gameState.resources.materials += materialGain;
    if (medicalGain > 0) {
      gameState.resources.medical += medicalGain;
      addLog(
        `${tenant.name} æœåˆ®æˆåŠŸï¼ç²å¾— ${foodGain} é£Ÿç‰©, ${materialGain} å»ºæ, ${medicalGain} é†«ç™‚ç”¨å“`,
        "rent"
      );
    } else {
      addLog(
        `${tenant.name} æœåˆ®æˆåŠŸï¼ç²å¾— ${foodGain} é£Ÿç‰©, ${materialGain} å»ºæ`,
        "rent"
      );
    }
  } else {
    if (Math.random() < 0.3) {
      tenant.infected = true;
      addLog(`${tenant.name} æœåˆ®æ™‚è¢«æ„ŸæŸ“äº†ï¼`, "danger");
    } else {
      addLog(`${tenant.name} æœåˆ®å¤±æ•—ï¼Œç©ºæ‰‹è€Œæ­¸`, "event");
    }
  }

  gameState.scavengeBonus = false;

  closeModal();
  updateDisplay();
}

function updateScavengeButton() {
  const scavengeBtn = document.querySelector(
    'button[onclick="showScavengeMenu()"]'
  );
  if (gameState.scavengeUsed >= gameState.maxScavengePerDay) {
    scavengeBtn.disabled = true;
    scavengeBtn.innerHTML =
      'æ´¾é£æœåˆ® (<span id="scavengeCount">' +
      gameState.scavengeUsed +
      "</span>/2) - å·²ç”¨å®Œ";
  } else {
    scavengeBtn.disabled = false;
    scavengeBtn.innerHTML =
      'æ´¾é£æœåˆ® (<span id="scavengeCount">' +
      gameState.scavengeUsed +
      "</span>/2)";
  }
}

function harvestYard() {
  if (gameState.harvestUsed) {
    alert("ä»Šå¤©å·²ç¶“æ¡é›†éé™¢å­äº†ï¼");
    return;
  }

  if (gameState.harvestCooldown > 0) {
    alert(`é™¢å­éœ€è¦ä¼‘æ¯ ${gameState.harvestCooldown} å¤©æ‰èƒ½å†æ¬¡æ¡é›†ï¼`);
    return;
  }

  const farmers = getFarmerTenants().length;
  let baseHarvest = 2;

  if (gameState.harvestBonus) {
    baseHarvest += 2;
    gameState.harvestBonus = false;
    addLog("é•·è€…çš„å»ºè­°è®“é™¢å­æ¡é›†æ•ˆæœæ›´å¥½ï¼", "skill");
  }

  const bonus = farmers * 2;
  const total = baseHarvest + bonus;

  gameState.rooms.forEach((room) => {
    if (
      room.tenant &&
      room.tenant.type === "farmer" &&
      room.tenant.cropPlanted
    ) {
      if (gameState.day >= room.tenant.cropPlanted) {
        const cropYield = Math.floor(Math.random() * 8) + 5;
        gameState.resources.food += cropYield;
        addLog(
          `è¾²å¤« ${room.tenant.name} çš„ä½œç‰©æ”¶ç©«äº† ${cropYield} é£Ÿç‰©ï¼`,
          "skill"
        );
        room.tenant.cropPlanted = null;
      }
    }
  });

  gameState.resources.food += total;
  gameState.harvestUsed = true;
  gameState.harvestCooldown = 2;
  addLog(
    `é™¢å­æ¡é›†ç²å¾— ${total} é£Ÿç‰©${farmers > 0 ? " (è¾²å¤«åŠ æˆ)" : ""}`,
    "rent"
  );
  addLog(`é™¢å­éœ€è¦ä¼‘æ¯2å¤©æ‰èƒ½å†æ¬¡æ¡é›†`, "event");
  updateHarvestButton();
  updateDisplay();
}

function updateHarvestButton() {
  const harvestBtn = document.querySelector('button[onclick="harvestYard()"]');
  if (gameState.harvestUsed) {
    harvestBtn.disabled = true;
    harvestBtn.textContent = "é™¢å­æ¡é›† (å·²ä½¿ç”¨)";
  } else if (gameState.harvestCooldown > 0) {
    harvestBtn.disabled = true;
    harvestBtn.textContent = `é™¢å­æ¡é›† (å†·å»${gameState.harvestCooldown}å¤©)`;
  } else {
    harvestBtn.disabled = false;
    harvestBtn.textContent = "é™¢å­æ¡é›†";
  }
}

// è¨ªå®¢ç³»çµ±
function generateVisitors() {
  gameState.visitors = [];
  const count = Math.floor(Math.random() * 4) + 1;

  for (let i = 0; i < count; i++) {
    const type = tenantTypes[Math.floor(Math.random() * tenantTypes.length)];
    const visitor = {
      ...type,
      name: generateName(),
      infected: Math.random() < type.infectionRisk,
      id: Date.now() + i,
      personalResources: { ...type.personalResources },
      rentingInterest: Math.random() < 0.6,
      isTrader: Math.random() < 0.4,
      tradeOffers: [],
      invitationSent: false
    };

    if (visitor.infected) {
      visitor.appearance = getInfectedAppearance();
    } else {
      visitor.appearance = getNormalAppearance();
    }

    if (visitor.isTrader) {
      visitor.tradeOffers = generateTradeOffers(visitor);
      visitor.rentingInterest = false;
    }

    gameState.visitors.push(visitor);
  }
}

function generateTradeOffers(trader) {
  const offers = [];

  switch (trader.type) {
    case "doctor":
      offers.push(
        {
          type: "buy",
          item: "medical",
          amount: 3,
          price: 15,
          description: "å‡ºå”®3é†«ç™‚ç”¨å“ (+$15)"
        },
        {
          type: "sell",
          item: "medical",
          amount: 2,
          price: 12,
          description: "è³¼è²·2é†«ç™‚ç”¨å“ (-$12)"
        },
        {
          type: "service",
          service: "healthCheck",
          price: 8,
          description: "å¥åº·æª¢æŸ¥æœå‹™ (-$8)"
        }
      );
      break;

    case "worker":
      offers.push(
        {
          type: "buy",
          item: "materials",
          amount: 4,
          price: 18,
          description: "å‡ºå”®4å»ºæ (+$18)"
        },
        {
          type: "sell",
          item: "materials",
          amount: 5,
          price: 20,
          description: "è³¼è²·5å»ºæ (-$20)"
        },
        {
          type: "service",
          service: "quickRepair",
          price: 10,
          description: "å¿«é€Ÿç¶­ä¿®æœå‹™ (-$10)"
        }
      );
      break;

    case "farmer":
      offers.push(
        {
          type: "buy",
          item: "food",
          amount: 8,
          price: 12,
          description: "å‡ºå”®8é£Ÿç‰© (+$12)"
        },
        {
          type: "sell",
          item: "food",
          amount: 6,
          price: 15,
          description: "è³¼è²·6æ–°é®®é£Ÿç‰© (-$15)"
        },
        {
          type: "sell",
          item: "fuel",
          amount: 3,
          price: 12,
          description: "è³¼è²·3ç”Ÿç‰©ç‡ƒæ–™ (-$12)"
        }
      );
      break;

    case "soldier":
      offers.push(
        {
          type: "sell",
          item: "materials",
          amount: 6,
          price: 25,
          description: "è³¼è²·6è»ç”¨å»ºæ (-$25)"
        },
        {
          type: "service",
          service: "security",
          price: 15,
          description: "å®‰å…¨è«®è©¢æœå‹™ (-$15)"
        }
      );
      break;

    case "elder":
      offers.push(
        {
          type: "sell",
          item: "medical",
          amount: 2,
          price: 8,
          description: "è³¼è²·2è‰è—¥ (-$8)"
        },
        {
          type: "service",
          service: "information",
          price: 5,
          description: "æƒ…å ±æœå‹™ (-$5)"
        }
      );
      break;
  }

  const selectedOffers = [];
  const numOffers = Math.min(offers.length, Math.floor(Math.random() * 2) + 2);

  for (let i = 0; i < numOffers; i++) {
    const randomIndex = Math.floor(Math.random() * offers.length);
    const offer = offers.splice(randomIndex, 1)[0];
    if (offer) selectedOffers.push(offer);
  }

  return selectedOffers;
}

function showVisitors() {
  if (gameState.visitors.length === 0) {
    generateVisitors();
  }

  const modal = document.getElementById("visitorModal");
  const list = document.getElementById("visitorList");

  list.innerHTML = gameState.visitors
    .map((visitor) => {
      const infectionStatus = visitor.revealedInfection
        ? '<br><span style="color:#ff6666; font-weight:bold;">âš  å·²æª¢æ¸¬å‡ºæ„ŸæŸ“ï¼</span>'
        : "";

      let actionButtons = "";

      if (visitor.isTrader) {
        const tradeCount = visitor.tradeOffers ? visitor.tradeOffers.length : 0;
        actionButtons = `<button class="btn special" onclick="tradeWithVisitor(${visitor.id})">
                          äº¤æ˜“ (${tradeCount}é …é¸æ“‡)
                        </button>`;
      } else if (visitor.invitationSent) {
        actionButtons = `<span style="color:#888;">å·²é‚€è«‹é</span>`;
      } else if (visitor.rentingInterest) {
        actionButtons = `
                          <button class="btn ${
                            visitor.revealedInfection ? "danger" : ""
                          }" 
                                  onclick="inviteToRent(${visitor.id})" 
                                  ${
                                    visitor.revealedInfection
                                      ? 'title="é‚€è«‹æ„ŸæŸ“è€…é¢¨éšªå¾ˆé«˜ï¼"'
                                      : ""
                                  }>
                            é‚€è«‹ç§Ÿæˆ¿${
                              visitor.revealedInfection ? " (å±éšª)" : ""
                            }
                          </button>`;
      } else {
        actionButtons = `<button class="btn" onclick="inviteToRent(${visitor.id})">é‚€è«‹ç§Ÿæˆ¿</button>`;
      }

      const resourcesText = `æ“æœ‰: é£Ÿç‰©${visitor.personalResources.food} å»ºæ${
        visitor.personalResources.materials || 0
      } é†«ç™‚${visitor.personalResources.medical || 0} ç¾é‡‘${
        visitor.personalResources.cash
      }`;

      return `<div class="applicant ${
        visitor.revealedInfection ? "infected" : ""
      } ${visitor.isTrader ? "trader" : ""}">
                        <strong>${visitor.name}</strong> - ${visitor.type} ${
        visitor.isTrader ? "(å•†äºº)" : ""
      }${visitor.rentingInterest ? "" : " (åªæ˜¯è·¯é)"}<br>
                        <small>${visitor.description}</small><br>
                        <small style="color: #aaa;">å¤–è§€: ${
                          visitor.appearance
                        }</small><br>
                        <small style="color: #ccc;">${resourcesText}</small><br>
                        ${
                          visitor.rentingInterest
                            ? `æˆ¿ç§Ÿ: ${visitor.rent}/å¤©`
                            : ""
                        }${infectionStatus}<br>
                        ${actionButtons}
                    </div>`;
    })
    .join("");

  modal.style.display = "block";
}

function inviteToRent(visitorId) {
  const visitor = gameState.visitors.find((v) => v.id === visitorId);

  if (visitor.invitationSent) {
    addLog(`å·²ç¶“é‚€è«‹é ${visitor.name} äº†`, "event");
    return;
  }

  const emptyRoom = gameState.rooms.find((room) => !room.tenant);
  if (!emptyRoom) {
    alert("æ²’æœ‰ç©ºæˆ¿é–“ï¼");
    return;
  }

  visitor.invitationSent = true;

  const acceptChance = visitor.rentingInterest ? 0.8 : 0.3;
  if (Math.random() > acceptChance) {
    addLog(`${visitor.name} å©‰æ‹’äº†ç§Ÿæˆ¿é‚€è«‹`, "event");
    showVisitors();
    return;
  }

  if (!visitor.personalResources) {
    const type = tenantTypes.find((t) => t.type === visitor.type);
    visitor.personalResources = { ...type.personalResources };
  }

  emptyRoom.tenant = visitor;
  gameState.visitors = gameState.visitors.filter((v) => v.id !== visitorId);
  gameState.tenantSatisfaction[visitor.name] = 50;

  addLog(`${visitor.name} æ¥å—é‚€è«‹ï¼Œå…¥ä½æˆ¿é–“ ${emptyRoom.id}`, "rent");
  closeModal();
  updateDisplay();
}

function tradeWithVisitor(visitorId) {
  const visitor = gameState.visitors.find((v) => v.id === visitorId);

  if (!visitor || !visitor.isTrader) {
    alert("é€™å€‹è¨ªå®¢ä¸æ˜¯å•†äººï¼");
    return;
  }

  const modal = document.getElementById("eventModal");
  const title = document.getElementById("eventTitle");
  const description = document.getElementById("eventDescription");
  const choices = document.getElementById("eventChoices");

  title.textContent = `å•†äºº ${visitor.name} çš„äº¤æ˜“`;
  description.textContent = `${visitor.name} æ˜¯ä¸€ä½${visitor.type}å•†äººï¼Œæä¾›ä»¥ä¸‹äº¤æ˜“é¸é …ï¼š`;

  let choicesHTML = "";
  visitor.tradeOffers.forEach((offer, index) => {
    let canTrade = true;
    let buttonClass = "btn";

    if (offer.type === "buy") {
      canTrade = (gameState.resources[offer.item] || 0) >= offer.amount;
      buttonClass = canTrade ? "btn success" : "btn";
    } else if (offer.type === "sell") {
      canTrade = gameState.resources.cash >= offer.price;
      buttonClass = canTrade ? "btn special" : "btn";
    } else if (offer.type === "service") {
      canTrade = gameState.resources.cash >= offer.price;
      buttonClass = canTrade ? "btn special" : "btn";
    }

    choicesHTML += `
                  <button class="${buttonClass}" 
                          onclick="executeTradeWithVisitor(${visitorId}, ${index})" 
                          ${canTrade ? "" : "disabled"} 
                          style="margin: 5px; width: 100%;">
                    ${offer.description}
                  </button>
                `;
  });

  choicesHTML +=
    '<button class="btn" onclick="closeEventModal()" style="margin: 5px;">å–æ¶ˆäº¤æ˜“</button>';
  choices.innerHTML = choicesHTML;

  modal.style.display = "block";
}

function executeTradeWithVisitor(visitorId, offerIndex) {
  const visitor = gameState.visitors.find((v) => v.id === visitorId);
  const offer = visitor.tradeOffers[offerIndex];

  if (!offer) return;

  let success = false;

  switch (offer.type) {
    case "buy":
      if ((gameState.resources[offer.item] || 0) >= offer.amount) {
        gameState.resources[offer.item] -= offer.amount;
        gameState.resources.cash += offer.price;
        addLog(
          `å‘å•†äºº ${visitor.name} å‡ºå”® ${offer.amount} ${offer.item}ï¼Œç²å¾— ${offer.price}`,
          "rent"
        );
        success = true;
      }
      break;

    case "sell":
      if (gameState.resources.cash >= offer.price) {
        gameState.resources.cash -= offer.price;
        gameState.resources[offer.item] =
          (gameState.resources[offer.item] || 0) + offer.amount;
        addLog(
          `å¾å•†äºº ${visitor.name} è³¼è²· ${offer.amount} ${offer.item}ï¼ŒèŠ±è²» ${offer.price}`,
          "rent"
        );
        success = true;
      }
      break;

    case "service":
      if (gameState.resources.cash >= offer.price) {
        gameState.resources.cash -= offer.price;
        executeTradeService(visitor, offer.service);
        success = true;
      }
      break;
  }

  if (success) {
    visitor.tradeOffers.splice(offerIndex, 1);

    if (visitor.tradeOffers.length === 0) {
      addLog(`å•†äºº ${visitor.name} å®Œæˆæ‰€æœ‰äº¤æ˜“å¾Œé›¢é–‹äº†`, "event");
      gameState.visitors = gameState.visitors.filter((v) => v.id !== visitorId);
    }
  } else {
    addLog(`äº¤æ˜“å¤±æ•—ï¼šè³‡æºä¸è¶³`, "danger");
  }

  closeModal();
  updateDisplay();
}

function executeTradeService(visitor, service) {
  switch (service) {
    case "healthCheck":
      if (gameState.visitors.length > 0) {
        gameState.visitors.forEach((v) => {
          if (v.infected && !v.revealedInfection) {
            v.revealedInfection = true;
            addLog(`å•†äººé†«ç”Ÿæª¢æ¸¬ç™¼ç¾ ${v.name} å·²è¢«æ„ŸæŸ“ï¼`, "danger");
          }
        });
      }

      const healthyTenants = getHealthyTenants();
      if (healthyTenants.length > 0) {
        healthyTenants.forEach((t) => {
          if (Math.random() < 0.15) {
            t.infected = true;
            addLog(`å•†äººé†«ç”Ÿæª¢æŸ¥ç™¼ç¾ ${t.name} å‡ºç¾æ—©æœŸæ„ŸæŸ“ç—‡ç‹€ï¼`, "danger");
          }
        });
      }
      addLog(`å•†äººé†«ç”Ÿ ${visitor.name} æä¾›äº†å°ˆæ¥­å¥åº·æª¢æŸ¥æœå‹™`, "skill");
      break;

    case "quickRepair":
      const repairRooms = gameState.rooms.filter((r) => r.needsRepair);
      if (repairRooms.length > 0) {
        repairRooms[0].needsRepair = false;
        addLog(
          `å•†äººå·¥äºº ${visitor.name} å¿«é€Ÿä¿®å¾©äº†æˆ¿é–“ ${repairRooms[0].id}`,
          "skill"
        );
      } else {
        addLog(
          `å•†äººå·¥äºº ${visitor.name} æª¢æŸ¥äº†å»ºç¯‰ï¼Œç›®å‰æ²’æœ‰éœ€è¦ç¶­ä¿®çš„åœ°æ–¹`,
          "event"
        );
      }
      break;

    case "security":
      gameState.buildingDefense += 1;
      addLog(
        `å•†äººè»äºº ${visitor.name} æä¾›äº†å®‰å…¨å»ºè­°ï¼Œå»ºç¯‰é˜²ç¦¦æå‡1é»`,
        "skill"
      );
      break;

    case "information":
      const infoEffects = [
        () => {
          addLog(`å•†äººè€äºº ${visitor.name} å‘Šè¨´ä½ é™„è¿‘æœ‰å»¢æ£„çš„é†«é™¢`, "event");
          gameState.scavengeBonus = true;
        },
        () => {
          addLog(`å•†äººè€äºº ${visitor.name} åˆ†äº«äº†é£Ÿç‰©ä¿å­˜æŠ€å·§`, "event");
          gameState.harvestBonus = true;
        },
        () => {
          if (Math.random() < 0.3) {
            const bonus = Math.floor(Math.random() * 5) + 3;
            gameState.resources.food += bonus;
            addLog(
              `å•†äººè€äºº ${visitor.name} çµ¦äº†ä½  ${bonus} ä»½æ‡‰æ€¥é£Ÿç‰©`,
              "rent"
            );
          }
        }
      ];
      const effect =
        infoEffects[Math.floor(Math.random() * infoEffects.length)];
      effect();
      break;
  }
}

// äº‹ä»¶è§¸ç™¼
function triggerRandomEvent() {
  const availableEvents = events.filter((event) => event.trigger());
  if (availableEvents.length === 0 || Math.random() < 0.7) return;

  const event =
    availableEvents[Math.floor(Math.random() * availableEvents.length)];
  showEvent(event);
}

function triggerConflictEvent() {
  const conflictChance = calculateConflictChance();
  if (Math.random() < conflictChance) {
    const availableConflicts = conflictEvents.filter((conflict) =>
      conflict.trigger()
    );
    if (availableConflicts.length > 0) {
      const conflict =
        availableConflicts[
          Math.floor(Math.random() * availableConflicts.length)
        ];
      showConflictEvent(conflict);
    }
  }
}

function showEvent(event) {
  const modal = document.getElementById("eventModal");
  document.getElementById("eventTitle").textContent = event.title;
  document.getElementById("eventDescription").textContent = event.description;

  const choices = document.getElementById("eventChoices");
  choices.innerHTML = event.choices
    .filter((choice) => !choice.condition || choice.condition())
    .map(
      (choice, index) =>
        `<button class="btn" onclick="handleEventChoice(${index})" style="margin: 5px;">${choice.text}</button>`
    )
    .join("");

  window.currentEvent = event;
  modal.style.display = "block";
}

function showConflictEvent(conflict) {
  const modal = document.getElementById("eventModal");
  document.getElementById("eventTitle").textContent = conflict.title;
  document.getElementById("eventDescription").textContent =
    conflict.description;

  const choices = document.getElementById("eventChoices");
  const conflictChoices = conflict.getChoices();

  choices.innerHTML = conflictChoices
    .filter((choice) => !choice.condition || choice.condition())
    .map(
      (choice, index) =>
        `<button class="btn" onclick="handleConflictChoice(${index})" style="margin: 5px;">${choice.text}</button>`
    )
    .join("");

  window.currentConflict = conflict;
  modal.style.display = "block";
}

function handleEventChoice(choiceIndex) {
  const availableChoices = window.currentEvent.choices.filter(
    (choice) => !choice.condition || choice.condition()
  );
  const choice = availableChoices[choiceIndex];
  choice.effect();
  closeModal();
  updateDisplay();
}

function handleConflictChoice(choiceIndex) {
  const conflictChoices = window.currentConflict.getChoices();
  const availableChoices = conflictChoices.filter(
    (choice) => !choice.condition || choice.condition()
  );
  const choice = availableChoices[choiceIndex];
  choice.effect();
  closeModal();
  updateDisplay();
}

// ç§Ÿå®¢äº’åŠ©ç³»çµ±
function processTenantMutualAid() {
  if (Math.random() < 0.3 && getOccupiedRooms().length >= 2) {
    const tenants = gameState.rooms
      .filter((r) => r.tenant)
      .map((r) => r.tenant);

    const needyTenant = tenants.find(
      (t) =>
        t.personalResources.food <= 1 ||
        (t.type === "elder" && t.personalResources.medical <= 1) ||
        t.personalResources.cash <= 5
    );

    const helpfulTenant = tenants.find(
      (t) =>
        t !== needyTenant &&
        (t.personalResources.food >= 5 ||
          t.personalResources.cash >= 15 ||
          t.personalResources.medical >= 3)
    );

    if (needyTenant && helpfulTenant) {
      if (
        needyTenant.personalResources.food <= 1 &&
        helpfulTenant.personalResources.food >= 3
      ) {
        helpfulTenant.personalResources.food -= 2;
        needyTenant.personalResources.food += 2;
        addLog(
          `${helpfulTenant.name} åˆ†äº«äº†2é£Ÿç‰©çµ¦ ${needyTenant.name}`,
          "event"
        );
      } else if (
        needyTenant.personalResources.cash <= 5 &&
        helpfulTenant.personalResources.cash >= 12
      ) {
        const loanAmount = 5;
        helpfulTenant.personalResources.cash -= loanAmount;
        needyTenant.personalResources.cash += loanAmount;
        addLog(
          `${helpfulTenant.name} å€Ÿäº† ${loanAmount} çµ¦ ${needyTenant.name}`,
          "event"
        );
      } else if (
        needyTenant.type === "elder" &&
        needyTenant.personalResources.medical <= 1 &&
        helpfulTenant.personalResources.medical >= 2
      ) {
        helpfulTenant.personalResources.medical -= 1;
        needyTenant.personalResources.medical += 1;
        addLog(
          `${helpfulTenant.name} çµ¦äº†1é†«ç™‚ç”¨å“çµ¦è€äºº ${needyTenant.name}`,
          "event"
        );
      }
    }
  }
}

function processTenantLandlordTrade() {
  if (Math.random() < 0.25) {
    const tenants = gameState.rooms
      .filter((r) => r.tenant && r.tenant.personalResources)
      .map((r) => r.tenant);
    const tradingTenant = tenants.find(
      (t) =>
        (t.personalResources.food <= 2 && gameState.resources.food >= 5) ||
        (t.personalResources.cash >= 18 && gameState.resources.food <= 12)
    );

    if (tradingTenant) {
      if (
        tradingTenant.personalResources.food <= 2 &&
        tradingTenant.personalResources.cash >= 8 &&
        gameState.resources.food >= 4
      ) {
        const cost = 8;
        const foodAmount = 4;

        tradingTenant.personalResources.cash -= cost;
        tradingTenant.personalResources.food += foodAmount;
        gameState.resources.cash += cost;
        gameState.resources.food -= foodAmount;

        addLog(
          `${tradingTenant.name} ç”¨ ${cost} å‘æˆ¿æ±è³¼è²·äº† ${foodAmount} é£Ÿç‰©`,
          "rent"
        );
      } else if (
        tradingTenant.personalResources.cash >= 18 &&
        tradingTenant.personalResources.food >= 6 &&
        gameState.resources.food <= 12
      ) {
        const payment = 10;
        const foodAmount = 5;

        if (gameState.resources.cash >= payment) {
          tradingTenant.personalResources.cash += payment;
          tradingTenant.personalResources.food -= foodAmount;
          gameState.resources.cash -= payment;
          gameState.resources.food += foodAmount;

          addLog(
            `æˆ¿æ±ç”¨ ${payment} å‘ ${tradingTenant.name} è³¼è²·äº† ${foodAmount} é£Ÿç‰©`,
            "rent"
          );
        }
      }
    }
  }
}

function nextDay() {
  // é‡ç½®ç§Ÿå®¢ç‹€æ…‹
  gameState.rooms.forEach((room) => {
    if (room.tenant) {
      room.tenant.onMission = false;
      room.tenant.adviceUsedToday = false;
      room.tenant.tipUsedToday = false;
      room.tenant.nightWatchActive = false;
      room.tenant.identifiedToday = false;
    }
  });

  // æ¸›å°‘é™¢å­æ¡é›†å†·å»
  if (gameState.harvestCooldown > 0) {
    gameState.harvestCooldown--;
    if (gameState.harvestCooldown === 0) {
      addLog("é™¢å­å·²ç¶“æ¢å¾©ï¼Œå¯ä»¥å†æ¬¡æ¡é›†äº†", "event");
    }
  }

  // è™•ç†è¢«å‹•æŠ€èƒ½æ•ˆæœ
  gameState.rooms.forEach((room) => {
    if (room.tenant && !room.tenant.infected) {
      const tenant = room.tenant;

      switch (tenant.type) {
        case "doctor":
          gameState.resources.medical += 1;
          addLog(`é†«ç”Ÿ ${tenant.name} è£½ä½œäº† 1 é†«ç™‚ç”¨å“`, "skill");
          break;

        case "worker":
          if (Math.random() < 0.3) {
            const needRepair = gameState.rooms.filter((r) => r.needsRepair);
            if (needRepair.length > 0) {
              needRepair[0].needsRepair = false;
              addLog(
                `å·¥äºº ${tenant.name} é€²è¡Œæ—¥å¸¸ç¶­è­·ï¼Œä¿®å¾©äº†æˆ¿é–“æå‚·`,
                "skill"
              );
            }
          }
          break;

        case "farmer":
          if (tenant.cropPlanted && gameState.day >= tenant.cropPlanted) {
            const cropYield = Math.floor(Math.random() * 10) + 8;
            gameState.resources.food += cropYield;
            addLog(
              `è¾²å¤« ${tenant.name} çš„ä½œç‰©æ”¶ç©«äº† ${cropYield} é£Ÿç‰©ï¼`,
              "skill"
            );
            tenant.cropPlanted = null;
          }
          break;
      }

      // é‡ç½®æŠ€èƒ½å†·å»
      if (tenant.foragingCooldown && gameState.day >= tenant.foragingCooldown) {
        tenant.foragingUsed = false;
      }
      if (tenant.guidanceCooldown && gameState.day >= tenant.guidanceCooldown) {
        tenant.lifeGuidanceUsed = false;
      }
    }
  });

  // æˆ¿æ±æ¶ˆè²»é£Ÿç‰©
  if (gameState.resources.food >= 2) {
    gameState.resources.food -= 2;
    addLog("æˆ¿æ±æ¶ˆè€—äº† 2 é£Ÿç‰©", "event");
    gameState.landlordHunger = Math.max(0, gameState.landlordHunger - 1);
  } else if (gameState.resources.food >= 1) {
    gameState.resources.food -= 1;
    addLog("æˆ¿æ±åªåƒäº† 1 é£Ÿç‰©ï¼Œä»æ„Ÿåˆ°é£¢é¤“", "danger");
    gameState.landlordHunger += 1;
  } else {
    addLog("æˆ¿æ±æ²’æœ‰é£Ÿç‰©å¯åƒï¼", "danger");
    gameState.landlordHunger += 2;
  }

  // æˆ¿æ±é£¢é¤“å¾Œæœ
  if (gameState.landlordHunger >= 5) {
    addLog("æˆ¿æ±éåº¦é£¢é¤“ï¼Œå·¥ä½œæ•ˆç‡ä¸‹é™", "danger");
  }

  // è™•ç†ç§Ÿå®¢é–“äº’åŠ©
  processTenantMutualAid();

  // è™•ç†ç§Ÿå®¢èˆ‡æˆ¿æ±äº¤æ˜“
  processTenantLandlordTrade();

  // ç§Ÿå®¢å€‹äººè³‡æºæ¶ˆè€—
  gameState.rooms.forEach((room) => {
    if (room.tenant && room.tenant.personalResources) {
      const tenant = room.tenant;

      if (tenant.personalResources.food >= 2) {
        tenant.personalResources.food -= 2;
      } else if (tenant.personalResources.food >= 1) {
        tenant.personalResources.food -= 1;
        addLog(`${tenant.name} å€‹äººé£Ÿç‰©ä¸è¶³ï¼Œåªåƒäº†1ä»½`, "event");
      } else {
        addLog(`${tenant.name} æ²’æœ‰å€‹äººé£Ÿç‰©å¯åƒï¼Œå‘æˆ¿æ±æ±‚åŠ©`, "danger");
        if (Math.random() < 0.3) {
          addLog(`${tenant.name} å› ç‚ºæ²’æœ‰é£Ÿç‰©è€Œé›¢é–‹äº†`, "danger");
          room.tenant = null;
          return;
        }
      }

      if (tenant.type === "elder") {
        if (tenant.personalResources.medical >= 1) {
          tenant.personalResources.medical -= 1;
        } else if (Math.random() < 0.4) {
          addLog(
            `è€äºº ${tenant.name} ç¼ºä¹å€‹äººé†«ç™‚ç”¨å“ï¼Œå¥åº·ç‹€æ³æƒ¡åŒ–`,
            "danger"
          );
          if (Math.random() < 0.3) {
            tenant.infected = true;
          }
        }
      }
    }
  });

  // ç‡ƒæ–™æ¶ˆè²»
  if (gameState.resources.fuel > 0) {
    gameState.resources.fuel -= 1;
    addLog("æˆ¿å±‹ç¶­æŒé‹ä½œæ¶ˆè€—äº† 1 ç‡ƒæ–™", "event");
  } else {
    addLog("ç‡ƒæ–™ä¸è¶³ï¼æˆ¿å±‹è¨­æ–½ç„¡æ³•æ­£å¸¸é‹ä½œ", "danger");
  }

  // é‡ç½®è‡¨æ™‚æ•ˆæœ
  if (gameState.nightWatchActive) {
    gameState.buildingDefense -= 4;
    gameState.nightWatchActive = false;
  }

  gameState.day++;
  gameState.visitors = [];
  gameState.harvestUsed = false;
  gameState.scavengeUsed = 0;
  gameState.rentCollected = false;

  // è§¸ç™¼äº‹ä»¶
  triggerRandomEvent();
  triggerConflictEvent();

  updateHarvestButton();
  updateDisplay();

  addLog("æ–°çš„ä¸€å¤©é–‹å§‹äº†ï¼Œå¯èƒ½æœƒæœ‰æ–°çš„è¨ªå®¢åˆ°ä¾†", "event");
}

function closeModal() {
  document.querySelectorAll(".modal").forEach((modal) => {
    modal.style.display = "none";
  });
}

function closeEventModal() {
  document.querySelectorAll("#eventModal").forEach((modal) => {
    modal.style.display = "none";
  });
}

function repairRoom(roomId) {
  const room = gameState.rooms.find((r) => r.id === roomId);
  const workers = getWorkerTenants();
  const cost = workers.length > 0 ? 2 : 3;

  if (gameState.resources.materials >= cost) {
    gameState.resources.materials -= cost;
    room.needsRepair = false;
    addLog(
      `æˆ¿é–“ ${roomId} ç¶­ä¿®å®Œæˆ${workers.length > 0 ? " (å·¥äººå”åŠ©)" : ""}`,
      "event"
    );
    closeModal();
    updateDisplay();
  }
}

function evictTenant(roomId, isInfected) {
  const room = gameState.rooms.find((r) => r.id === roomId);
  if (!room) {
    alert("æ‰¾ä¸åˆ°æŒ‡å®šæˆ¿é–“ï¼");
    return;
  }

  if (!room.tenant) {
    alert("æˆ¿é–“å…§æ²’æœ‰ç§Ÿå®¢ï¼");
    return;
  }

  const name = room.tenant.name;
  showEvictionConfirm(roomId, name, isInfected);
}

function showEvictionConfirm(roomId, tenantName, isInfected) {
  const modal = document.getElementById("tenantModal");
  modal.style.display = "none";

  const confirmModal = document.getElementById("eventModal");
  const title = document.getElementById("eventTitle");
  const description = document.getElementById("eventDescription");
  const choices = document.getElementById("eventChoices");

  title.textContent = isInfected ? "é©…é€æ„ŸæŸ“ç§Ÿå®¢" : "ç§Ÿå®¢é€€ç§Ÿç¢ºèª";
  description.textContent = isInfected
    ? `ç¢ºå®šè¦é©…é€æ„ŸæŸ“çš„ç§Ÿå®¢ ${tenantName}ï¼Ÿ\næ„ŸæŸ“ç§Ÿå®¢æœƒå°å…¶ä»–ç§Ÿå®¢é€ æˆå±éšªã€‚`
    : `ç¢ºå®šè®“ ${tenantName} é€€ç§Ÿå—ï¼Ÿ\né€€ç§Ÿå¾Œéœ€è¦é‡æ–°å°‹æ‰¾ç§Ÿå®¢ã€‚`;

  choices.innerHTML = `
                <button class="btn danger" onclick="confirmEviction(${roomId}, '${tenantName}', ${isInfected})" style="margin: 5px;">
                  ${isInfected ? "ç«‹å³é©…é€" : "ç¢ºèªé€€ç§Ÿ"}
                </button>
                <button class="btn" onclick="closeModal()" style="margin: 5px;">å–æ¶ˆ</button>
            `;

  confirmModal.style.display = "block";
}

function confirmEviction(roomId, tenantName, isInfected) {
  const room = gameState.rooms.find((r) => r.id === roomId);
  if (room && room.tenant) {
    if (isInfected) {
      if (gameState.resources.medical >= 2) {
        gameState.resources.medical -= 2;
        addLog(`é©…é€æ„ŸæŸ“ç§Ÿå®¢èŠ±è²»äº† 2 é†«ç™‚ç”¨å“é€²è¡Œæ¶ˆæ¯’`, "danger");
      } else {
        addLog(`ç¼ºä¹é†«ç™‚ç”¨å“ï¼Œæˆ¿é–“å¯èƒ½å­˜åœ¨æ„ŸæŸ“é¢¨éšª`, "danger");
        room.needsRepair = true;
      }
    } else {
      if (Math.random() < 0.3) {
        const refund = Math.floor(room.tenant.rent * 0.5);
        addLog(`é€€é‚„ ${tenantName} çš„æŠ¼é‡‘ï¼Œæå¤±ç¾é‡‘ ${refund}`, "event");
        gameState.resources.cash = Math.max(
          0,
          gameState.resources.cash - refund
        );
      }
    }

    // æ¸…ç†ç§Ÿå®¢æ»¿æ„åº¦è¨˜éŒ„
    delete gameState.tenantSatisfaction[tenantName];

    addLog(
      `${tenantName} é›¢é–‹äº†æˆ¿é–“ ${roomId}`,
      isInfected ? "danger" : "event"
    );
    room.tenant = null;
    closeModal();
    updateDisplay();
  }
}

function openVisitorsFromRoom() {
  closeModal();
  showVisitors();
}

// åˆå§‹åŒ–éŠæˆ²
updateDisplay();
updateHarvestButton();
updateScavengeButton();
updateRentButton();
addLog("æ­¡è¿ä¾†åˆ°æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨ï¼åœ¨é€™å€‹å±éšªçš„ä¸–ç•Œä¸­ç¶“ç‡Ÿä½ çš„ç§Ÿå±‹äº‹æ¥­ï¼", "event");
addLog("æç¤ºï¼šè¨ªå®¢ä¸­æœ‰äº›æƒ³ç§Ÿæˆ¿ï¼Œæœ‰äº›æ˜¯å•†äººï¼Œé‚„æœ‰ä¸€äº›åªæ˜¯è·¯é", "event");
addLog("æç¤ºï¼šæ²’æœ‰å¸¸è¨­å•†åº—ï¼Œè¦é å•†äººè¨ªå®¢ã€å•†éšŠéè·¯æˆ–ç‰¹æ®Šäº‹ä»¶é€²è¡Œäº¤æ˜“", "event");
addLog("æç¤ºï¼šç§Ÿå®¢å¯ä»¥ç”¨å€‹äººè³‡æºæŠµä»˜æˆ¿ç§Ÿï¼ŒåŠ å›ºæˆ¿é–“èƒ½æ”¶æ›´é«˜ç§Ÿé‡‘", "event");

    </script>
</body>
</html>