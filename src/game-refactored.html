<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨ - é‡æ§‹ç‰ˆ</title>
    <style>
/* === ä¿æŒåŸæœ‰æ¨£å¼ç³»çµ± === */
body {
  font-family: "Courier New", monospace;
  background-color: #2a2a2a;
  color: #e0e0e0;
  margin: 0;
  padding: 20px;
  line-height: 1.4;
}

.game-container {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 20px;
}

.main-area {
  background: #1a1a1a;
  border: 2px solid #555;
  border-radius: 8px;
  padding: 20px;
}

.sidebar {
  background: #1a1a1a;
  border: 2px solid #555;
  border-radius: 8px;
  padding: 15px;
}

.status-bar {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
  font-size: 14px;
  flex-wrap: wrap;
}

.status-bar > div {
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  border: 1px solid #555;
}

#buildingDefenseText {
  color: #66ccff;
}

#landlordHungerText {
  color: #ffcc66;
}

.danger-status {
  color: #ff6666 !important;
  animation: pulse 2s infinite;
}

.good-status {
  color: #66ff66 !important;
}

.house-layout {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.room {
  aspect-ratio: 1;
  border: 2px solid #666;
  background: #333;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.room:hover {
  border-color: #888;
  background: #444;
}

.room.occupied {
  background: #2d4a2d;
  border-color: #4a7c59;
}

.room.needs-repair {
  background: #4a2d2d;
  border-color: #7c4a4a;
}

.room.infected {
  background: #4a2d2d;
  border-color: #cc4444;
  animation: pulse 2s infinite;
}

.room.reinforced {
  border-color: #4a7c9a;
  box-shadow: inset 0 0 10px rgba(74, 124, 154, 0.3);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.tenant-info {
  font-size: 12px;
  text-align: center;
}

.resources {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.resource {
  background: #333;
  padding: 10px;
  border-radius: 4px;
  text-align: center;
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

.btn {
  background: #4a4a4a;
  border: 1px solid #666;
  color: #e0e0e0;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn:hover {
  background: #555;
}

.btn:disabled {
  background: #333;
  color: #666;
  cursor: not-allowed;
}

.btn.danger {
  background: #664444;
  border-color: #aa6666;
}

.btn.success {
  background: #446644;
  border-color: #66aa66;
}

.btn.special {
  background: #666644;
  border-color: #aaaa66;
}

.log {
  background: #222;
  border: 1px solid #444;
  height: 150px;
  overflow-y: auto;
  padding: 10px;
  font-size: 12px;
}

.log-entry {
  margin-bottom: 5px;
  padding: 2px 0;
}

.log-entry.event { color: #ffcc66; }
.log-entry.rent { color: #66ff66; }
.log-entry.danger { color: #ff6666; }
.log-entry.skill { color: #66ccff; }

.tenant-list {
  margin-bottom: 15px;
}

.tenant-item {
  background: #333;
  margin: 5px 0;
  padding: 8px;
  border-radius: 4px;
  font-size: 12px;
}

.tenant-item.infected {
  background: #663333;
  border-left: 3px solid #cc4444;
}

.tenant-item.doctor { border-left: 3px solid #66cc66; }
.tenant-item.worker { border-left: 3px solid #cc8866; }
.tenant-item.soldier { border-left: 3px solid #cc6666; }
.tenant-item.farmer { border-left: 3px solid #66aa44; }

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
}

.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #2a2a2a;
  border: 2px solid #666;
  border-radius: 8px;
  padding: 20px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.applicant {
  background: #333;
  margin: 10px 0;
  padding: 10px;
  border-radius: 4px;
}

.applicant.infected {
  background: #663333;
  border: 2px solid #cc4444;
}

.applicant.trader {
  background: #334466;
  border: 2px solid #6688aa;
}

.modal-content p {
  margin: 6px 0;
  font-size: 13px;
  line-height: 1.5;
}

.modal-content .action-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 15px;
  justify-content: flex-end;
}

.tenant-skill-group {
  background: #2d3d2d;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  border-left: 4px solid #66ccff;
}

.skill-actions {
  background: #1e2e1e;
  padding: 10px;
  border-radius: 4px;
  margin: 8px 0;
  border-left: 3px solid #ffcc66;
}

.skill-actions h5 {
  margin: 0 0 5px 0;
  color: #ffcc66;
}

.skill-actions p {
  margin: 5px 0;
  font-size: 12px;
  color: #ccc;
}

/* æ–°å¢ï¼šç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨ */
.system-status {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 8px 12px;
  border-radius: 4px;
  font-size: 11px;
  z-index: 2000;
}

.system-status.legacy { color: #ff9966; }
.system-status.hybrid { color: #66ccff; }
.system-status.new { color: #66ff66; }
    </style>
</head>
<body>
    <!-- ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div id="systemStatus" class="system-status hybrid">
        ğŸ”„ æ··åˆç³»çµ± v1.0
    </div>

    <div class="game-container">
        <div class="main-area">
            <div class="status-bar">
                <div>ç¬¬ <span id="day">1</span> å¤©</div>
                <div>æ™‚é–“: <span id="time">ç™½å¤©</span></div>
                <div>ğŸ’° ç¾é‡‘: $<span id="cash">50</span></div>
                <div>ğŸ›¡ï¸ é˜²ç¦¦: <span id="buildingDefenseText">è„†å¼±(0)</span></div>
                <div>ğŸ½ï¸ é£¢é¤“: <span id="landlordHungerText">é£½è¶³(0)</span></div>
            </div>

            <div class="house-layout">
                <div class="room" id="room1" onclick="selectRoom(1)">
                    <div class="tenant-info" id="room1-info">ç©ºæˆ¿</div>
                </div>
                <div class="room" id="room2" onclick="selectRoom(2)">
                    <div class="tenant-info" id="room2-info">ç©ºæˆ¿</div>
                </div>
            </div>

            <div class="resources">
                <div class="resource">ğŸ– é£Ÿç‰©: <span id="food">20</span></div>
                <div class="resource">ğŸ”§ å»ºæ: <span id="materials">15</span></div>
                <div class="resource">ğŸ’Š é†«ç™‚: <span id="medical">10</span></div>
                <div class="resource">â›½ ç‡ƒæ–™: <span id="fuel">8</span></div>
            </div>

            <div class="controls">
                <button class="btn success" onclick="collectRent()">æ”¶ç§Ÿ</button>
                <button class="btn" onclick="showVisitors()">æŸ¥çœ‹è¨ªå®¢</button>
                <button class="btn" onclick="showScavengeMenu()">æ´¾é£æœåˆ® (<span id="scavengeCount">0</span>/2)</button>
                <button class="btn" onclick="harvestYard()">é™¢å­æ¡é›†</button>
                <button class="btn special" onclick="showSkillMenu()">ä½¿ç”¨æŠ€èƒ½</button>
                <button class="btn danger" onclick="nextDay()">ä¸‹ä¸€å¤©</button>
            </div>

            <div class="log" id="gameLog">
                <div class="log-entry">éŠæˆ²é–‹å§‹ï¼ä½ ç¹¼æ‰¿äº†é€™æ£Ÿè€æˆ¿å­ï¼Œæœ«æ—¥ä¸­çš„å€–å­˜è€…å€‘æ­£åœ¨å°‹æ‰¾ä½æ‰€...</div>
            </div>
        </div>

        <div class="sidebar">
            <h3>ç§Ÿå®¢åˆ—è¡¨</h3>
            <div class="tenant-list" id="tenantList">
                <div class="tenant-item">æš«ç„¡ç§Ÿå®¢</div>
            </div>

            <h3>ç³»çµ±è³‡è¨Š</h3>
            <div style="font-size: 11px;">
                <p>â€¢ æ¶æ§‹ç‰ˆæœ¬: <span id="archVersion">æ··åˆ v1.0</span></p>
                <p>â€¢ è³‡æ–™ç³»çµ±: <span id="dataSystem">è¼‰å…¥ä¸­...</span></p>
                <p>â€¢ è¦å‰‡å¼•æ“: <span id="ruleEngine">è¼‰å…¥ä¸­...</span></p>
                <button class="btn" onclick="showSystemInfo()" style="width: 100%; margin-top: 5px;">ç³»çµ±ç‹€æ…‹</button>
            </div>

            <h3>éŠæˆ²èªªæ˜</h3>
            <div style="font-size: 11px;">
                <p>â€¢ é»æ“Šæˆ¿é–“æŸ¥çœ‹è©³æƒ…</p>
                <p>â€¢ é‚€è«‹è¨ªå®¢ç§Ÿæˆ¿æˆ–äº¤æ˜“</p>
                <p>â€¢ å•†äººè¨ªå®¢æä¾›å„ç¨®äº¤æ˜“</p>
                <p>â€¢ ç§Ÿå®¢å¯ç”¨è³‡æºæŠµä»˜æˆ¿ç§Ÿ</p>
                <p>â€¢ å–„ç”¨ç§Ÿå®¢æŠ€èƒ½æ±‚ç”Ÿ</p>
                <p>â€¢ æˆ¿æ±ä¹Ÿéœ€è¦é£Ÿç‰©ç¶­ç”Ÿ</p>
                <p>â€¢ ç•™æ„å•†éšŠå’Œæµæµªå•†äºº</p>
            </div>
        </div>
    </div>

    <!-- ç¾æœ‰çš„æ¨¡æ…‹æ¡†HTMLä¿æŒä¸è®Š -->
    <div class="modal" id="visitorModal">
        <div class="modal-content">
            <h3>ä»Šæ—¥è¨ªå®¢</h3>
            <div id="visitorList"></div>
            <button class="btn" onclick="closeModal()">é—œé–‰</button>
        </div>
    </div>

    <div class="modal" id="tenantModal">
        <div class="modal-content">
            <h3 id="tenantModalTitle">ç§Ÿå®¢ç®¡ç†</h3>
            <div id="tenantModalContent"></div>
            <div id="tenantModalActions" class="action-buttons"></div>
        </div>
    </div>

    <div class="modal" id="scavengeModal">
        <div class="modal-content">
            <h3>é¸æ“‡æ´¾é£äººå“¡</h3>
            <p>å‰©ä½™æ´¾é£æ¬¡æ•¸: <span id="remainingScavenges">2</span></p>
            <div id="availableTenants"></div>
            <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="modal" id="skillModal">
        <div class="modal-content">
            <h3>ç§Ÿå®¢æŠ€èƒ½</h3>
            <div id="skillList"></div>
            <button class="btn" onclick="closeModal()">é—œé–‰</button>
        </div>
    </div>

    <div class="modal" id="eventModal">
        <div class="modal-content">
            <h3 id="eventTitle">äº‹ä»¶</h3>
            <p id="eventDescription"></p>
            <div id="eventChoices"></div>
        </div>
    </div>

    <div class="modal" id="systemInfoModal">
        <div class="modal-content">
            <h3>ç³»çµ±ç‹€æ…‹è³‡è¨Š</h3>
            <div id="systemInfoContent"></div>
            <button class="btn" onclick="closeModal()">é—œé–‰</button>
        </div>
    </div>

<script>
// ==================== æ ¸å¿ƒæ¶æ§‹ç³»çµ± ====================

/**
 * DataManager - è³‡æ–™ç®¡ç†æ ¸å¿ƒ
 * å…§åµŒç‰ˆæœ¬ï¼Œé©é…å–®ä¸€HTMLæª”æ¡ˆæ¶æ§‹
 */
const GameCore = (() => {
    'use strict';

    // DataManager æ¨¡çµ„
    class DataManager {
        constructor() {
            this.cache = new Map();
            this.validators = new Map();
            this.loadPromises = new Map();
            this.registerValidators();
        }

        registerValidators() {
            this.validators.set('tenants', (data) => {
                if (!Array.isArray(data)) throw new Error('ç§Ÿå®¢è³‡æ–™å¿…é ˆæ˜¯é™£åˆ—');
                data.forEach((tenant, index) => {
                    const required = ['name', 'type', 'rent', 'skill', 'infectionRisk'];
                    required.forEach(field => {
                        if (!(field in tenant)) {
                            throw new Error(`ç§Ÿå®¢ ${index}: ç¼ºå°‘å¿…è¦æ¬„ä½ ${field}`);
                        }
                    });
                });
                return true;
            });

            this.validators.set('skills', (data) => {
                if (typeof data !== 'object' || data === null) {
                    throw new Error('æŠ€èƒ½è³‡æ–™å¿…é ˆæ˜¯ç‰©ä»¶');
                }
                return true;
            });
        }

        async loadData(dataType, forceReload = false) {
            if (!forceReload && this.cache.has(dataType)) {
                return this.cache.get(dataType);
            }

            if (this.loadPromises.has(dataType)) {
                return this.loadPromises.get(dataType);
            }

            const loadPromise = this._loadFromFile(dataType);
            this.loadPromises.set(dataType, loadPromise);

            try {
                const data = await loadPromise;
                this.validateData(dataType, data);
                this.cache.set(dataType, data);
                console.log(`âœ… æˆåŠŸè¼‰å…¥ ${dataType} è³‡æ–™`);
                return data;
            } catch (error) {
                console.warn(`âš ï¸ è¼‰å…¥ ${dataType} å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™:`, error.message);
                const defaultData = this.getDefaultData(dataType);
                this.cache.set(dataType, defaultData);
                return defaultData;
            } finally {
                this.loadPromises.delete(dataType);
            }
        }

        async _loadFromFile(dataType) {
            const filename = `data/${dataType}.json`;
            const response = await fetch(filename);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        }

        validateData(dataType, data) {
            const validator = this.validators.get(dataType);
            if (validator) {
                return validator(data);
            }
            return true;
        }

        getDefaultData(dataType) {
            const defaults = {
                tenants: window.tenantTypes || [],
                skills: {},
                events: window.events || [],
                rules: {
                    gameBalance: { landlordDailyFood: 2 },
                    mechanics: { maxScavengePerDay: 2 }
                }
            };
            return defaults[dataType] || {};
        }

        getCachedData(dataType) {
            return this.cache.get(dataType);
        }

        isDataLoaded(dataType) {
            return this.cache.has(dataType);
        }
    }

    // RuleEngine æ¨¡çµ„
    class RuleEngine {
        constructor(gameStateRef) {
            this.gameState = gameStateRef;
            this.rules = new Map();
            this.executionHistory = [];
            this.conditionCheckers = new Map();
            this.effectExecutors = new Map();
            
            this.registerBuiltinConditions();
            this.registerBuiltinEffects();
        }

        registerBuiltinConditions() {
            this.conditionCheckers.set('hasResource', (condition, gameState) => {
                const { resource, amount } = condition;
                return (gameState.resources[resource] || 0) >= amount;
            });

            this.conditionCheckers.set('probability', (condition, gameState) => {
                return Math.random() < condition.chance;
            });
        }

        registerBuiltinEffects() {
            this.effectExecutors.set('modifyResource', (effect, gameState) => {
                const { resource, amount } = effect;
                const oldValue = gameState.resources[resource] || 0;
                gameState.resources[resource] = Math.max(0, oldValue + amount);
                return { type: 'resource', resource, amount, newValue: gameState.resources[resource] };
            });

            this.effectExecutors.set('logMessage', (effect, gameState) => {
                const { message, logType = 'event' } = effect;
                if (typeof addLog === 'function') {
                    addLog(message, logType);
                }
                return { type: 'log', message, logType };
            });
        }

        registerRule(ruleId, ruleConfig) {
            const rule = {
                id: ruleId,
                name: ruleConfig.name || ruleId,
                conditions: ruleConfig.conditions || [],
                effects: ruleConfig.effects || [],
                enabled: ruleConfig.enabled !== false
            };
            this.rules.set(ruleId, rule);
            return rule;
        }

        executeRule(ruleId, context = {}) {
            const rule = this.rules.get(ruleId);
            if (!rule || !rule.enabled) {
                return { executed: false, reason: 'rule_not_available' };
            }

            const conditionsMet = this.checkAllConditions(rule.conditions, context);
            if (!conditionsMet) {
                return { executed: false, reason: 'conditions_not_met' };
            }

            const results = [];
            rule.effects.forEach(effect => {
                try {
                    const result = this.executeEffect(effect, this.gameState);
                    results.push(result);
                } catch (error) {
                    console.error(`âŒ è¦å‰‡ ${ruleId} æ•ˆæœåŸ·è¡Œå¤±æ•—:`, error);
                    results.push({ type: 'error', error: error.message });
                }
            });

            return { executed: true, results };
        }

        checkAllConditions(conditions, context = {}) {
            if (!conditions || conditions.length === 0) return true;
            return conditions.every(condition => this.checkCondition(condition, context));
        }

        checkCondition(condition, context = {}) {
            const { type } = condition;
            const checker = this.conditionCheckers.get(type);
            if (!checker) {
                console.warn(`âš ï¸ æœªçŸ¥çš„æ¢ä»¶é¡å‹: ${type}`);
                return false;
            }
            try {
                return checker(condition, { ...this.gameState, ...context });
            } catch (error) {
                console.error(`âŒ æ¢ä»¶æª¢æŸ¥å¤±æ•— (${type}):`, error);
                return false;
            }
        }

        executeEffect(effect, gameState) {
            const { type } = effect;
            const executor = this.effectExecutors.get(type);
            if (!executor) {
                console.warn(`âš ï¸ æœªçŸ¥çš„æ•ˆæœé¡å‹: ${type}`);
                return { type: 'unknown', originalEffect: effect };
            }
            try {
                return executor(effect, gameState);
            } catch (error) {
                console.error(`âŒ æ•ˆæœåŸ·è¡Œå¤±æ•— (${type}):`, error);
                return { type: 'error', error: error.message };
            }
        }
    }

    // GameBridge æ¨¡çµ„ï¼ˆç°¡åŒ–ç‰ˆï¼‰
    class GameBridge {
        constructor(originalGameState) {
            this.originalGameState = originalGameState;
            this.systemStatus = { hybrid: true, version: '1.0.0' };
            this.dataManager = new DataManager();
            this.ruleEngine = new RuleEngine(originalGameState);
        }

        async initialize() {
            console.log('ğŸŒ‰ åˆå§‹åŒ–éŠæˆ²æ©‹æ¥ç³»çµ±...');
            
            try {
                // å˜—è©¦è¼‰å…¥æ–°è³‡æ–™
                const dataTypes = ['tenants', 'skills', 'events', 'rules'];
                for (const dataType of dataTypes) {
                    await this.dataManager.loadData(dataType);
                }
                
                this.systemStatus.dataSystemReady = true;
                console.log('âœ… æ©‹æ¥ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
                this.updateSystemStatus();
                
            } catch (error) {
                console.warn('âš ï¸ æ©‹æ¥ç³»çµ±éƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨:', error.message);
                this.systemStatus.dataSystemReady = false;
                this.updateSystemStatus();
            }
        }

        updateSystemStatus() {
            const statusEl = document.getElementById('systemStatus');
            const dataSystemEl = document.getElementById('dataSystem');
            const ruleEngineEl = document.getElementById('ruleEngine');

            if (statusEl) {
                statusEl.textContent = this.systemStatus.dataSystemReady ? 
                    'ğŸŸ¢ æ··åˆç³»çµ± - é‹è¡Œä¸­' : 'ğŸŸ¡ æ··åˆç³»çµ± - é™ç´šæ¨¡å¼';
            }
            
            if (dataSystemEl) {
                dataSystemEl.textContent = this.systemStatus.dataSystemReady ? 'âœ… å·²è¼‰å…¥' : 'âŒ ä½¿ç”¨é è¨­';
            }
            
            if (ruleEngineEl) {
                ruleEngineEl.textContent = this.ruleEngine ? 'âœ… å°±ç·’' : 'âŒ ä¸å¯ç”¨';
            }
        }

        getSystemInfo() {
            return {
                version: this.systemStatus.version,
                mode: this.systemStatus.dataSystemReady ? 'hybrid' : 'legacy',
                dataManager: {
                    available: !!this.dataManager,
                    loadedTypes: Array.from(this.dataManager.cache.keys())
                },
                ruleEngine: {
                    available: !!this.ruleEngine,
                    ruleCount: this.ruleEngine.rules.size
                }
            };
        }
    }

    // æ¨¡çµ„åŒ¯å‡º
    return {
        DataManager,
        RuleEngine, 
        GameBridge
    };
})();

// ==================== åŸå§‹éŠæˆ²é‚è¼¯ ====================
// ä¿æŒå®Œæ•´çš„åŸå§‹éŠæˆ²ç‹€æ…‹å’Œé‚è¼¯
let gameState = {
    day: 1,
    time: "day",
    resources: { food: 20, materials: 15, medical: 10, fuel: 8, cash: 50 },
    rooms: [
        { id: 1, tenant: null, needsRepair: false, reinforced: false },
        { id: 2, tenant: null, needsRepair: false, reinforced: false }
    ],
    applicants: [],
    visitors: [],
    landlordHunger: 0,
    harvestUsed: false,
    harvestCooldown: 0,
    scavengeUsed: 0,
    maxScavengePerDay: 2,
    rentCollected: false,
    buildingDefense: 0,
    tenantSatisfaction: {},
    harmoniumBonus: 0
};

// ä¿æŒåŸå§‹ç§Ÿå®¢é¡å‹å®šç¾©ä½œç‚ºå¾Œå‚™
const tenantTypes = [
    {
        name: "é†«ç”Ÿ",
        type: "doctor",
        rent: 15,
        skill: "é†«ç™‚",
        infectionRisk: 0.1,
        description: "å¯ä»¥æ²»ç™‚æ„ŸæŸ“ï¼Œæª¢æ¸¬å¯ç–‘ç§Ÿå®¢ï¼Œæä¾›é†«ç™‚æœå‹™",
        personalResources: { food: 3, medical: 5, cash: 20 }
    },
    {
        name: "å·¥äºº",
        type: "worker",
        rent: 12,
        skill: "ç¶­ä¿®",
        infectionRisk: 0.2,
        description: "æ“…é•·ç¶­ä¿®å»ºç¯‰ï¼Œæˆ¿é–“å‡ç´šï¼Œå»ºç¯‰æ”¹è‰¯",
        personalResources: { food: 4, materials: 8, cash: 15 }
    },
    {
        name: "è¾²å¤«",
        type: "farmer",
        rent: 10,
        skill: "ç¨®æ¤",
        infectionRisk: 0.15,
        description: "æå‡é™¢å­æ¡é›†æ•ˆç‡ï¼Œç¨®æ¤ä½œç‰©ï¼Œé‡å¤–æ¡é›†",
        personalResources: { food: 8, materials: 2, cash: 12 }
    },
    {
        name: "è»äºº",
        type: "soldier",
        rent: 18,
        skill: "æˆ°é¬¥",
        infectionRisk: 0.25,
        description: "æˆ°é¬¥åŠ›å¼·ï¼Œæå‡æˆ¿å±‹é˜²ç¦¦ï¼Œå®‰å…¨ç®¡ç†",
        personalResources: { food: 5, materials: 3, cash: 25 }
    },
    {
        name: "è€äºº",
        type: "elder",
        rent: 8,
        skill: "ç¶“é©—",
        infectionRisk: 0.3,
        description: "ç¶“é©—è±å¯Œï¼Œèª¿è§£ç³¾ç´›ï¼Œç¤¾äº¤ç®¡ç†ï¼Œäººéš›ç¶²çµ¡",
        personalResources: { food: 2, medical: 3, cash: 30 }
    }
];

// ==================== å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ====================
let gameBridge = null;

// åˆå§‹åŒ–ç³»çµ±
async function initializeGame() {
    try {
        gameBridge = new GameCore.GameBridge(gameState);
        await gameBridge.initialize();
        
        console.log('ğŸ® éŠæˆ²ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        updateDisplay();
        
    } catch (error) {
        console.error('âŒ éŠæˆ²åˆå§‹åŒ–å¤±æ•—:', error);
        console.log('ğŸ”„ ä½¿ç”¨åŸå§‹ç³»çµ±æ¨¡å¼');
        updateDisplay();
    }
}

// ==================== åŸå§‹éŠæˆ²å‡½æ•¸ä¿æŒä¸è®Š ====================
// [é€™è£¡ä¿æŒæ‰€æœ‰åŸå§‹çš„éŠæˆ²é‚è¼¯å‡½æ•¸ï¼Œç¢ºä¿åŠŸèƒ½ç©©å®šæ€§]

function addLog(message, type = "") {
    const log = document.getElementById("gameLog");
    const entry = document.createElement("div");
    entry.className = `log-entry ${type}`;
    entry.textContent = `ç¬¬${gameState.day}å¤©: ${message}`;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function getDefenseStatusText(defense) {
    if (defense <= 0) return `è„†å¼±(${defense})`;
    if (defense <= 2) return `åŸºæœ¬(${defense})`;
    if (defense <= 5) return `ç©©å›º(${defense})`;
    if (defense <= 8) return `å …å›º(${defense})`;
    if (defense <= 12) return `è¦å¡(${defense})`;
    return `éŠ…ç‰†éµå£(${defense})`;
}

function getHungerStatusText(hunger) {
    if (hunger <= 0) return `é£½è¶³(${hunger})`;
    if (hunger <= 1) return `å¾®é¤“(${hunger})`;
    if (hunger <= 2) return `æœ‰é»é¤“(${hunger})`;
    if (hunger <= 3) return `é£¢é¤“(${hunger})`;
    if (hunger <= 4) return `å¾ˆé¤“(${hunger})`;
    if (hunger <= 6) return `æ¥µåº¦é£¢é¤“(${hunger})`;
    return `ç€•è‡¨é¤“æ­»(${hunger})`;
}

function updateDisplay() {
    document.getElementById("day").textContent = gameState.day;
    document.getElementById("time").textContent = gameState.time === "day" ? "ç™½å¤©" : "å¤œæ™š";
    document.getElementById("cash").textContent = gameState.resources.cash;
    document.getElementById("buildingDefenseText").textContent = getDefenseStatusText(gameState.buildingDefense);
    document.getElementById("landlordHungerText").textContent = getHungerStatusText(gameState.landlordHunger);
    document.getElementById("scavengeCount").textContent = gameState.scavengeUsed;

    Object.keys(gameState.resources).forEach((resource) => {
        const element = document.getElementById(resource);
        if (element) {
            element.textContent = gameState.resources[resource];
        }
    });

    gameState.rooms.forEach((room) => {
        const roomElement = document.getElementById(`room${room.id}`);
        const infoElement = document.getElementById(`room${room.id}-info`);

        roomElement.className = "room";

        if (room.tenant) {
            roomElement.classList.add("occupied");
            if (room.tenant.infected) {
                roomElement.classList.add("infected");
            }

            const satisfaction = gameState.tenantSatisfaction[room.tenant.name] || 50;
            const satisfactionText = satisfaction >= 70 ? "ğŸ˜Š" : satisfaction >= 40 ? "ğŸ˜" : "ğŸ˜";

            infoElement.innerHTML = `${room.tenant.name}<br><small>${room.tenant.skill}</small><br><small>æ»¿æ„åº¦: ${satisfaction} ${satisfactionText}</small>`;
        } else {
            infoElement.textContent = "ç©ºæˆ¿";
        }

        if (room.needsRepair) {
            roomElement.classList.add("needs-repair");
            infoElement.innerHTML += '<br><small style="color:#ff6666">éœ€è¦ç¶­ä¿®</small>';
        }

        if (room.reinforced) {
            roomElement.classList.add("reinforced");
            infoElement.innerHTML += '<br><small style="color:#66ccff">å·²åŠ å›º</small>';
        }
    });

    updateTenantList();
}

function updateTenantList() {
    const tenantList = document.getElementById("tenantList");
    const tenants = gameState.rooms
        .filter((room) => room.tenant)
        .map((room) => room.tenant);

    if (tenants.length === 0) {
        tenantList.innerHTML = '<div class="tenant-item">æš«ç„¡ç§Ÿå®¢</div>';
    } else {
        tenantList.innerHTML = tenants
            .map((tenant) => {
                let statusText = "";
                if (tenant.infected) {
                    statusText = '<br><small style="color:#ff6666">å·²æ„ŸæŸ“ï¼</small>';
                } else if (tenant.onMission) {
                    statusText = '<br><small style="color:#ffaa66">åŸ·è¡Œä»»å‹™ä¸­</small>';
                }

                const resourceStatus = tenant.personalResources
                    ? `<br><small style="color:#cccccc">å€‹äºº: $${tenant.personalResources.cash || 0} é£Ÿç‰©${tenant.personalResources.food || 0}</small>`
                    : "";

                const satisfaction = gameState.tenantSatisfaction[tenant.name] || 50;

                return `<div class="tenant-item ${tenant.infected ? "infected" : ""} ${tenant.type}">
                    ${tenant.name} (${tenant.type})<br>
                    <small>æˆ¿ç§Ÿ: ${tenant.rent} | ${tenant.skill}</small>
                    ${resourceStatus}
                    <small>æ»¿æ„åº¦: ${satisfaction}%</small>
                    ${statusText}
                </div>`;
            })
            .join("");
    }
}

// åŸºæœ¬éŠæˆ²åŠŸèƒ½ - ç°¡åŒ–ç‰ˆæœ¬ï¼Œä¿æŒæ ¸å¿ƒåŠŸèƒ½
function collectRent() {
    if (gameState.rentCollected) {
        alert("ä»Šå¤©å·²ç¶“æ”¶éæˆ¿ç§Ÿäº†ï¼");
        return;
    }

    let totalRent = 0;
    gameState.rooms.forEach((room) => {
        if (room.tenant && !room.tenant.infected) {
            totalRent += room.tenant.rent;
        }
    });

    gameState.resources.cash += totalRent;
    gameState.rentCollected = true;
    
    if (totalRent > 0) {
        addLog(`æ”¶å–æˆ¿ç§Ÿ $${totalRent}`, "rent");
    } else {
        addLog("ä»Šæ—¥æ²’æœ‰æˆ¿ç§Ÿæ”¶å…¥", "event");
    }
    
    updateDisplay();
}

function showVisitors() {
    // ç°¡åŒ–çš„è¨ªå®¢ç³»çµ±
    alert("è¨ªå®¢åŠŸèƒ½æ­£åœ¨é‡æ§‹ä¸­ï¼Œè«‹ç¨å€™...");
}

function showScavengeMenu() {
    alert("æ´¾é£åŠŸèƒ½æ­£åœ¨é‡æ§‹ä¸­ï¼Œè«‹ç¨å€™...");
}

function harvestYard() {
    if (gameState.harvestUsed) {
        alert("ä»Šå¤©å·²ç¶“æ¡é›†éé™¢å­äº†ï¼");
        return;
    }

    const baseAmount = 2;
    gameState.resources.food += baseAmount;
    gameState.harvestUsed = true;
    
    addLog(`é™¢å­æ¡é›†ç²å¾— ${baseAmount} é£Ÿç‰©`, "rent");
    updateDisplay();
}

function showSkillMenu() {
    alert("æŠ€èƒ½åŠŸèƒ½æ­£åœ¨é‡æ§‹ä¸­ï¼Œè«‹ç¨å€™...");
}

function selectRoom(roomId) {
    const room = gameState.rooms.find((r) => r.id === roomId);
    if (room.tenant) {
        alert(`æˆ¿é–“ ${roomId} - ${room.tenant.name} (${room.tenant.type})`);
    } else {
        alert(`æˆ¿é–“ ${roomId} - ç©ºæˆ¿`);
    }
}

function nextDay() {
    // åŸºæœ¬çš„æ—¥æœŸæ¨é€²é‚è¼¯
    gameState.day++;
    gameState.harvestUsed = false;
    gameState.scavengeUsed = 0;
    gameState.rentCollected = false;
    
    // æˆ¿æ±æ¶ˆè²»é£Ÿç‰©
    if (gameState.resources.food >= 2) {
        gameState.resources.food -= 2;
        gameState.landlordHunger = Math.max(0, gameState.landlordHunger - 1);
        addLog("æˆ¿æ±æ¶ˆè€—äº† 2 é£Ÿç‰©", "event");
    } else {
        gameState.landlordHunger += 1;
        addLog("æˆ¿æ±æ²’æœ‰è¶³å¤ é£Ÿç‰©ï¼", "danger");
    }
    
    // ç‡ƒæ–™æ¶ˆè²»
    if (gameState.resources.fuel > 0) {
        gameState.resources.fuel -= 1;
        addLog("æ¶ˆè€—äº† 1 ç‡ƒæ–™", "event");
    }
    
    addLog("æ–°çš„ä¸€å¤©é–‹å§‹äº†", "event");
    updateDisplay();
}

function closeModal() {
    document.querySelectorAll(".modal").forEach((modal) => {
        modal.style.display = "none";
    });
}

// æ–°å¢ç³»çµ±è³‡è¨ŠåŠŸèƒ½
function showSystemInfo() {
    if (!gameBridge) {
        alert("ç³»çµ±æ©‹æ¥å™¨æœªåˆå§‹åŒ–");
        return;
    }

    const info = gameBridge.getSystemInfo();
    const modal = document.getElementById("systemInfoModal");
    const content = document.getElementById("systemInfoContent");
    
    content.innerHTML = `
        <h4>ç³»çµ±æ¶æ§‹è³‡è¨Š</h4>
        <p><strong>ç‰ˆæœ¬:</strong> ${info.version}</p>
        <p><strong>æ¨¡å¼:</strong> ${info.mode}</p>
        
        <h4>DataManager</h4>
        <p><strong>ç‹€æ…‹:</strong> ${info.dataManager.available ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}</p>
        <p><strong>å·²è¼‰å…¥è³‡æ–™:</strong> ${info.dataManager.loadedTypes.join(', ') || 'ç„¡'}</p>
        
        <h4>RuleEngine</h4>
        <p><strong>ç‹€æ…‹:</strong> ${info.ruleEngine.available ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}</p>
        <p><strong>è¦å‰‡æ•¸é‡:</strong> ${info.ruleEngine.ruleCount}</p>
        
        <h4>éŠæˆ²ç‹€æ…‹</h4>
        <p><strong>ç•¶å‰å¤©æ•¸:</strong> ${gameState.day}</p>
        <p><strong>ç¾é‡‘:</strong> $${gameState.resources.cash}</p>
        <p><strong>ç§Ÿå®¢æ•¸é‡:</strong> ${gameState.rooms.filter(r => r.tenant).length}</p>
    `;
    
    modal.style.display = "block";
}

// ==================== éŠæˆ²å•Ÿå‹• ====================
// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–éŠæˆ²
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ® æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨ - é‡æ§‹ç‰ˆå•Ÿå‹•');
    initializeGame();
    
    // åˆå§‹åŒ–éŠæˆ²è¨˜éŒ„
    addLog("æ­¡è¿ä¾†åˆ°æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨é‡æ§‹ç‰ˆï¼", "event");
    addLog("ç•¶å‰ä½¿ç”¨å…ˆé€²çš„æ··åˆæ¶æ§‹ç³»çµ±", "event");
    addLog("é»æ“Šå³ä¸Šè§’ç³»çµ±ç‹€æ…‹æŸ¥çœ‹è©³ç´°è³‡è¨Š", "event");
});
</script>
</body>
</html>