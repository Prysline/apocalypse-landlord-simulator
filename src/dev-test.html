<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>末日房東模擬器 - 開發測試環境 v2.0</title>
    <style>
      /* 基礎樣式 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Courier New", monospace;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f4c75 100%
        );
        color: #e0e0e0;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* 頂部狀態列 */
      .status-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #333;
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
      }

      /* 適應 main.js 生成的 systemStatus 元素 */
      #systemStatus {
        position: fixed !important;
        top: 70px !important;
        right: 10px !important;
        z-index: 1001 !important;
        padding: 8px 12px !important;
        border-radius: 6px !important;
        font-size: 12px !important;
        font-weight: bold !important;
        background: rgba(0, 0, 0, 0.9) !important;
        color: white !important;
        border: 1px solid #333 !important;
        backdrop-filter: blur(5px) !important;
        max-width: 300px !important;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .status-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        transition: all 0.3s ease;
        position: relative;
      }

      .status-dot.success {
        background: #4ade80;
        box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
      }

      .status-dot.warning {
        background: #fbbf24;
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
      }

      .status-dot.error {
        background: #ef4444;
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
      }

      .status-text {
        font-size: 14px;
        font-weight: bold;
      }

      .version-info {
        font-size: 12px;
        color: #888;
      }

      /* 主要內容區域 */
      .main-container {
        padding-top: 80px;
        padding: 80px 20px 20px;
        min-height: 100vh;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto 1fr;
        gap: 20px;
        height: calc(100vh - 100px);
      }

      /* 左側控制區域 */
      .left-panel {
        grid-column: 1;
        grid-row: 1 / -1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* 右側分割 */
      .right-panel {
        grid-column: 2;
        grid-row: 1 / -1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* 系統資訊面板（右上） */
      .system-info {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        flex-shrink: 0;
      }

      /* 日誌面板（右下） */
      .log-panel {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 400px;
      }

      /* 控制面板 */
      .control-panel {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        flex: 1;
      }

      .panel-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #60a5fa;
        border-bottom: 1px solid rgba(96, 165, 250, 0.3);
        padding-bottom: 8px;
      }

      .control-buttons {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .button-group {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
      }

      .group-title {
        font-size: 12px;
        font-weight: bold;
        color: #60a5fa;
        margin-bottom: 8px;
        padding-bottom: 3px;
        border-bottom: 1px solid rgba(96, 165, 250, 0.3);
      }

      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .button-group .btn {
        flex: 1;
        min-width: 120px;
        font-size: 11px;
        padding: 6px 10px;
      }

      /* 確保按鈕在小螢幕上也能正常顯示 */
      @media (max-width: 768px) {
        .button-row {
          flex-direction: column;
        }

        .button-group .btn {
          min-width: auto;
          width: 100%;
        }
      }

      .btn {
        padding: 8px 16px;
        background: linear-gradient(145deg, #374151, #4b5563);
        border: none;
        border-radius: 6px;
        color: #e0e0e0;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
        font-family: inherit;
      }

      .btn:hover {
        background: linear-gradient(145deg, #4b5563, #6b7280);
        transform: translateY(-1px);
      }

      .btn.primary {
        background: linear-gradient(145deg, #3b82f6, #2563eb);
      }

      .btn.success {
        background: linear-gradient(145deg, #10b981, #059669);
      }

      .btn.warning {
        background: linear-gradient(145deg, #f59e0b, #d97706);
      }

      /* 系統分組按鈕樣式 */
      .btn.resource-test {
        background: linear-gradient(145deg, #8b5cf6, #7c3aed);
        border-left: 3px solid #a855f7;
      }

      .btn.trade-test {
        background: linear-gradient(145deg, #06b6d4, #0891b2);
        border-left: 3px solid #0ea5e9;
      }

      .btn.tenant-test {
        background: linear-gradient(145deg, #10b981, #059669);
        border-left: 3px solid #34d399;
      }

      .btn.event-test {
        background: linear-gradient(145deg, #f59e0b, #d97706);
        border-left: 3px solid #fbbf24;
      }

      .btn.diagnostic {
        background: linear-gradient(145deg, #ec4899, #db2777);
        border-left: 3px solid #f472b6;
      }

      .btn.diagnostic:hover {
        background: linear-gradient(145deg, #db2777, #be185d);
        box-shadow: 0 0 15px rgba(236, 72, 153, 0.4);
      }

      /* 系統資訊面板 */
      .system-info {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .info-item {
        background: rgba(0, 0, 0, 0.2);
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #60a5fa;
      }

      .info-label {
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .info-value {
        font-size: 14px;
        font-weight: bold;
        margin-top: 4px;
      }

      /* 日誌區域 */
      .log-panel {
        grid-column: 1 / -1;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .log-controls {
        display: flex;
        gap: 10px;
      }

      .log-content {
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid #333;
        border-radius: 6px;
        padding: 15px;
        flex: 1;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.4;
        min-height: 200px;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 6px 10px;
        border-radius: 4px;
        border-left: 3px solid transparent;
      }

      .log-entry.info {
        border-left-color: #60a5fa;
        background: rgba(96, 165, 250, 0.1);
      }

      .log-entry.success {
        border-left-color: #4ade80;
        background: rgba(74, 222, 128, 0.1);
      }

      .log-entry.warning {
        border-left-color: #fbbf24;
        background: rgba(251, 191, 36, 0.1);
      }

      .log-entry.error {
        border-left-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }

      .log-entry.diagnostic {
        border-left-color: #ec4899;
        background: rgba(236, 72, 153, 0.1);
      }

      .log-timestamp {
        color: #6b7280;
        margin-right: 10px;
      }

      /* 載入動畫 */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        transition: opacity 0.5s ease;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(96, 165, 250, 0.3);
        border-top: 3px solid #60a5fa;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .loading-text {
        color: #60a5fa;
        font-size: 16px;
        margin-bottom: 10px;
      }

      .loading-details {
        color: #9ca3af;
        font-size: 12px;
        text-align: center;
        max-width: 400px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* 響應式設計 */
      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto 1fr;
        }

        .status-bar {
          flex-direction: column;
          height: auto;
          padding: 10px;
        }

        .main-container {
          padding-top: 120px;
        }
      }
    </style>
  </head>
  <body>
    <!-- 載入覆蓋層 -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">初始化模組化系統</div>
      <div class="loading-details">
        正在載入核心架構：DataManager + GameState + EventBus<br />
        並行載入配置檔案：rules.json, tenants.json, skills.json, events.json
      </div>
    </div>

    <!-- 頂部狀態列 -->
    <div class="status-bar">
      <div class="status-indicator">
        <div id="statusDot" class="status-dot error"></div>
        <span id="statusText" class="status-text">系統初始化中...</span>
      </div>
      <div class="version-info">
        末日房東模擬器 v2.0-beta | 開發測試環境<br />
        <small style="color: #666"
          >上方顯示 main.js 系統狀態，下方為開發控制台</small
        >
      </div>
    </div>

    <!-- 主要內容區域 -->
    <div class="main-container">
      <div class="dashboard-grid">
        <!-- 左側面板：控制區域 -->
        <div class="left-panel">
          <!-- 控制面板 -->
          <div class="control-panel">
            <div class="panel-title">🎮 模組化系統測試控制台</div>
            <div
              style="
                margin-bottom: 15px;
                font-size: 11px;
                color: #888;
                line-height: 1.4;
              "
            >
              <strong>系統分類測試</strong
              >：按照模組架構分組，每個系統獨立測試區域<br />
              <strong>實際函數驗證</strong
              >：所有測試直接調用真實的系統API函數<br />
              <strong>完整錯誤處理</strong
              >：包含參數驗證、狀態檢查、異常捕獲機制<br /><br />
              <strong>🏗️ 核心系統</strong>：整合測試、狀態查詢、除錯資訊<br />
              <strong>💎 ResourceManager</strong
              >：資源修改、轉移、採集系統<br />
              <strong>🏪 TradeManager</strong
              >：租金收取、商隊交易、互助機制<br />
              <strong>👥 TenantManager</strong
              >：租客雇用、搜刮派遣、滿意度管理<br />
              <strong>📡 EventBus</strong>：事件通信測試、統計查詢<br />
              <strong>🛠️ 開發工具</strong>：遊戲推進、狀態匯出、日誌管理
            </div>
            <div class="control-buttons">
              <!-- =================== 核心系統測試 =================== -->
              <div class="button-group">
                <div class="group-title">🏗️ 核心系統</div>
                <div class="button-row">
                  <button class="btn primary" onclick="runSystemTests()">
                    🧪 系統測試
                  </button>
                  <button class="btn" onclick="showSystemStatus()">
                    📊 系統狀態
                  </button>
                  <button class="btn" onclick="showDebugInfo()">
                    🔧 除錯資訊
                  </button>
                </div>
              </div>

              <!-- =================== ResourceManager 測試 =================== -->
              <div class="button-group">
                <div class="group-title">💎 ResourceManager</div>
                <div class="button-row">
                  <button
                    class="btn resource-test"
                    onclick="testResourceModify()"
                  >
                    💎 資源修改
                  </button>
                  <button
                    class="btn resource-test"
                    onclick="testResourceTransfer()"
                  >
                    🔄 資源轉移
                  </button>
                  <button
                    class="btn resource-test"
                    onclick="testHarvestSystem()"
                  >
                    🌱 院子採集
                  </button>
                </div>
              </div>

              <!-- =================== TradeManager 測試 =================== -->
              <div class="button-group">
                <div class="group-title">🏪 TradeManager</div>
                <div class="button-row">
                  <button class="btn trade-test" onclick="testRentCollection()">
                    🏠 租金收取
                  </button>
                  <button class="btn trade-test" onclick="testCaravanTrade()">
                    🚛 商隊交易
                  </button>
                  <button class="btn trade-test" onclick="testMutualAid()">
                    🤝 互助系統
                  </button>
                </div>
              </div>

              <!-- =================== TenantManager 測試 =================== -->
              <div class="button-group">
                <div class="group-title">👥 TenantManager</div>
                <div class="button-row">
                  <button class="btn tenant-test" onclick="testTenantHiring()">
                    👤 租客雇用
                  </button>
                  <button
                    class="btn tenant-test"
                    onclick="testTenantScavenge()"
                  >
                    🔍 搜刮派遣
                  </button>
                  <button
                    class="btn tenant-test"
                    onclick="testTenantSatisfaction()"
                  >
                    😊 滿意度系統
                  </button>
                </div>
              </div>

              <!-- =================== EventBus 測試 =================== -->
              <div class="button-group">
                <div class="group-title">📡 EventBus</div>
                <div class="button-row">
                  <button
                    class="btn event-test"
                    onclick="testEventCommunication()"
                  >
                    📡 事件通信
                  </button>
                  <button class="btn event-test" onclick="showEventStats()">
                    📈 事件統計
                  </button>
                </div>
                <div class="button-row" style="margin-top: 8px">
                  <button class="btn diagnostic" onclick="runOnceDiagnostic()">
                    🔬 once() 修復驗證
                  </button>
                  <button class="btn diagnostic" onclick="runOnceStressTest()">
                    ⚡ 壓力測試
                  </button>
                </div>
              </div>

              <!-- =================== 開發工具 =================== -->
              <div class="button-group">
                <div class="group-title">🛠️ 開發工具</div>
                <div class="button-row">
                  <button class="btn" onclick="advanceGameDay()">
                    ⏭️ 推進一天
                  </button>
                  <button class="btn" onclick="exportGameState()">
                    💾 匯出狀態
                  </button>
                  <button class="btn success" onclick="clearLogs()">
                    🗑️ 清除日誌
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 右側面板：監控和日誌 -->
        <div class="right-panel">
          <!-- 系統資訊面板（右上） -->
          <div class="system-info">
            <div class="panel-title">📊 模組化架構監控</div>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">系統運行模式</div>
                <div id="systemMode" class="info-value">載入中...</div>
              </div>
              <div class="info-item">
                <div class="info-label">已載入模組</div>
                <div id="loadedModules" class="info-value">0 / 6</div>
              </div>
              <div class="info-item">
                <div class="info-label">EventBus事件</div>
                <div id="eventCount" class="info-value">0</div>
              </div>
              <div class="info-item">
                <div class="info-label">GameState變更</div>
                <div id="stateChanges" class="info-value">0</div>
              </div>
              <div class="info-item">
                <div class="info-label">資源總價值</div>
                <div id="totalResources" class="info-value">計算中...</div>
              </div>
              <div class="info-item">
                <div class="info-label">租客管理</div>
                <div id="tenantCount" class="info-value">0 / 5</div>
              </div>
            </div>
          </div>

          <!-- 日誌面板（右下） -->
          <div class="log-panel">
            <div class="log-header">
              <div class="panel-title">📋 系統測試執行日誌</div>
              <div class="log-controls">
                <button class="btn" onclick="exportLogs()">匯出日誌</button>
                <button class="btn" onclick="toggleAutoScroll()">
                  自動滾動
                </button>
              </div>
            </div>
            <div id="logContent" class="log-content">
              <div class="log-entry info">
                <span class="log-timestamp">[00:00:00]</span>
                開發測試環境啟動中...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // 全域變數
      let gameApp = null;
      let autoScroll = true;
      let updateInterval = null;

      /**
       * 應用程式初始化
       */
      async function initializeApp() {
        try {
          updateLoadingText("載入應用程式核心...");

          // 動態載入 main.js
          const mainModule = await import("./js/main.js");

          // 等待應用程式初始化
          await new Promise((resolve) => {
            const checkApp = () => {
              if (window.gameApp && window.gameApp.isInitialized) {
                gameApp = window.gameApp;
                resolve();
              } else {
                setTimeout(checkApp, 100);
              }
            };
            checkApp();
          });

          // 隱藏載入覆蓋層
          const loadingOverlay = document.getElementById("loadingOverlay");
          loadingOverlay.style.opacity = "0";
          setTimeout(() => {
            loadingOverlay.style.display = "none";
          }, 500);

          // 初始化 UI
          initializeUI();
          initializeDiagnosticTool();

          // 開始定期更新
          startPeriodicUpdates();

          addLog("系統初始化完成", "success");
        } catch (error) {
          console.error("初始化失敗:", error);
          updateSystemStatus("error", "初始化失敗: " + error.message);
          addLog("初始化失敗: " + error.message, "error");
        }
      }

      /**
       * 初始化 UI 介面
       */
      function initializeUI() {
        if (!gameApp) {
          updateSystemStatus("error", "遊戲應用程式未載入");
          return;
        }

        // 監聽遊戲狀態變化
        if (gameApp.eventBus) {
          gameApp.eventBus.on("log_added", (event) => {
            if (event.data && event.data.message) {
              addLog(event.data.message, event.data.type || "info");
            }
          });

          gameApp.eventBus.on("state_changed", () => {
            updateSystemInfo();
          });

          gameApp.eventBus.on("system_ready", () => {
            addLog("系統就緒事件接收", "success");
            updateSystemInfo();
          });
        }

        // 監控 main.js 生成的 systemStatus 元素變化
        const observeMainSystemStatus = () => {
          const mainStatusElement = document.getElementById("systemStatus");
          if (mainStatusElement) {
            addLog("檢測到 main.js 系統狀態元素", "info");

            // 創建變化觀察器
            const observer = new MutationObserver((mutations) => {
              mutations.forEach((mutation) => {
                if (
                  mutation.type === "childList" ||
                  mutation.type === "characterData"
                ) {
                  updateSystemInfo(); // 當 main.js 狀態變化時同步更新
                }
              });
            });

            observer.observe(mainStatusElement, {
              childList: true,
              subtree: true,
              characterData: true,
            });
          }
        };

        // 延遲觀察，等待 main.js 創建狀態元素
        setTimeout(observeMainSystemStatus, 1000);

        // 更新初始狀態
        updateSystemStatus("success", "開發環境 v2.0 - 運行中");
        updateSystemInfo();
      }

      /**
       * 開始定期更新
       */
      function startPeriodicUpdates() {
        updateInterval = setInterval(() => {
          if (gameApp && gameApp.isInitialized) {
            updateSystemInfo();
          }
        }, 5000); // 每 5 秒更新一次
      }

      /**
       * 更新載入文字
       */
      function updateLoadingText(text, details = "") {
        const loadingText = document.querySelector(".loading-text");
        const loadingDetails = document.querySelector(".loading-details");
        if (loadingText) loadingText.textContent = text;
        if (loadingDetails && details) loadingDetails.innerHTML = details;
      }

      /**
       * 更新系統狀態指示器
       */
      function updateSystemStatus(status, message) {
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");

        statusDot.className = `status-dot ${status}`;
        statusText.textContent = message;
      }

      /**
       * 更新系統資訊面板
       */
      function updateSystemInfo() {
        if (!gameApp) return;

        try {
          // 檢查 main.js 生成的 systemStatus 元素
          const mainSystemStatus = document.getElementById("systemStatus");
          let systemMode = gameApp.systemMode || "未知";

          // 如果 main.js 的狀態元素存在，從中解析模式
          if (mainSystemStatus && mainSystemStatus.textContent) {
            const statusText = mainSystemStatus.textContent;
            if (statusText.includes("🟢")) {
              systemMode = "正常模式";
              updateSystemStatus("success", "開發環境 v2.0 - 運行中");
            } else if (statusText.includes("🟡")) {
              systemMode = "後備模式";
              updateSystemStatus("warning", "開發環境 v2.0 - 後備模式");
            } else if (statusText.includes("🔴")) {
              systemMode = "錯誤狀態";
              updateSystemStatus("error", "系統發生錯誤");
            }
          }

          document.getElementById("systemMode").textContent = systemMode;

          // 載入的模組數量
          const status = gameApp.getStatus();
          let moduleCount = 0;
          if (status.dataManager) moduleCount++;
          if (status.gameState) moduleCount++;
          if (status.eventBus) moduleCount++;
          if (status.resourceManager) moduleCount++;
          if (status.tradeManager) moduleCount++;
          if (status.tenantManager) moduleCount++;

          document.getElementById(
            "loadedModules"
          ).textContent = `${moduleCount} / 6`;

          // 事件總數
          if (status.eventBus && status.eventBus.totalEmitted) {
            document.getElementById("eventCount").textContent =
              status.eventBus.totalEmitted;
          }

          // 狀態變更數量
          if (status.gameState && status.gameState.totalChanges) {
            document.getElementById("stateChanges").textContent =
              status.gameState.totalChanges;
          }

          // 資源總值
          if (gameApp.gameState) {
            const resources = gameApp.gameState.getState().resources || {};
            const total = Object.values(resources).reduce(
              (sum, val) => sum + (val || 0),
              0
            );
            document.getElementById("totalResources").textContent =
              total.toString();
          }

          // 租客數量
          if (gameApp.gameState) {
            const tenants = gameApp.gameState.getAllTenants() || [];
            const rooms = gameApp.gameState.getState().rooms || [];
            document.getElementById(
              "tenantCount"
            ).textContent = `${tenants.length} / ${rooms.length}`;
          }
        } catch (error) {
          console.error("更新系統資訊失敗:", error);
          addLog("更新系統資訊失敗: " + error.message, "error");
        }
      }

      /**
       * 添加日誌條目
       */
      function addLog(message, type = "info") {
        const logContent = document.getElementById("logContent");
        const timestamp = new Date().toLocaleTimeString();

        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${type}`;
        logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                ${message}
            `;

        logContent.appendChild(logEntry);

        // 自動滾動到底部
        if (autoScroll) {
          logContent.scrollTop = logContent.scrollHeight;
        }

        // 限制日誌數量，避免記憶體問題
        if (logContent.children.length > 1000) {
          logContent.removeChild(logContent.firstChild);
        }
      }

      // 全域函數（供按鈕調用）
      window.runSystemTests = async function () {
        if (!gameApp) {
          addLog("遊戲應用程式未初始化", "error");
          return;
        }

        try {
          addLog("開始執行系統測試...", "info");
          await gameApp.runTests();
          addLog("系統測試完成", "success");
          updateSystemInfo();
        } catch (error) {
          addLog("系統測試失敗: " + error.message, "error");
        }
      };

      window.showSystemStatus = function () {
        if (!gameApp) {
          addLog("遊戲應用程式未初始化", "error");
          return;
        }

        const status = gameApp.getStatus();
        addLog("=== 系統狀態 ===", "info");
        addLog(`初始化狀態: ${status.initialized}`, "info");
        addLog(`系統模式: ${gameApp.systemMode}`, "info");
        addLog(
          `資料管理器: ${status.dataManager ? "正常" : "異常"}`,
          status.dataManager ? "success" : "error"
        );
        addLog(
          `遊戲狀態: ${status.gameState ? "正常" : "異常"}`,
          status.gameState ? "success" : "error"
        );
        addLog(
          `事件系統: ${status.eventBus ? "正常" : "異常"}`,
          status.eventBus ? "success" : "error"
        );
        addLog("=== 狀態檢查完成 ===", "info");
      };

      window.showDebugInfo = function () {
        if (!gameApp) {
          addLog("遊戲應用程式未初始化", "error");
          return;
        }

        addLog("詳細除錯資訊已輸出到控制台", "info");
        gameApp.debug();
      };

      // ========================================
      // TenantManager 測試函數
      // ========================================

      window.testTenantHiring = function () {
        if (!gameApp || !gameApp.tenantManager) {
          addLog("TenantManager 未初始化", "error");
          return;
        }

        try {
          addLog("=== TenantManager 雇用測試 ===", "info");

          // 生成申請者
          const applicants = gameApp.tenantManager.generateApplicants(3);
          addLog(`生成申請者: ${applicants.length}位`, "success");

          applicants.forEach((applicant, index) => {
            addLog(
              `  ${index + 1}. ${applicant.name} (${applicant.type}) - ${
                applicant.appearance
              }`,
              "info"
            );
          });

          if (applicants.length > 0) {
            const selectedApplicant = applicants[0];
            addLog(`選擇申請者: ${selectedApplicant.name}`, "info");

            // 檢查空房間
            const emptyRooms = gameApp.tenantManager.getEmptyRooms();
            addLog(`可用房間: ${emptyRooms.length}間`, "info");

            if (emptyRooms.length > 0) {
              // 執行雇用
              gameApp.tenantManager
                .hireTenant(selectedApplicant)
                .then((result) => {
                  if (result.success) {
                    addLog(
                      `雇用成功: ${result.tenant.name} 入住房間 ${result.roomId}`,
                      "success"
                    );
                    addLog(`租金: ${result.tenant.rent}/天`, "info");
                  } else {
                    addLog(`雇用失敗: ${result.error}`, "error");
                  }
                  updateSystemInfo();
                })
                .catch((error) => {
                  addLog("雇用異常: " + error.message, "error");
                });
            } else {
              addLog("無可用房間，無法進行雇用測試", "warning");
            }
          }
        } catch (error) {
          addLog("租客雇用測試失敗: " + error.message, "error");
        }
      };

      window.testTenantScavenge = function () {
        if (!gameApp || !gameApp.tenantManager) {
          addLog("TenantManager 未初始化", "error");
          return;
        }

        try {
          addLog("=== TenantManager 搜刮測試 ===", "info");

          // 檢查可用搜刮者
          const scavengers = gameApp.tenantManager.getAvailableScavengers
            ? gameApp.tenantManager.getAvailableScavengers()
            : [];

          addLog(`可用搜刮者: ${scavengers.length}位`, "info");

          if (scavengers.length === 0) {
            addLog("無可用搜刮者，檢查所有租客...", "warning");
            const allTenants = gameApp.gameState
              ? gameApp.gameState.getAllTenants()
              : [];
            addLog(`總租客數: ${allTenants.length}`, "info");

            if (allTenants.length === 0) {
              addLog("無租客可進行搜刮測試", "warning");
              return;
            }
          }

          // 檢查搜刮狀態
          const scavengeUsed = gameApp.gameState
            ? gameApp.gameState.getStateValue("dailyActions.scavengeUsed", 0)
            : 0;
          const maxScavenge = 2; // 預設最大搜刮次數

          addLog(`搜刮使用狀況: ${scavengeUsed}/${maxScavenge}`, "info");

          if (scavengeUsed >= maxScavenge) {
            addLog("今日搜刮次數已用完，重置以進行測試...", "warning");
            if (gameApp.gameState) {
              gameApp.gameState.setStateValue(
                "dailyActions.scavengeUsed",
                0,
                "測試重置"
              );
            }
          }

          // 選擇第一個可用的搜刮者進行測試
          const targetTenant =
            scavengers.length > 0
              ? scavengers[0]
              : gameApp.gameState
              ? gameApp.gameState.getAllTenants()[0]
              : null;

          if (targetTenant) {
            addLog(`派遣 ${targetTenant.name} 進行搜刮...`, "info");

            // 執行搜刮派遣
            if (gameApp.tenantManager.sendTenantScavenging) {
              gameApp.tenantManager
                .sendTenantScavenging(targetTenant.id)
                .then((result) => {
                  if (result.success) {
                    addLog(`搜刮成功！`, "success");
                    if (result.rewards) {
                      addLog(
                        `獲得獎勵: ${JSON.stringify(result.rewards)}`,
                        "success"
                      );
                    }
                    if (result.experience) {
                      addLog(`經驗提升: +${result.experience}`, "info");
                    }
                  } else {
                    addLog(
                      `搜刮失敗: ${result.error || result.reason}`,
                      "error"
                    );
                  }
                  updateSystemInfo();
                })
                .catch((error) => {
                  addLog("搜刮異常: " + error.message, "error");
                });
            } else {
              addLog("搜刮功能未實作", "warning");
            }
          }
        } catch (error) {
          addLog("搜刮測試失敗: " + error.message, "error");
        }
      };

      window.testTenantSatisfaction = function () {
        if (!gameApp || !gameApp.tenantManager) {
          addLog("TenantManager 未初始化", "error");
          return;
        }

        try {
          addLog("=== TenantManager 滿意度測試 ===", "info");

          // 獲取租客統計
          const stats = gameApp.tenantManager.getTenantStats();
          addLog(`租客統計:`, "info");
          addLog(`  總租客數: ${stats.totalTenants}`, "info");
          addLog(`  健康租客: ${stats.healthyTenants}`, "success");
          addLog(
            `  感染租客: ${stats.infectedTenants}`,
            stats.infectedTenants > 0 ? "warning" : "success"
          );
          addLog(
            `  平均滿意度: ${stats.averageSatisfaction?.toFixed(1) || "N/A"}`,
            "info"
          );
          addLog(`  總租金收入: ${stats.totalRentIncome}`, "info");

          // 顯示職業分布
          if (stats.typeDistribution) {
            addLog(`職業分布:`, "info");
            Object.entries(stats.typeDistribution).forEach(([type, count]) => {
              if (count > 0) {
                addLog(`  ${type}: ${count}位`, "info");
              }
            });
          }

          // 獲取所有滿意度
          const satisfactionMap = gameApp.tenantManager.getAllSatisfaction();
          if (satisfactionMap && satisfactionMap.size > 0) {
            addLog(`個別滿意度:`, "info");
            satisfactionMap.forEach((satisfaction, tenantId) => {
              const tenant = this.tenantManager.findTenantAndRoom(tenantId).tenant
              const level =
                satisfaction >= 80
                  ? "😁極好"
                  : satisfaction >= 60
                  ? "😊良好"
                  : satisfaction >= 40
                  ? "😐普通"
                  : satisfaction >= 20
                  ? "😟不滿"
                  : "😠憤怒";
              addLog(`  ${tenant.name}: ${satisfaction} ${level}`, "info");
            });
          }

          // 測試滿意度更新
          addLog("執行滿意度更新...", "info");
          gameApp.tenantManager.updateTenantSatisfaction();
          addLog("滿意度更新完成", "success");

          updateSystemInfo();
        } catch (error) {
          addLog("滿意度測試失敗: " + error.message, "error");
        }
      };

      // ========================================
      // EventBus 測試函數（含 once() 問題診斷）
      // ========================================

      window.testEventCommunication = function () {
        if (!gameApp || !gameApp.eventBus) {
          addLog("EventBus 未初始化", "error");
          return;
        }

        try {
          addLog("=== EventBus 基本通信測試 ===", "info");

          let testResults = {
            basicEmit: false,
            onceListener: false,
            regularListener: false,
            dataTransfer: false,
          };

          // 測試基本事件發送
          gameApp.eventBus.emit("dev_test_basic", { test: "basic" });
          testResults.basicEmit = true;
          addLog("基本事件發送: ✅成功", "success");

          // 測試一次性監聽器
          gameApp.eventBus.once("dev_test_once", (eventObj) => {
            testResults.onceListener = true;
            testResults.dataTransfer =
              eventObj.data && eventObj.data.message === "test_data";
            addLog("一次性監聽器: ✅觸發", "success");
            addLog(
              `數據傳輸: ${testResults.dataTransfer ? "✅正確" : "❌錯誤"}`,
              testResults.dataTransfer ? "success" : "error"
            );
          });

          // 觸發一次性監聽器
          gameApp.eventBus.emit("dev_test_once", { message: "test_data" });

          // 測試常規監聽器
          const unsubscribe = gameApp.eventBus.on(
            "dev_test_regular",
            (eventObj) => {
              testResults.regularListener = true;
              addLog("常規監聽器: ✅觸發", "success");
            }
          );

          gameApp.eventBus.emit("dev_test_regular", { regular: true });

          if (typeof unsubscribe === "function") {
            unsubscribe();
            addLog("監聽器清理: ✅完成", "success");
          }

          // 統計結果
          const successCount =
            Object.values(testResults).filter(Boolean).length;
          addLog(
            `測試結果: ${successCount}/4 項成功`,
            successCount === 4 ? "success" : "warning"
          );
        } catch (error) {
          addLog("事件通信測試失敗: " + error.message, "error");
        }
      };

      /**
       * EventBus once() 修復驗證工具
       */
      class EventBusOnceDiagnostic {
        constructor() {
          this.testResults = [];
        }

        /**
         * 執行快速診斷：驗證修復效果
         */
        async runQuickDiagnostic(eventBus) {
          addLog("🔬 開始 EventBus once() 修復驗證...", "diagnostic");

          let callCount = 0;
          const testEventName = "diagnostic_once_test";

          // 測試監聽器
          const testListener = (eventObj) => {
            callCount++;
            addLog(
              `[驗證] once() 監聽器第 ${callCount} 次調用 (事件ID: ${eventObj.id})`,
              "diagnostic"
            );
          };

          // 註冊一次性監聽器
          addLog("註冊 once() 監聽器...", "info");
          eventBus.once(testEventName, testListener);

          // 快速連續觸發（修復前會重複執行，修復後只執行一次）
          addLog("快速連續觸發 3 次事件...", "diagnostic");
          eventBus.emit(testEventName, { test: "trigger_1" });
          eventBus.emit(testEventName, { test: "trigger_2" });
          eventBus.emit(testEventName, { test: "trigger_3" });

          // 等待處理完成
          await new Promise((resolve) => setTimeout(resolve, 50));

          // 評估結果
          const isFixed = callCount === 1;
          const resultMessage = isFixed
            ? `✅ 修復驗證成功：once() 監聽器僅執行 1 次`
            : `❌ 修復驗證失敗：once() 監聽器執行了 ${callCount} 次`;

          addLog(resultMessage, isFixed ? "success" : "error");

          if (isFixed) {
            addLog("🎉 EventBus once() 時序競爭條件已修復", "success");
          } else {
            addLog(
              "⚠️  once() 仍存在重複執行問題，建議檢查修復實作",
              "warning"
            );
          }

          return { isFixed, callCount, testEventName };
        }

        /**
         * 執行壓力測試：大量並發觸發
         */
        async runStressTest(eventBus) {
          addLog("⚡ 開始 EventBus once() 壓力測試...", "diagnostic");

          const results = [];
          const testCount = 10; // 測試 10 個不同的 once() 監聽器

          for (let i = 0; i < testCount; i++) {
            const eventName = `stress_test_${i}`;
            let callCount = 0;

            // 為每個測試創建監聽器
            eventBus.once(eventName, () => {
              callCount++;
            });

            // 對每個事件進行高頻觸發
            for (let j = 0; j < 5; j++) {
              eventBus.emit(eventName, { stress: true, round: j });
            }

            results.push({ eventName, callCount });
          }

          // 等待所有事件處理完成
          await new Promise((resolve) => setTimeout(resolve, 100));

          // 分析結果
          const failedTests = results.filter((r) => r.callCount !== 1);
          const successRate = (
            ((testCount - failedTests.length) / testCount) *
            100
          ).toFixed(1);

          addLog(
            `壓力測試完成：${testCount} 個測試中有 ${
              testCount - failedTests.length
            } 個成功`,
            "info"
          );
          addLog(
            `成功率：${successRate}%`,
            successRate === "100.0" ? "success" : "warning"
          );

          if (failedTests.length > 0) {
            addLog(`失敗的測試：`, "error");
            failedTests.forEach((test) => {
              addLog(`  ${test.eventName}: 執行 ${test.callCount} 次`, "error");
            });
          } else {
            addLog("🎉 所有壓力測試通過，once() 修復穩定", "success");
          }

          return { successRate, failedTests, totalTests: testCount };
        }
      }

      // 創建診斷工具實例
      let onceDiagnostic = null;

      /**
       * 初始化診斷工具（在現有的 initializeApp 函數中調用）
       */
      function initializeDiagnosticTool() {
        onceDiagnostic = new EventBusOnceDiagnostic();
        addLog("EventBus once() 診斷工具已初始化", "diagnostic");
      }

      /**
       * 執行 once() 修復驗證
       */
      window.runOnceDiagnostic = async function () {
        if (!gameApp || !gameApp.eventBus) {
          addLog("EventBus 未初始化，無法進行診斷", "error");
          return;
        }

        if (!onceDiagnostic) {
          addLog("診斷工具未初始化", "error");
          return;
        }

        try {
          const result = await onceDiagnostic.runQuickDiagnostic(
            gameApp.eventBus
          );
          addLog(`診斷完成，詳細結果請查看控制台`, "info");
          console.log("🔬 EventBus once() 診斷結果:", result);
        } catch (error) {
          addLog("診斷過程發生錯誤: " + error.message, "error");
        }
      };

      /**
       * 執行 once() 壓力測試
       */
      window.runOnceStressTest = async function () {
        if (!gameApp || !gameApp.eventBus) {
          addLog("EventBus 未初始化，無法執行壓力測試", "error");
          return;
        }

        if (!onceDiagnostic) {
          addLog("診斷工具未初始化", "error");
          return;
        }

        try {
          const result = await onceDiagnostic.runStressTest(gameApp.eventBus);
          addLog(`壓力測試完成，詳細結果請查看控制台`, "info");
          console.log("⚡ EventBus once() 壓力測試結果:", result);
        } catch (error) {
          addLog("壓力測試過程發生錯誤: " + error.message, "error");
        }
      };

      window.showEventStats = function () {
        if (!gameApp || !gameApp.eventBus) {
          addLog("EventBus 未初始化", "error");
          return;
        }

        try {
          addLog("=== EventBus 統計資訊 ===", "info");

          const stats = gameApp.eventBus.getStats();
          addLog(`事件統計:`, "info");

          if (stats.totalEmitted !== undefined) {
            addLog(`  總發送次數: ${stats.totalEmitted}`, "info");
          }

          if (stats.activeListeners !== undefined) {
            addLog(`  活躍監聽器: ${stats.activeListeners}`, "info");
          }

          if (stats.eventTypes !== undefined) {
            addLog(`  事件類型數: ${stats.eventTypes}`, "info");
          }

          // 基本狀態檢查
          addLog("EventBus 基本狀態:", "info");

          if (gameApp.eventBus.listeners) {
            addLog(
              `  監聽器映射: ${gameApp.eventBus.listeners.size} 個事件類型`,
              "info"
            );
          }

          if (gameApp.eventBus.eventHistory) {
            addLog(
              `  事件歷史: ${gameApp.eventBus.eventHistory.length} 條記錄`,
              "info"
            );
          }

          // 基本功能檢查
          const hasOnceMethod = typeof gameApp.eventBus.once === "function";
          const hasOnMethod = typeof gameApp.eventBus.on === "function";
          const hasEmitMethod = typeof gameApp.eventBus.emit === "function";

          addLog(
            `  基本方法: on=${hasOnMethod ? "✅" : "❌"} once=${
              hasOnceMethod ? "✅" : "❌"
            } emit=${hasEmitMethod ? "✅" : "❌"}`,
            "info"
          );

          // 顯示其他統計
          Object.entries(stats).forEach(([key, value]) => {
            if (
              !["totalEmitted", "activeListeners", "eventTypes"].includes(key)
            ) {
              addLog(`  ${key}: ${value}`, "info");
            }
          });
        } catch (error) {
          addLog("EventBus 統計查詢失敗: " + error.message, "error");
        }
      };

      window.clearLogs = function () {
        const logContent = document.getElementById("logContent");
        logContent.innerHTML = "";
        addLog("日誌已清除", "success");
      };

      window.exportLogs = function () {
        const logContent = document.getElementById("logContent");
        const logs = Array.from(logContent.children)
          .map((entry) => entry.textContent)
          .join("\n");

        const blob = new Blob([logs], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `dev-logs-${new Date().toISOString().slice(0, 19)}.txt`;
        a.click();
        URL.revokeObjectURL(url);

        addLog("日誌已匯出", "success");
      };

      // ========================================
      // ResourceManager 測試函數
      // ========================================

      window.testResourceModify = function () {
        if (!gameApp || !gameApp.resourceManager) {
          addLog("ResourceManager 未初始化", "error");
          return;
        }

        try {
          addLog("=== ResourceManager 修改測試 ===", "info");

          // 測試單一資源修改
          const foodResult = gameApp.resourceManager.modifyResource(
            "food",
            10,
            "開發測試"
          );
          addLog(
            `單一修改食物 +10: ${foodResult ? "✅成功" : "❌失敗"}`,
            foodResult ? "success" : "error"
          );

          // 測試批量資源修改
          const bulkResult = gameApp.resourceManager.bulkModifyResources({
            changes: { materials: 5, medical: 3, cash: 25 },
            reason: "開發測試批量修改",
            source: "dev_test",
          });
          addLog(
            `批量修改資源: ${bulkResult ? "✅成功" : "❌失敗"}`,
            bulkResult ? "success" : "error"
          );

          // 測試資源檢查
          const hasEnough = gameApp.resourceManager.hasEnoughResource(
            "food",
            5
          );
          addLog(`資源檢查 食物≥5: ${hasEnough ? "✅充足" : "❌不足"}`, "info");

          // 測試資源狀態
          const foodStatus = gameApp.resourceManager.getResourceStatus("food");
          addLog(
            `食物狀態: ${foodStatus.level} (剩餘${foodStatus.daysRemaining}天)`,
            "info"
          );

          updateSystemInfo();
        } catch (error) {
          addLog("ResourceManager 測試失敗: " + error.message, "error");
        }
      };

      window.testResourceTransfer = function () {
        if (!gameApp || !gameApp.resourceManager) {
          addLog("ResourceManager 未初始化", "error");
          return;
        }

        try {
          addLog("=== ResourceManager 轉移測試 ===", "info");

          // 檢查是否有租客可以測試轉移
          const tenants = gameApp.gameState
            ? gameApp.gameState.getAllTenants()
            : [];

          if (tenants.length === 0) {
            addLog("無租客可測試轉移，先創建測試租客...", "warning");

            // 模擬創建一個測試租客用於轉移測試
            if (gameApp.gameState) {
              gameApp.gameState.setState(
                "tenants.0",
                {
                  name: "測試租客",
                  type: "worker",
                  personalResources: { food: 5, materials: 3, cash: 10 },
                },
                "測試租客創建"
              );
              addLog("測試租客已創建", "success");
            }
          }

          // 測試房東給租客轉移資源
          const transferResult = gameApp.resourceManager.transferResource(
            "landlord",
            "測試租客",
            { food: 3, materials: 2 },
            "開發測試轉移"
          );
          addLog(
            `房東→租客轉移: ${transferResult ? "✅成功" : "❌失敗"}`,
            transferResult ? "success" : "error"
          );

          updateSystemInfo();
        } catch (error) {
          addLog("資源轉移測試失敗: " + error.message, "error");
        }
      };

      window.testHarvestSystem = function () {
        if (!gameApp || !gameApp.resourceManager) {
          addLog("ResourceManager 未初始化", "error");
          return;
        }

        try {
          addLog("=== ResourceManager 採集測試 ===", "info");

          // 檢查採集狀態
          const harvestStatus = gameApp.resourceManager.getHarvestStatus();
          addLog(
            `採集可用性: ${harvestStatus.canHarvest ? "✅可用" : "❌不可用"}`,
            "info"
          );
          addLog(`今日已用: ${harvestStatus.usedToday ? "是" : "否"}`, "info");
          addLog(`冷卻剩餘: ${harvestStatus.cooldownRemaining}天`, "info");

          // 測試院子採集
          if (gameApp.resourceManager.canHarvest()) {
            const harvestResult = gameApp.resourceManager.harvestYard();
            addLog(
              `執行院子採集: ${harvestResult ? "✅成功" : "❌失敗"}`,
              harvestResult ? "success" : "error"
            );
          } else {
            addLog(
              "無法執行採集：" +
                (harvestStatus.usedToday ? "今日已使用" : "冷卻中"),
              "warning"
            );
          }

          updateSystemInfo();
        } catch (error) {
          addLog("採集系統測試失敗: " + error.message, "error");
        }
      };

      // ========================================
      // TradeManager 測試函數
      // ========================================

      window.testRentCollection = function () {
        if (!gameApp || !gameApp.tradeManager) {
          addLog("TradeManager 未初始化", "error");
          return;
        }

        try {
          addLog("=== TradeManager 租金收取測試 ===", "info");

          // 檢查是否今日已收取租金
          const rentCollected = gameApp.gameState
            ? gameApp.gameState.getStateValue(
                "dailyActions.rentCollected",
                false
              )
            : false;

          if (rentCollected) {
            addLog("今日已收取租金，重置狀態以進行測試...", "warning");
            if (gameApp.gameState) {
              gameApp.gameState.setStateValue(
                "dailyActions.rentCollected",
                false,
                "測試重置"
              );
            }
          }

          // 執行租金收取
          gameApp.tradeManager
            .processRentCollection()
            .then((result) => {
              if (result.success) {
                addLog(`租金收取成功！`, "success");
                addLog(`現金收入: ${result.totalCashRent}`, "success");
                addLog(`加成收入: ${result.bonusIncome}`, "success");
                addLog(`資源抵付: ${result.resourcePayments.length}筆`, "info");
                addLog(
                  `失敗支付: ${result.failedPayments.length}筆`,
                  result.failedPayments.length > 0 ? "warning" : "info"
                );
                if (result.summary) addLog(result.summary, "info");
              } else {
                addLog(
                  `租金收取失敗: ${result.error || result.reason}`,
                  "error"
                );
              }
              updateSystemInfo();
            })
            .catch((error) => {
              addLog("租金收取異常: " + error.message, "error");
            });
        } catch (error) {
          addLog("租金收取測試失敗: " + error.message, "error");
        }
      };

      window.testCaravanTrade = function () {
        if (!gameApp || !gameApp.tradeManager) {
          addLog("TradeManager 未初始化", "error");
          return;
        }

        try {
          addLog("=== TradeManager 商隊交易測試 ===", "info");

          // 獲取今日商隊選項
          const caravanOffers = gameApp.tradeManager.generateTodaysCaravanOffers
            ? gameApp.tradeManager.generateTodaysCaravanOffers()
            : {};

          const offerKeys = Object.keys(caravanOffers);
          addLog(`可用商隊選項: ${offerKeys.length}個`, "info");

          if (offerKeys.length > 0) {
            const firstOfferId = offerKeys[0];
            const offer = caravanOffers[firstOfferId];

            addLog(`測試選項: ${offer.description}`, "info");
            addLog(`需付出: ${JSON.stringify(offer.give)}`, "info");
            addLog(`可獲得: ${JSON.stringify(offer.receive)}`, "info");

            // 執行商隊交易
            gameApp.tradeManager
              .processCaravanTrade(firstOfferId)
              .then((result) => {
                addLog(
                  `商隊交易: ${result.success ? "✅成功" : "❌失敗"}`,
                  result.success ? "success" : "error"
                );
                if (result.error) addLog(`錯誤: ${result.error}`, "error");
                if (result.description) addLog(result.description, "info");
                updateSystemInfo();
              })
              .catch((error) => {
                addLog("商隊交易異常: " + error.message, "error");
              });
          } else {
            addLog("今日無商隊選項可測試", "warning");
          }
        } catch (error) {
          addLog("商隊交易測試失敗: " + error.message, "error");
        }
      };

      window.testMutualAid = function () {
        if (!gameApp || !gameApp.tradeManager) {
          addLog("TradeManager 未初始化", "error");
          return;
        }

        try {
          addLog("=== TradeManager 互助系統測試 ===", "info");

          // 檢查租客數量
          const tenants = gameApp.gameState
            ? gameApp.gameState.getAllTenants()
            : [];
          addLog(`當前租客數量: ${tenants.length}`, "info");

          if (tenants.length < 2) {
            addLog("互助系統需要至少2名租客", "warning");
            return;
          }

          // 執行互助系統
          gameApp.tradeManager
            .processMutualAid()
            .then((result) => {
              addLog(
                `互助系統: ${result.success ? "✅成功" : "❌失敗"}`,
                result.success ? "success" : "error"
              );
              if (result.transfers && result.transfers.length > 0) {
                addLog(`執行轉移: ${result.transfers.length}筆`, "success");
                result.transfers.forEach((transfer) => {
                  addLog(
                    `  ${transfer.from} → ${transfer.to}: ${JSON.stringify(
                      transfer.resources
                    )}`,
                    "info"
                  );
                });
              } else {
                addLog("無需進行互助轉移", "info");
              }
              updateSystemInfo();
            })
            .catch((error) => {
              addLog("互助系統異常: " + error.message, "error");
            });
        } catch (error) {
          addLog("互助系統測試失敗: " + error.message, "error");
        }
      };

      window.advanceGameDay = function () {
        if (!gameApp || !gameApp.gameState) {
          addLog("遊戲狀態未初始化", "error");
          return;
        }

        try {
          const currentDay = gameApp.gameState.getStateValue("day", 1);
          const newDay = currentDay + 1;

          gameApp.gameState.setState("day", newDay, "開發測試推進");
          gameApp.eventBus.emit("new_day", {
            newDay: newDay,
            previousDay: currentDay,
          });

          addLog(
            `遊戲天數推進: 第 ${currentDay} 天 → 第 ${newDay} 天`,
            "success"
          );
          updateSystemInfo();
        } catch (error) {
          addLog("推進遊戲天數失敗: " + error.message, "error");
        }
      };

      window.exportGameState = function () {
        if (!gameApp || !gameApp.gameState) {
          addLog("遊戲狀態未初始化", "error");
          return;
        }

        try {
          const gameState = gameApp.gameState.getState();
          const stateJson = JSON.stringify(gameState, null, 2);

          const blob = new Blob([stateJson], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `game-state-${new Date()
            .toISOString()
            .slice(0, 19)}.json`;
          a.click();
          URL.revokeObjectURL(url);

          addLog("遊戲狀態已匯出", "success");
        } catch (error) {
          addLog("匯出遊戲狀態失敗: " + error.message, "error");
        }
      };

      window.toggleAutoScroll = function () {
        autoScroll = !autoScroll;
        addLog(`自動滾動: ${autoScroll ? "啟用" : "停用"}`, "info");
      };

      // 頁面載入完成後初始化
      document.addEventListener("DOMContentLoaded", initializeApp);

      // 頁面卸載時清理
      window.addEventListener("beforeunload", () => {
        if (updateInterval) {
          clearInterval(updateInterval);
        }
      });
    </script>
  </body>
</html>
