<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨ - é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ v2.0</title>
    <style>
      /* åŸºç¤æ¨£å¼ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Courier New", monospace;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f4c75 100%
        );
        color: #e0e0e0;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* é ‚éƒ¨ç‹€æ…‹åˆ— */
      .status-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #333;
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
      }

      /* é©æ‡‰ main.js ç”Ÿæˆçš„ systemStatus å…ƒç´  */
      #systemStatus {
        position: fixed !important;
        top: 70px !important;
        right: 10px !important;
        z-index: 1001 !important;
        padding: 8px 12px !important;
        border-radius: 6px !important;
        font-size: 12px !important;
        font-weight: bold !important;
        background: rgba(0, 0, 0, 0.9) !important;
        color: white !important;
        border: 1px solid #333 !important;
        backdrop-filter: blur(5px) !important;
        max-width: 300px !important;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .status-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        transition: all 0.3s ease;
        position: relative;
      }

      .status-dot.success {
        background: #4ade80;
        box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
      }

      .status-dot.warning {
        background: #fbbf24;
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
      }

      .status-dot.error {
        background: #ef4444;
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
      }

      .status-text {
        font-size: 14px;
        font-weight: bold;
      }

      .version-info {
        font-size: 12px;
        color: #888;
      }

      /* ä¸»è¦å…§å®¹å€åŸŸ */
      .main-container {
        padding-top: 80px;
        padding: 80px 20px 20px;
        min-height: 100vh;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto 1fr;
        gap: 20px;
        height: calc(100vh - 100px);
      }

      /* å·¦å´æ§åˆ¶å€åŸŸ */
      .left-panel {
        grid-column: 1;
        grid-row: 1 / -1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* å³å´åˆ†å‰² */
      .right-panel {
        grid-column: 2;
        grid-row: 1 / -1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* ç³»çµ±è³‡è¨Šé¢æ¿ï¼ˆå³ä¸Šï¼‰ */
      .system-info {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        flex-shrink: 0;
      }

      /* æ—¥èªŒé¢æ¿ï¼ˆå³ä¸‹ï¼‰ */
      .log-panel {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 400px;
      }

      /* æ§åˆ¶é¢æ¿ */
      .control-panel {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        flex: 1;
      }

      .panel-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #60a5fa;
        border-bottom: 1px solid rgba(96, 165, 250, 0.3);
        padding-bottom: 8px;
      }

      .control-buttons {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .button-group {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
      }

      .group-title {
        font-size: 12px;
        font-weight: bold;
        color: #60a5fa;
        margin-bottom: 8px;
        padding-bottom: 3px;
        border-bottom: 1px solid rgba(96, 165, 250, 0.3);
      }

      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .button-group .btn {
        flex: 1;
        min-width: 120px;
        font-size: 11px;
        padding: 6px 10px;
      }

      /* ç¢ºä¿æŒ‰éˆ•åœ¨å°è¢å¹•ä¸Šä¹Ÿèƒ½æ­£å¸¸é¡¯ç¤º */
      @media (max-width: 768px) {
        .button-row {
          flex-direction: column;
        }

        .button-group .btn {
          min-width: auto;
          width: 100%;
        }
      }

      .btn {
        padding: 8px 16px;
        background: linear-gradient(145deg, #374151, #4b5563);
        border: none;
        border-radius: 6px;
        color: #e0e0e0;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
        font-family: inherit;
      }

      .btn:hover {
        background: linear-gradient(145deg, #4b5563, #6b7280);
        transform: translateY(-1px);
      }

      .btn.primary {
        background: linear-gradient(145deg, #3b82f6, #2563eb);
      }

      .btn.success {
        background: linear-gradient(145deg, #10b981, #059669);
      }

      .btn.warning {
        background: linear-gradient(145deg, #f59e0b, #d97706);
      }

      /* ç³»çµ±åˆ†çµ„æŒ‰éˆ•æ¨£å¼ */
      .btn.resource-test {
        background: linear-gradient(145deg, #8b5cf6, #7c3aed);
        border-left: 3px solid #a855f7;
      }

      .btn.trade-test {
        background: linear-gradient(145deg, #06b6d4, #0891b2);
        border-left: 3px solid #0ea5e9;
      }

      .btn.tenant-test {
        background: linear-gradient(145deg, #10b981, #059669);
        border-left: 3px solid #34d399;
      }

      .btn.event-test {
        background: linear-gradient(145deg, #f59e0b, #d97706);
        border-left: 3px solid #fbbf24;
      }

      .btn.diagnostic {
        background: linear-gradient(145deg, #ec4899, #db2777);
        border-left: 3px solid #f472b6;
      }

      .btn.diagnostic:hover {
        background: linear-gradient(145deg, #db2777, #be185d);
        box-shadow: 0 0 15px rgba(236, 72, 153, 0.4);
      }

      /* ç³»çµ±è³‡è¨Šé¢æ¿ */
      .system-info {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .info-item {
        background: rgba(0, 0, 0, 0.2);
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #60a5fa;
      }

      .info-label {
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .info-value {
        font-size: 14px;
        font-weight: bold;
        margin-top: 4px;
      }

      /* æ—¥èªŒå€åŸŸ */
      .log-panel {
        grid-column: 1 / -1;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .log-controls {
        display: flex;
        gap: 10px;
      }

      .log-content {
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid #333;
        border-radius: 6px;
        padding: 15px;
        flex: 1;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.4;
        min-height: 200px;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 6px 10px;
        border-radius: 4px;
        border-left: 3px solid transparent;
      }

      .log-entry.info {
        border-left-color: #60a5fa;
        background: rgba(96, 165, 250, 0.1);
      }

      .log-entry.success {
        border-left-color: #4ade80;
        background: rgba(74, 222, 128, 0.1);
      }

      .log-entry.warning {
        border-left-color: #fbbf24;
        background: rgba(251, 191, 36, 0.1);
      }

      .log-entry.error {
        border-left-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }

      .log-entry.diagnostic {
        border-left-color: #ec4899;
        background: rgba(236, 72, 153, 0.1);
      }

      .log-timestamp {
        color: #6b7280;
        margin-right: 10px;
      }

      /* è¼‰å…¥å‹•ç•« */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        transition: opacity 0.5s ease;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(96, 165, 250, 0.3);
        border-top: 3px solid #60a5fa;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .loading-text {
        color: #60a5fa;
        font-size: 16px;
        margin-bottom: 10px;
      }

      .loading-details {
        color: #9ca3af;
        font-size: 12px;
        text-align: center;
        max-width: 400px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto 1fr;
        }

        .status-bar {
          flex-direction: column;
          height: auto;
          padding: 10px;
        }

        .main-container {
          padding-top: 120px;
        }
      }
    </style>
  </head>
  <body>
    <!-- è¼‰å…¥è¦†è“‹å±¤ -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">åˆå§‹åŒ–æ¨¡çµ„åŒ–ç³»çµ±</div>
      <div class="loading-details">
        æ­£åœ¨è¼‰å…¥æ ¸å¿ƒæ¶æ§‹ï¼šDataManager + GameState + EventBus<br />
        ä¸¦è¡Œè¼‰å…¥é…ç½®æª”æ¡ˆï¼šrules.json, tenants.json, skills.json, events.json
      </div>
    </div>

    <!-- é ‚éƒ¨ç‹€æ…‹åˆ— -->
    <div class="status-bar">
      <div class="status-indicator">
        <div id="statusDot" class="status-dot error"></div>
        <span id="statusText" class="status-text">ç³»çµ±åˆå§‹åŒ–ä¸­...</span>
      </div>
      <div class="version-info">
        æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨ v2.0-beta | é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ<br />
        <small style="color: #666"
          >ä¸Šæ–¹é¡¯ç¤º main.js ç³»çµ±ç‹€æ…‹ï¼Œä¸‹æ–¹ç‚ºé–‹ç™¼æ§åˆ¶å°</small
        >
      </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <div class="main-container">
      <div class="dashboard-grid">
        <!-- å·¦å´é¢æ¿ï¼šæ§åˆ¶å€åŸŸ -->
        <div class="left-panel">
          <!-- æ§åˆ¶é¢æ¿ -->
          <div class="control-panel">
            <div class="panel-title">ğŸ® æ¨¡çµ„åŒ–ç³»çµ±æ¸¬è©¦æ§åˆ¶å°</div>
            <div
              style="
                margin-bottom: 15px;
                font-size: 11px;
                color: #888;
                line-height: 1.4;
              "
            >
              <strong>ç³»çµ±åˆ†é¡æ¸¬è©¦</strong
              >ï¼šæŒ‰ç…§æ¨¡çµ„æ¶æ§‹åˆ†çµ„ï¼Œæ¯å€‹ç³»çµ±ç¨ç«‹æ¸¬è©¦å€åŸŸ<br />
              <strong>å¯¦éš›å‡½æ•¸é©—è­‰</strong
              >ï¼šæ‰€æœ‰æ¸¬è©¦ç›´æ¥èª¿ç”¨çœŸå¯¦çš„ç³»çµ±APIå‡½æ•¸<br />
              <strong>å®Œæ•´éŒ¯èª¤è™•ç†</strong
              >ï¼šåŒ…å«åƒæ•¸é©—è­‰ã€ç‹€æ…‹æª¢æŸ¥ã€ç•°å¸¸æ•ç²æ©Ÿåˆ¶<br /><br />
              <strong>ğŸ—ï¸ æ ¸å¿ƒç³»çµ±</strong>ï¼šæ•´åˆæ¸¬è©¦ã€ç‹€æ…‹æŸ¥è©¢ã€é™¤éŒ¯è³‡è¨Š<br />
              <strong>ğŸ’ ResourceManager</strong
              >ï¼šè³‡æºä¿®æ”¹ã€è½‰ç§»ã€æ¡é›†ç³»çµ±<br />
              <strong>ğŸª TradeManager</strong
              >ï¼šç§Ÿé‡‘æ”¶å–ã€å•†éšŠäº¤æ˜“ã€äº’åŠ©æ©Ÿåˆ¶<br />
              <strong>ğŸ‘¥ TenantManager</strong
              >ï¼šç§Ÿå®¢é›‡ç”¨ã€æœåˆ®æ´¾é£ã€æ»¿æ„åº¦ç®¡ç†<br />
              <strong>ğŸ“¡ EventBus</strong>ï¼šäº‹ä»¶é€šä¿¡æ¸¬è©¦ã€çµ±è¨ˆæŸ¥è©¢<br />
              <strong>ğŸ› ï¸ é–‹ç™¼å·¥å…·</strong>ï¼šéŠæˆ²æ¨é€²ã€ç‹€æ…‹åŒ¯å‡ºã€æ—¥èªŒç®¡ç†
            </div>
            <div class="control-buttons">
              <!-- =================== æ ¸å¿ƒç³»çµ±æ¸¬è©¦ =================== -->
              <div class="button-group">
                <div class="group-title">ğŸ—ï¸ æ ¸å¿ƒç³»çµ±</div>
                <div class="button-row">
                  <button class="btn primary" onclick="runSystemTests()">
                    ğŸ§ª ç³»çµ±æ¸¬è©¦
                  </button>
                  <button class="btn" onclick="showSystemStatus()">
                    ğŸ“Š ç³»çµ±ç‹€æ…‹
                  </button>
                  <button class="btn" onclick="showDebugInfo()">
                    ğŸ”§ é™¤éŒ¯è³‡è¨Š
                  </button>
                </div>
              </div>

              <!-- =================== ResourceManager æ¸¬è©¦ =================== -->
              <div class="button-group">
                <div class="group-title">ğŸ’ ResourceManager</div>
                <div class="button-row">
                  <button
                    class="btn resource-test"
                    onclick="testResourceModify()"
                  >
                    ğŸ’ è³‡æºä¿®æ”¹
                  </button>
                  <button
                    class="btn resource-test"
                    onclick="testResourceTransfer()"
                  >
                    ğŸ”„ è³‡æºè½‰ç§»
                  </button>
                  <button
                    class="btn resource-test"
                    onclick="testHarvestSystem()"
                  >
                    ğŸŒ± é™¢å­æ¡é›†
                  </button>
                </div>
              </div>

              <!-- =================== TradeManager æ¸¬è©¦ =================== -->
              <div class="button-group">
                <div class="group-title">ğŸª TradeManager</div>
                <div class="button-row">
                  <button class="btn trade-test" onclick="testRentCollection()">
                    ğŸ  ç§Ÿé‡‘æ”¶å–
                  </button>
                  <button class="btn trade-test" onclick="testCaravanTrade()">
                    ğŸš› å•†éšŠäº¤æ˜“
                  </button>
                  <button class="btn trade-test" onclick="testMutualAid()">
                    ğŸ¤ äº’åŠ©ç³»çµ±
                  </button>
                </div>
              </div>

              <!-- =================== TenantManager æ¸¬è©¦ =================== -->
              <div class="button-group">
                <div class="group-title">ğŸ‘¥ TenantManager</div>
                <div class="button-row">
                  <button class="btn tenant-test" onclick="testTenantHiring()">
                    ğŸ‘¤ ç§Ÿå®¢é›‡ç”¨
                  </button>
                  <button
                    class="btn tenant-test"
                    onclick="testTenantScavenge()"
                  >
                    ğŸ” æœåˆ®æ´¾é£
                  </button>
                  <button
                    class="btn tenant-test"
                    onclick="testTenantSatisfaction()"
                  >
                    ğŸ˜Š æ»¿æ„åº¦ç³»çµ±
                  </button>
                </div>
              </div>

              <!-- =================== EventBus æ¸¬è©¦ =================== -->
              <div class="button-group">
                <div class="group-title">ğŸ“¡ EventBus</div>
                <div class="button-row">
                  <button
                    class="btn event-test"
                    onclick="testEventCommunication()"
                  >
                    ğŸ“¡ äº‹ä»¶é€šä¿¡
                  </button>
                  <button class="btn event-test" onclick="showEventStats()">
                    ğŸ“ˆ äº‹ä»¶çµ±è¨ˆ
                  </button>
                </div>
                <div class="button-row" style="margin-top: 8px">
                  <button class="btn diagnostic" onclick="runOnceDiagnostic()">
                    ğŸ”¬ once() ä¿®å¾©é©—è­‰
                  </button>
                  <button class="btn diagnostic" onclick="runOnceStressTest()">
                    âš¡ å£“åŠ›æ¸¬è©¦
                  </button>
                </div>
              </div>

              <!-- =================== é–‹ç™¼å·¥å…· =================== -->
              <div class="button-group">
                <div class="group-title">ğŸ› ï¸ é–‹ç™¼å·¥å…·</div>
                <div class="button-row">
                  <button class="btn" onclick="advanceGameDay()">
                    â­ï¸ æ¨é€²ä¸€å¤©
                  </button>
                  <button class="btn" onclick="exportGameState()">
                    ğŸ’¾ åŒ¯å‡ºç‹€æ…‹
                  </button>
                  <button class="btn success" onclick="clearLogs()">
                    ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å³å´é¢æ¿ï¼šç›£æ§å’Œæ—¥èªŒ -->
        <div class="right-panel">
          <!-- ç³»çµ±è³‡è¨Šé¢æ¿ï¼ˆå³ä¸Šï¼‰ -->
          <div class="system-info">
            <div class="panel-title">ğŸ“Š æ¨¡çµ„åŒ–æ¶æ§‹ç›£æ§</div>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">ç³»çµ±é‹è¡Œæ¨¡å¼</div>
                <div id="systemMode" class="info-value">è¼‰å…¥ä¸­...</div>
              </div>
              <div class="info-item">
                <div class="info-label">å·²è¼‰å…¥æ¨¡çµ„</div>
                <div id="loadedModules" class="info-value">0 / 6</div>
              </div>
              <div class="info-item">
                <div class="info-label">EventBusäº‹ä»¶</div>
                <div id="eventCount" class="info-value">0</div>
              </div>
              <div class="info-item">
                <div class="info-label">GameStateè®Šæ›´</div>
                <div id="stateChanges" class="info-value">0</div>
              </div>
              <div class="info-item">
                <div class="info-label">è³‡æºç¸½åƒ¹å€¼</div>
                <div id="totalResources" class="info-value">è¨ˆç®—ä¸­...</div>
              </div>
              <div class="info-item">
                <div class="info-label">ç§Ÿå®¢ç®¡ç†</div>
                <div id="tenantCount" class="info-value">0 / 5</div>
              </div>
            </div>
          </div>

          <!-- æ—¥èªŒé¢æ¿ï¼ˆå³ä¸‹ï¼‰ -->
          <div class="log-panel">
            <div class="log-header">
              <div class="panel-title">ğŸ“‹ ç³»çµ±æ¸¬è©¦åŸ·è¡Œæ—¥èªŒ</div>
              <div class="log-controls">
                <button class="btn" onclick="exportLogs()">åŒ¯å‡ºæ—¥èªŒ</button>
                <button class="btn" onclick="toggleAutoScroll()">
                  è‡ªå‹•æ»¾å‹•
                </button>
              </div>
            </div>
            <div id="logContent" class="log-content">
              <div class="log-entry info">
                <span class="log-timestamp">[00:00:00]</span>
                é–‹ç™¼æ¸¬è©¦ç’°å¢ƒå•Ÿå‹•ä¸­...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // å…¨åŸŸè®Šæ•¸
      let gameApp = null;
      let autoScroll = true;
      let updateInterval = null;

      /**
       * æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
       */
      async function initializeApp() {
        try {
          updateLoadingText("è¼‰å…¥æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒ...");

          // å‹•æ…‹è¼‰å…¥ main.js
          const mainModule = await import("./js/main.js");

          // ç­‰å¾…æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
          await new Promise((resolve) => {
            const checkApp = () => {
              if (window.gameApp && window.gameApp.isInitialized) {
                gameApp = window.gameApp;
                resolve();
              } else {
                setTimeout(checkApp, 100);
              }
            };
            checkApp();
          });

          // éš±è—è¼‰å…¥è¦†è“‹å±¤
          const loadingOverlay = document.getElementById("loadingOverlay");
          loadingOverlay.style.opacity = "0";
          setTimeout(() => {
            loadingOverlay.style.display = "none";
          }, 500);

          // åˆå§‹åŒ– UI
          initializeUI();
          initializeDiagnosticTool();

          // é–‹å§‹å®šæœŸæ›´æ–°
          startPeriodicUpdates();

          addLog("ç³»çµ±åˆå§‹åŒ–å®Œæˆ", "success");
        } catch (error) {
          console.error("åˆå§‹åŒ–å¤±æ•—:", error);
          updateSystemStatus("error", "åˆå§‹åŒ–å¤±æ•—: " + error.message);
          addLog("åˆå§‹åŒ–å¤±æ•—: " + error.message, "error");
        }
      }

      /**
       * åˆå§‹åŒ– UI ä»‹é¢
       */
      function initializeUI() {
        if (!gameApp) {
          updateSystemStatus("error", "éŠæˆ²æ‡‰ç”¨ç¨‹å¼æœªè¼‰å…¥");
          return;
        }

        // ç›£è½éŠæˆ²ç‹€æ…‹è®ŠåŒ–
        if (gameApp.eventBus) {
          gameApp.eventBus.on("log_added", (event) => {
            if (event.data && event.data.message) {
              addLog(event.data.message, event.data.type || "info");
            }
          });

          gameApp.eventBus.on("state_changed", () => {
            updateSystemInfo();
          });

          gameApp.eventBus.on("system_ready", () => {
            addLog("ç³»çµ±å°±ç·’äº‹ä»¶æ¥æ”¶", "success");
            updateSystemInfo();
          });
        }

        // ç›£æ§ main.js ç”Ÿæˆçš„ systemStatus å…ƒç´ è®ŠåŒ–
        const observeMainSystemStatus = () => {
          const mainStatusElement = document.getElementById("systemStatus");
          if (mainStatusElement) {
            addLog("æª¢æ¸¬åˆ° main.js ç³»çµ±ç‹€æ…‹å…ƒç´ ", "info");

            // å‰µå»ºè®ŠåŒ–è§€å¯Ÿå™¨
            const observer = new MutationObserver((mutations) => {
              mutations.forEach((mutation) => {
                if (
                  mutation.type === "childList" ||
                  mutation.type === "characterData"
                ) {
                  updateSystemInfo(); // ç•¶ main.js ç‹€æ…‹è®ŠåŒ–æ™‚åŒæ­¥æ›´æ–°
                }
              });
            });

            observer.observe(mainStatusElement, {
              childList: true,
              subtree: true,
              characterData: true,
            });
          }
        };

        // å»¶é²è§€å¯Ÿï¼Œç­‰å¾… main.js å‰µå»ºç‹€æ…‹å…ƒç´ 
        setTimeout(observeMainSystemStatus, 1000);

        // æ›´æ–°åˆå§‹ç‹€æ…‹
        updateSystemStatus("success", "é–‹ç™¼ç’°å¢ƒ v2.0 - é‹è¡Œä¸­");
        updateSystemInfo();
      }

      /**
       * é–‹å§‹å®šæœŸæ›´æ–°
       */
      function startPeriodicUpdates() {
        updateInterval = setInterval(() => {
          if (gameApp && gameApp.isInitialized) {
            updateSystemInfo();
          }
        }, 5000); // æ¯ 5 ç§’æ›´æ–°ä¸€æ¬¡
      }

      /**
       * æ›´æ–°è¼‰å…¥æ–‡å­—
       */
      function updateLoadingText(text, details = "") {
        const loadingText = document.querySelector(".loading-text");
        const loadingDetails = document.querySelector(".loading-details");
        if (loadingText) loadingText.textContent = text;
        if (loadingDetails && details) loadingDetails.innerHTML = details;
      }

      /**
       * æ›´æ–°ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨
       */
      function updateSystemStatus(status, message) {
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");

        statusDot.className = `status-dot ${status}`;
        statusText.textContent = message;
      }

      /**
       * æ›´æ–°ç³»çµ±è³‡è¨Šé¢æ¿
       */
      function updateSystemInfo() {
        if (!gameApp) return;

        try {
          // æª¢æŸ¥ main.js ç”Ÿæˆçš„ systemStatus å…ƒç´ 
          const mainSystemStatus = document.getElementById("systemStatus");
          let systemMode = gameApp.systemMode || "æœªçŸ¥";

          // å¦‚æœ main.js çš„ç‹€æ…‹å…ƒç´ å­˜åœ¨ï¼Œå¾ä¸­è§£ææ¨¡å¼
          if (mainSystemStatus && mainSystemStatus.textContent) {
            const statusText = mainSystemStatus.textContent;
            if (statusText.includes("ğŸŸ¢")) {
              systemMode = "æ­£å¸¸æ¨¡å¼";
              updateSystemStatus("success", "é–‹ç™¼ç’°å¢ƒ v2.0 - é‹è¡Œä¸­");
            } else if (statusText.includes("ğŸŸ¡")) {
              systemMode = "å¾Œå‚™æ¨¡å¼";
              updateSystemStatus("warning", "é–‹ç™¼ç’°å¢ƒ v2.0 - å¾Œå‚™æ¨¡å¼");
            } else if (statusText.includes("ğŸ”´")) {
              systemMode = "éŒ¯èª¤ç‹€æ…‹";
              updateSystemStatus("error", "ç³»çµ±ç™¼ç”ŸéŒ¯èª¤");
            }
          }

          document.getElementById("systemMode").textContent = systemMode;

          // è¼‰å…¥çš„æ¨¡çµ„æ•¸é‡
          const status = gameApp.getStatus();
          let moduleCount = 0;
          if (status.dataManager) moduleCount++;
          if (status.gameState) moduleCount++;
          if (status.eventBus) moduleCount++;
          if (status.resourceManager) moduleCount++;
          if (status.tradeManager) moduleCount++;
          if (status.tenantManager) moduleCount++;

          document.getElementById(
            "loadedModules"
          ).textContent = `${moduleCount} / 6`;

          // äº‹ä»¶ç¸½æ•¸
          if (status.eventBus && status.eventBus.totalEmitted) {
            document.getElementById("eventCount").textContent =
              status.eventBus.totalEmitted;
          }

          // ç‹€æ…‹è®Šæ›´æ•¸é‡
          if (status.gameState && status.gameState.totalChanges) {
            document.getElementById("stateChanges").textContent =
              status.gameState.totalChanges;
          }

          // è³‡æºç¸½å€¼
          if (gameApp.gameState) {
            const resources = gameApp.gameState.getState().resources || {};
            const total = Object.values(resources).reduce(
              (sum, val) => sum + (val || 0),
              0
            );
            document.getElementById("totalResources").textContent =
              total.toString();
          }

          // ç§Ÿå®¢æ•¸é‡
          if (gameApp.gameState) {
            const tenants = gameApp.gameState.getAllTenants() || [];
            const rooms = gameApp.gameState.getState().rooms || [];
            document.getElementById(
              "tenantCount"
            ).textContent = `${tenants.length} / ${rooms.length}`;
          }
        } catch (error) {
          console.error("æ›´æ–°ç³»çµ±è³‡è¨Šå¤±æ•—:", error);
          addLog("æ›´æ–°ç³»çµ±è³‡è¨Šå¤±æ•—: " + error.message, "error");
        }
      }

      /**
       * æ·»åŠ æ—¥èªŒæ¢ç›®
       */
      function addLog(message, type = "info") {
        const logContent = document.getElementById("logContent");
        const timestamp = new Date().toLocaleTimeString();

        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${type}`;
        logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                ${message}
            `;

        logContent.appendChild(logEntry);

        // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
        if (autoScroll) {
          logContent.scrollTop = logContent.scrollHeight;
        }

        // é™åˆ¶æ—¥èªŒæ•¸é‡ï¼Œé¿å…è¨˜æ†¶é«”å•é¡Œ
        if (logContent.children.length > 1000) {
          logContent.removeChild(logContent.firstChild);
        }
      }

      // å…¨åŸŸå‡½æ•¸ï¼ˆä¾›æŒ‰éˆ•èª¿ç”¨ï¼‰
      window.runSystemTests = async function () {
        if (!gameApp) {
          addLog("éŠæˆ²æ‡‰ç”¨ç¨‹å¼æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("é–‹å§‹åŸ·è¡Œç³»çµ±æ¸¬è©¦...", "info");
          await gameApp.runTests();
          addLog("ç³»çµ±æ¸¬è©¦å®Œæˆ", "success");
          updateSystemInfo();
        } catch (error) {
          addLog("ç³»çµ±æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      window.showSystemStatus = function () {
        if (!gameApp) {
          addLog("éŠæˆ²æ‡‰ç”¨ç¨‹å¼æœªåˆå§‹åŒ–", "error");
          return;
        }

        const status = gameApp.getStatus();
        addLog("=== ç³»çµ±ç‹€æ…‹ ===", "info");
        addLog(`åˆå§‹åŒ–ç‹€æ…‹: ${status.initialized}`, "info");
        addLog(`ç³»çµ±æ¨¡å¼: ${gameApp.systemMode}`, "info");
        addLog(
          `è³‡æ–™ç®¡ç†å™¨: ${status.dataManager ? "æ­£å¸¸" : "ç•°å¸¸"}`,
          status.dataManager ? "success" : "error"
        );
        addLog(
          `éŠæˆ²ç‹€æ…‹: ${status.gameState ? "æ­£å¸¸" : "ç•°å¸¸"}`,
          status.gameState ? "success" : "error"
        );
        addLog(
          `äº‹ä»¶ç³»çµ±: ${status.eventBus ? "æ­£å¸¸" : "ç•°å¸¸"}`,
          status.eventBus ? "success" : "error"
        );
        addLog("=== ç‹€æ…‹æª¢æŸ¥å®Œæˆ ===", "info");
      };

      window.showDebugInfo = function () {
        if (!gameApp) {
          addLog("éŠæˆ²æ‡‰ç”¨ç¨‹å¼æœªåˆå§‹åŒ–", "error");
          return;
        }

        addLog("è©³ç´°é™¤éŒ¯è³‡è¨Šå·²è¼¸å‡ºåˆ°æ§åˆ¶å°", "info");
        gameApp.debug();
      };

      // ========================================
      // TenantManager æ¸¬è©¦å‡½æ•¸
      // ========================================

      window.testTenantHiring = function () {
        if (!gameApp || !gameApp.tenantManager) {
          addLog("TenantManager æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== TenantManager é›‡ç”¨æ¸¬è©¦ ===", "info");

          // ç”Ÿæˆç”³è«‹è€…
          const applicants = gameApp.tenantManager.generateApplicants(3);
          addLog(`ç”Ÿæˆç”³è«‹è€…: ${applicants.length}ä½`, "success");

          applicants.forEach((applicant, index) => {
            addLog(
              `  ${index + 1}. ${applicant.name} (${applicant.type}) - ${
                applicant.appearance
              }`,
              "info"
            );
          });

          if (applicants.length > 0) {
            const selectedApplicant = applicants[0];
            addLog(`é¸æ“‡ç”³è«‹è€…: ${selectedApplicant.name}`, "info");

            // æª¢æŸ¥ç©ºæˆ¿é–“
            const emptyRooms = gameApp.tenantManager.getEmptyRooms();
            addLog(`å¯ç”¨æˆ¿é–“: ${emptyRooms.length}é–“`, "info");

            if (emptyRooms.length > 0) {
              // åŸ·è¡Œé›‡ç”¨
              gameApp.tenantManager
                .hireTenant(selectedApplicant)
                .then((result) => {
                  if (result.success) {
                    addLog(
                      `é›‡ç”¨æˆåŠŸ: ${result.tenant.name} å…¥ä½æˆ¿é–“ ${result.roomId}`,
                      "success"
                    );
                    addLog(`ç§Ÿé‡‘: ${result.tenant.rent}/å¤©`, "info");
                  } else {
                    addLog(`é›‡ç”¨å¤±æ•—: ${result.error}`, "error");
                  }
                  updateSystemInfo();
                })
                .catch((error) => {
                  addLog("é›‡ç”¨ç•°å¸¸: " + error.message, "error");
                });
            } else {
              addLog("ç„¡å¯ç”¨æˆ¿é–“ï¼Œç„¡æ³•é€²è¡Œé›‡ç”¨æ¸¬è©¦", "warning");
            }
          }
        } catch (error) {
          addLog("ç§Ÿå®¢é›‡ç”¨æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      window.testTenantScavenge = function () {
        if (!gameApp || !gameApp.tenantManager) {
          addLog("TenantManager æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== TenantManager æœåˆ®æ¸¬è©¦ ===", "info");

          // æª¢æŸ¥å¯ç”¨æœåˆ®è€…
          const scavengers = gameApp.tenantManager.getAvailableScavengers
            ? gameApp.tenantManager.getAvailableScavengers()
            : [];

          addLog(`å¯ç”¨æœåˆ®è€…: ${scavengers.length}ä½`, "info");

          if (scavengers.length === 0) {
            addLog("ç„¡å¯ç”¨æœåˆ®è€…ï¼Œæª¢æŸ¥æ‰€æœ‰ç§Ÿå®¢...", "warning");
            const allTenants = gameApp.gameState
              ? gameApp.gameState.getAllTenants()
              : [];
            addLog(`ç¸½ç§Ÿå®¢æ•¸: ${allTenants.length}`, "info");

            if (allTenants.length === 0) {
              addLog("ç„¡ç§Ÿå®¢å¯é€²è¡Œæœåˆ®æ¸¬è©¦", "warning");
              return;
            }
          }

          // æª¢æŸ¥æœåˆ®ç‹€æ…‹
          const scavengeUsed = gameApp.gameState
            ? gameApp.gameState.getStateValue("dailyActions.scavengeUsed", 0)
            : 0;
          const maxScavenge = 2; // é è¨­æœ€å¤§æœåˆ®æ¬¡æ•¸

          addLog(`æœåˆ®ä½¿ç”¨ç‹€æ³: ${scavengeUsed}/${maxScavenge}`, "info");

          if (scavengeUsed >= maxScavenge) {
            addLog("ä»Šæ—¥æœåˆ®æ¬¡æ•¸å·²ç”¨å®Œï¼Œé‡ç½®ä»¥é€²è¡Œæ¸¬è©¦...", "warning");
            if (gameApp.gameState) {
              gameApp.gameState.setStateValue(
                "dailyActions.scavengeUsed",
                0,
                "æ¸¬è©¦é‡ç½®"
              );
            }
          }

          // é¸æ“‡ç¬¬ä¸€å€‹å¯ç”¨çš„æœåˆ®è€…é€²è¡Œæ¸¬è©¦
          const targetTenant =
            scavengers.length > 0
              ? scavengers[0]
              : gameApp.gameState
              ? gameApp.gameState.getAllTenants()[0]
              : null;

          if (targetTenant) {
            addLog(`æ´¾é£ ${targetTenant.name} é€²è¡Œæœåˆ®...`, "info");

            // åŸ·è¡Œæœåˆ®æ´¾é£
            if (gameApp.tenantManager.sendTenantScavenging) {
              gameApp.tenantManager
                .sendTenantScavenging(targetTenant.id)
                .then((result) => {
                  if (result.success) {
                    addLog(`æœåˆ®æˆåŠŸï¼`, "success");
                    if (result.rewards) {
                      addLog(
                        `ç²å¾—çå‹µ: ${JSON.stringify(result.rewards)}`,
                        "success"
                      );
                    }
                    if (result.experience) {
                      addLog(`ç¶“é©—æå‡: +${result.experience}`, "info");
                    }
                  } else {
                    addLog(
                      `æœåˆ®å¤±æ•—: ${result.error || result.reason}`,
                      "error"
                    );
                  }
                  updateSystemInfo();
                })
                .catch((error) => {
                  addLog("æœåˆ®ç•°å¸¸: " + error.message, "error");
                });
            } else {
              addLog("æœåˆ®åŠŸèƒ½æœªå¯¦ä½œ", "warning");
            }
          }
        } catch (error) {
          addLog("æœåˆ®æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      window.testTenantSatisfaction = function () {
        if (!gameApp || !gameApp.tenantManager) {
          addLog("TenantManager æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== TenantManager æ»¿æ„åº¦æ¸¬è©¦ ===", "info");

          // ç²å–ç§Ÿå®¢çµ±è¨ˆ
          const stats = gameApp.tenantManager.getTenantStats();
          addLog(`ç§Ÿå®¢çµ±è¨ˆ:`, "info");
          addLog(`  ç¸½ç§Ÿå®¢æ•¸: ${stats.totalTenants}`, "info");
          addLog(`  å¥åº·ç§Ÿå®¢: ${stats.healthyTenants}`, "success");
          addLog(
            `  æ„ŸæŸ“ç§Ÿå®¢: ${stats.infectedTenants}`,
            stats.infectedTenants > 0 ? "warning" : "success"
          );
          addLog(
            `  å¹³å‡æ»¿æ„åº¦: ${stats.averageSatisfaction?.toFixed(1) || "N/A"}`,
            "info"
          );
          addLog(`  ç¸½ç§Ÿé‡‘æ”¶å…¥: ${stats.totalRentIncome}`, "info");

          // é¡¯ç¤ºè·æ¥­åˆ†å¸ƒ
          if (stats.typeDistribution) {
            addLog(`è·æ¥­åˆ†å¸ƒ:`, "info");
            Object.entries(stats.typeDistribution).forEach(([type, count]) => {
              if (count > 0) {
                addLog(`  ${type}: ${count}ä½`, "info");
              }
            });
          }

          // ç²å–æ‰€æœ‰æ»¿æ„åº¦
          const satisfactionMap = gameApp.tenantManager.getAllSatisfaction();
          if (satisfactionMap && satisfactionMap.size > 0) {
            addLog(`å€‹åˆ¥æ»¿æ„åº¦:`, "info");
            satisfactionMap.forEach((satisfaction, tenantId) => {
              const tenant = this.tenantManager.findTenantAndRoom(tenantId).tenant
              const level =
                satisfaction >= 80
                  ? "ğŸ˜æ¥µå¥½"
                  : satisfaction >= 60
                  ? "ğŸ˜Šè‰¯å¥½"
                  : satisfaction >= 40
                  ? "ğŸ˜æ™®é€š"
                  : satisfaction >= 20
                  ? "ğŸ˜Ÿä¸æ»¿"
                  : "ğŸ˜ æ†¤æ€’";
              addLog(`  ${tenant.name}: ${satisfaction} ${level}`, "info");
            });
          }

          // æ¸¬è©¦æ»¿æ„åº¦æ›´æ–°
          addLog("åŸ·è¡Œæ»¿æ„åº¦æ›´æ–°...", "info");
          gameApp.tenantManager.updateTenantSatisfaction();
          addLog("æ»¿æ„åº¦æ›´æ–°å®Œæˆ", "success");

          updateSystemInfo();
        } catch (error) {
          addLog("æ»¿æ„åº¦æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      // ========================================
      // EventBus æ¸¬è©¦å‡½æ•¸ï¼ˆå« once() å•é¡Œè¨ºæ–·ï¼‰
      // ========================================

      window.testEventCommunication = function () {
        if (!gameApp || !gameApp.eventBus) {
          addLog("EventBus æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== EventBus åŸºæœ¬é€šä¿¡æ¸¬è©¦ ===", "info");

          let testResults = {
            basicEmit: false,
            onceListener: false,
            regularListener: false,
            dataTransfer: false,
          };

          // æ¸¬è©¦åŸºæœ¬äº‹ä»¶ç™¼é€
          gameApp.eventBus.emit("dev_test_basic", { test: "basic" });
          testResults.basicEmit = true;
          addLog("åŸºæœ¬äº‹ä»¶ç™¼é€: âœ…æˆåŠŸ", "success");

          // æ¸¬è©¦ä¸€æ¬¡æ€§ç›£è½å™¨
          gameApp.eventBus.once("dev_test_once", (eventObj) => {
            testResults.onceListener = true;
            testResults.dataTransfer =
              eventObj.data && eventObj.data.message === "test_data";
            addLog("ä¸€æ¬¡æ€§ç›£è½å™¨: âœ…è§¸ç™¼", "success");
            addLog(
              `æ•¸æ“šå‚³è¼¸: ${testResults.dataTransfer ? "âœ…æ­£ç¢º" : "âŒéŒ¯èª¤"}`,
              testResults.dataTransfer ? "success" : "error"
            );
          });

          // è§¸ç™¼ä¸€æ¬¡æ€§ç›£è½å™¨
          gameApp.eventBus.emit("dev_test_once", { message: "test_data" });

          // æ¸¬è©¦å¸¸è¦ç›£è½å™¨
          const unsubscribe = gameApp.eventBus.on(
            "dev_test_regular",
            (eventObj) => {
              testResults.regularListener = true;
              addLog("å¸¸è¦ç›£è½å™¨: âœ…è§¸ç™¼", "success");
            }
          );

          gameApp.eventBus.emit("dev_test_regular", { regular: true });

          if (typeof unsubscribe === "function") {
            unsubscribe();
            addLog("ç›£è½å™¨æ¸…ç†: âœ…å®Œæˆ", "success");
          }

          // çµ±è¨ˆçµæœ
          const successCount =
            Object.values(testResults).filter(Boolean).length;
          addLog(
            `æ¸¬è©¦çµæœ: ${successCount}/4 é …æˆåŠŸ`,
            successCount === 4 ? "success" : "warning"
          );
        } catch (error) {
          addLog("äº‹ä»¶é€šä¿¡æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      /**
       * EventBus once() ä¿®å¾©é©—è­‰å·¥å…·
       */
      class EventBusOnceDiagnostic {
        constructor() {
          this.testResults = [];
        }

        /**
         * åŸ·è¡Œå¿«é€Ÿè¨ºæ–·ï¼šé©—è­‰ä¿®å¾©æ•ˆæœ
         */
        async runQuickDiagnostic(eventBus) {
          addLog("ğŸ”¬ é–‹å§‹ EventBus once() ä¿®å¾©é©—è­‰...", "diagnostic");

          let callCount = 0;
          const testEventName = "diagnostic_once_test";

          // æ¸¬è©¦ç›£è½å™¨
          const testListener = (eventObj) => {
            callCount++;
            addLog(
              `[é©—è­‰] once() ç›£è½å™¨ç¬¬ ${callCount} æ¬¡èª¿ç”¨ (äº‹ä»¶ID: ${eventObj.id})`,
              "diagnostic"
            );
          };

          // è¨»å†Šä¸€æ¬¡æ€§ç›£è½å™¨
          addLog("è¨»å†Š once() ç›£è½å™¨...", "info");
          eventBus.once(testEventName, testListener);

          // å¿«é€Ÿé€£çºŒè§¸ç™¼ï¼ˆä¿®å¾©å‰æœƒé‡è¤‡åŸ·è¡Œï¼Œä¿®å¾©å¾ŒåªåŸ·è¡Œä¸€æ¬¡ï¼‰
          addLog("å¿«é€Ÿé€£çºŒè§¸ç™¼ 3 æ¬¡äº‹ä»¶...", "diagnostic");
          eventBus.emit(testEventName, { test: "trigger_1" });
          eventBus.emit(testEventName, { test: "trigger_2" });
          eventBus.emit(testEventName, { test: "trigger_3" });

          // ç­‰å¾…è™•ç†å®Œæˆ
          await new Promise((resolve) => setTimeout(resolve, 50));

          // è©•ä¼°çµæœ
          const isFixed = callCount === 1;
          const resultMessage = isFixed
            ? `âœ… ä¿®å¾©é©—è­‰æˆåŠŸï¼šonce() ç›£è½å™¨åƒ…åŸ·è¡Œ 1 æ¬¡`
            : `âŒ ä¿®å¾©é©—è­‰å¤±æ•—ï¼šonce() ç›£è½å™¨åŸ·è¡Œäº† ${callCount} æ¬¡`;

          addLog(resultMessage, isFixed ? "success" : "error");

          if (isFixed) {
            addLog("ğŸ‰ EventBus once() æ™‚åºç«¶çˆ­æ¢ä»¶å·²ä¿®å¾©", "success");
          } else {
            addLog(
              "âš ï¸  once() ä»å­˜åœ¨é‡è¤‡åŸ·è¡Œå•é¡Œï¼Œå»ºè­°æª¢æŸ¥ä¿®å¾©å¯¦ä½œ",
              "warning"
            );
          }

          return { isFixed, callCount, testEventName };
        }

        /**
         * åŸ·è¡Œå£“åŠ›æ¸¬è©¦ï¼šå¤§é‡ä¸¦ç™¼è§¸ç™¼
         */
        async runStressTest(eventBus) {
          addLog("âš¡ é–‹å§‹ EventBus once() å£“åŠ›æ¸¬è©¦...", "diagnostic");

          const results = [];
          const testCount = 10; // æ¸¬è©¦ 10 å€‹ä¸åŒçš„ once() ç›£è½å™¨

          for (let i = 0; i < testCount; i++) {
            const eventName = `stress_test_${i}`;
            let callCount = 0;

            // ç‚ºæ¯å€‹æ¸¬è©¦å‰µå»ºç›£è½å™¨
            eventBus.once(eventName, () => {
              callCount++;
            });

            // å°æ¯å€‹äº‹ä»¶é€²è¡Œé«˜é »è§¸ç™¼
            for (let j = 0; j < 5; j++) {
              eventBus.emit(eventName, { stress: true, round: j });
            }

            results.push({ eventName, callCount });
          }

          // ç­‰å¾…æ‰€æœ‰äº‹ä»¶è™•ç†å®Œæˆ
          await new Promise((resolve) => setTimeout(resolve, 100));

          // åˆ†æçµæœ
          const failedTests = results.filter((r) => r.callCount !== 1);
          const successRate = (
            ((testCount - failedTests.length) / testCount) *
            100
          ).toFixed(1);

          addLog(
            `å£“åŠ›æ¸¬è©¦å®Œæˆï¼š${testCount} å€‹æ¸¬è©¦ä¸­æœ‰ ${
              testCount - failedTests.length
            } å€‹æˆåŠŸ`,
            "info"
          );
          addLog(
            `æˆåŠŸç‡ï¼š${successRate}%`,
            successRate === "100.0" ? "success" : "warning"
          );

          if (failedTests.length > 0) {
            addLog(`å¤±æ•—çš„æ¸¬è©¦ï¼š`, "error");
            failedTests.forEach((test) => {
              addLog(`  ${test.eventName}: åŸ·è¡Œ ${test.callCount} æ¬¡`, "error");
            });
          } else {
            addLog("ğŸ‰ æ‰€æœ‰å£“åŠ›æ¸¬è©¦é€šéï¼Œonce() ä¿®å¾©ç©©å®š", "success");
          }

          return { successRate, failedTests, totalTests: testCount };
        }
      }

      // å‰µå»ºè¨ºæ–·å·¥å…·å¯¦ä¾‹
      let onceDiagnostic = null;

      /**
       * åˆå§‹åŒ–è¨ºæ–·å·¥å…·ï¼ˆåœ¨ç¾æœ‰çš„ initializeApp å‡½æ•¸ä¸­èª¿ç”¨ï¼‰
       */
      function initializeDiagnosticTool() {
        onceDiagnostic = new EventBusOnceDiagnostic();
        addLog("EventBus once() è¨ºæ–·å·¥å…·å·²åˆå§‹åŒ–", "diagnostic");
      }

      /**
       * åŸ·è¡Œ once() ä¿®å¾©é©—è­‰
       */
      window.runOnceDiagnostic = async function () {
        if (!gameApp || !gameApp.eventBus) {
          addLog("EventBus æœªåˆå§‹åŒ–ï¼Œç„¡æ³•é€²è¡Œè¨ºæ–·", "error");
          return;
        }

        if (!onceDiagnostic) {
          addLog("è¨ºæ–·å·¥å…·æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          const result = await onceDiagnostic.runQuickDiagnostic(
            gameApp.eventBus
          );
          addLog(`è¨ºæ–·å®Œæˆï¼Œè©³ç´°çµæœè«‹æŸ¥çœ‹æ§åˆ¶å°`, "info");
          console.log("ğŸ”¬ EventBus once() è¨ºæ–·çµæœ:", result);
        } catch (error) {
          addLog("è¨ºæ–·éç¨‹ç™¼ç”ŸéŒ¯èª¤: " + error.message, "error");
        }
      };

      /**
       * åŸ·è¡Œ once() å£“åŠ›æ¸¬è©¦
       */
      window.runOnceStressTest = async function () {
        if (!gameApp || !gameApp.eventBus) {
          addLog("EventBus æœªåˆå§‹åŒ–ï¼Œç„¡æ³•åŸ·è¡Œå£“åŠ›æ¸¬è©¦", "error");
          return;
        }

        if (!onceDiagnostic) {
          addLog("è¨ºæ–·å·¥å…·æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          const result = await onceDiagnostic.runStressTest(gameApp.eventBus);
          addLog(`å£“åŠ›æ¸¬è©¦å®Œæˆï¼Œè©³ç´°çµæœè«‹æŸ¥çœ‹æ§åˆ¶å°`, "info");
          console.log("âš¡ EventBus once() å£“åŠ›æ¸¬è©¦çµæœ:", result);
        } catch (error) {
          addLog("å£“åŠ›æ¸¬è©¦éç¨‹ç™¼ç”ŸéŒ¯èª¤: " + error.message, "error");
        }
      };

      window.showEventStats = function () {
        if (!gameApp || !gameApp.eventBus) {
          addLog("EventBus æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== EventBus çµ±è¨ˆè³‡è¨Š ===", "info");

          const stats = gameApp.eventBus.getStats();
          addLog(`äº‹ä»¶çµ±è¨ˆ:`, "info");

          if (stats.totalEmitted !== undefined) {
            addLog(`  ç¸½ç™¼é€æ¬¡æ•¸: ${stats.totalEmitted}`, "info");
          }

          if (stats.activeListeners !== undefined) {
            addLog(`  æ´»èºç›£è½å™¨: ${stats.activeListeners}`, "info");
          }

          if (stats.eventTypes !== undefined) {
            addLog(`  äº‹ä»¶é¡å‹æ•¸: ${stats.eventTypes}`, "info");
          }

          // åŸºæœ¬ç‹€æ…‹æª¢æŸ¥
          addLog("EventBus åŸºæœ¬ç‹€æ…‹:", "info");

          if (gameApp.eventBus.listeners) {
            addLog(
              `  ç›£è½å™¨æ˜ å°„: ${gameApp.eventBus.listeners.size} å€‹äº‹ä»¶é¡å‹`,
              "info"
            );
          }

          if (gameApp.eventBus.eventHistory) {
            addLog(
              `  äº‹ä»¶æ­·å²: ${gameApp.eventBus.eventHistory.length} æ¢è¨˜éŒ„`,
              "info"
            );
          }

          // åŸºæœ¬åŠŸèƒ½æª¢æŸ¥
          const hasOnceMethod = typeof gameApp.eventBus.once === "function";
          const hasOnMethod = typeof gameApp.eventBus.on === "function";
          const hasEmitMethod = typeof gameApp.eventBus.emit === "function";

          addLog(
            `  åŸºæœ¬æ–¹æ³•: on=${hasOnMethod ? "âœ…" : "âŒ"} once=${
              hasOnceMethod ? "âœ…" : "âŒ"
            } emit=${hasEmitMethod ? "âœ…" : "âŒ"}`,
            "info"
          );

          // é¡¯ç¤ºå…¶ä»–çµ±è¨ˆ
          Object.entries(stats).forEach(([key, value]) => {
            if (
              !["totalEmitted", "activeListeners", "eventTypes"].includes(key)
            ) {
              addLog(`  ${key}: ${value}`, "info");
            }
          });
        } catch (error) {
          addLog("EventBus çµ±è¨ˆæŸ¥è©¢å¤±æ•—: " + error.message, "error");
        }
      };

      window.clearLogs = function () {
        const logContent = document.getElementById("logContent");
        logContent.innerHTML = "";
        addLog("æ—¥èªŒå·²æ¸…é™¤", "success");
      };

      window.exportLogs = function () {
        const logContent = document.getElementById("logContent");
        const logs = Array.from(logContent.children)
          .map((entry) => entry.textContent)
          .join("\n");

        const blob = new Blob([logs], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `dev-logs-${new Date().toISOString().slice(0, 19)}.txt`;
        a.click();
        URL.revokeObjectURL(url);

        addLog("æ—¥èªŒå·²åŒ¯å‡º", "success");
      };

      // ========================================
      // ResourceManager æ¸¬è©¦å‡½æ•¸
      // ========================================

      window.testResourceModify = function () {
        if (!gameApp || !gameApp.resourceManager) {
          addLog("ResourceManager æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== ResourceManager ä¿®æ”¹æ¸¬è©¦ ===", "info");

          // æ¸¬è©¦å–®ä¸€è³‡æºä¿®æ”¹
          const foodResult = gameApp.resourceManager.modifyResource(
            "food",
            10,
            "é–‹ç™¼æ¸¬è©¦"
          );
          addLog(
            `å–®ä¸€ä¿®æ”¹é£Ÿç‰© +10: ${foodResult ? "âœ…æˆåŠŸ" : "âŒå¤±æ•—"}`,
            foodResult ? "success" : "error"
          );

          // æ¸¬è©¦æ‰¹é‡è³‡æºä¿®æ”¹
          const bulkResult = gameApp.resourceManager.bulkModifyResources({
            changes: { materials: 5, medical: 3, cash: 25 },
            reason: "é–‹ç™¼æ¸¬è©¦æ‰¹é‡ä¿®æ”¹",
            source: "dev_test",
          });
          addLog(
            `æ‰¹é‡ä¿®æ”¹è³‡æº: ${bulkResult ? "âœ…æˆåŠŸ" : "âŒå¤±æ•—"}`,
            bulkResult ? "success" : "error"
          );

          // æ¸¬è©¦è³‡æºæª¢æŸ¥
          const hasEnough = gameApp.resourceManager.hasEnoughResource(
            "food",
            5
          );
          addLog(`è³‡æºæª¢æŸ¥ é£Ÿç‰©â‰¥5: ${hasEnough ? "âœ…å……è¶³" : "âŒä¸è¶³"}`, "info");

          // æ¸¬è©¦è³‡æºç‹€æ…‹
          const foodStatus = gameApp.resourceManager.getResourceStatus("food");
          addLog(
            `é£Ÿç‰©ç‹€æ…‹: ${foodStatus.level} (å‰©é¤˜${foodStatus.daysRemaining}å¤©)`,
            "info"
          );

          updateSystemInfo();
        } catch (error) {
          addLog("ResourceManager æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      window.testResourceTransfer = function () {
        if (!gameApp || !gameApp.resourceManager) {
          addLog("ResourceManager æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== ResourceManager è½‰ç§»æ¸¬è©¦ ===", "info");

          // æª¢æŸ¥æ˜¯å¦æœ‰ç§Ÿå®¢å¯ä»¥æ¸¬è©¦è½‰ç§»
          const tenants = gameApp.gameState
            ? gameApp.gameState.getAllTenants()
            : [];

          if (tenants.length === 0) {
            addLog("ç„¡ç§Ÿå®¢å¯æ¸¬è©¦è½‰ç§»ï¼Œå…ˆå‰µå»ºæ¸¬è©¦ç§Ÿå®¢...", "warning");

            // æ¨¡æ“¬å‰µå»ºä¸€å€‹æ¸¬è©¦ç§Ÿå®¢ç”¨æ–¼è½‰ç§»æ¸¬è©¦
            if (gameApp.gameState) {
              gameApp.gameState.setState(
                "tenants.0",
                {
                  name: "æ¸¬è©¦ç§Ÿå®¢",
                  type: "worker",
                  personalResources: { food: 5, materials: 3, cash: 10 },
                },
                "æ¸¬è©¦ç§Ÿå®¢å‰µå»º"
              );
              addLog("æ¸¬è©¦ç§Ÿå®¢å·²å‰µå»º", "success");
            }
          }

          // æ¸¬è©¦æˆ¿æ±çµ¦ç§Ÿå®¢è½‰ç§»è³‡æº
          const transferResult = gameApp.resourceManager.transferResource(
            "landlord",
            "æ¸¬è©¦ç§Ÿå®¢",
            { food: 3, materials: 2 },
            "é–‹ç™¼æ¸¬è©¦è½‰ç§»"
          );
          addLog(
            `æˆ¿æ±â†’ç§Ÿå®¢è½‰ç§»: ${transferResult ? "âœ…æˆåŠŸ" : "âŒå¤±æ•—"}`,
            transferResult ? "success" : "error"
          );

          updateSystemInfo();
        } catch (error) {
          addLog("è³‡æºè½‰ç§»æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      window.testHarvestSystem = function () {
        if (!gameApp || !gameApp.resourceManager) {
          addLog("ResourceManager æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== ResourceManager æ¡é›†æ¸¬è©¦ ===", "info");

          // æª¢æŸ¥æ¡é›†ç‹€æ…‹
          const harvestStatus = gameApp.resourceManager.getHarvestStatus();
          addLog(
            `æ¡é›†å¯ç”¨æ€§: ${harvestStatus.canHarvest ? "âœ…å¯ç”¨" : "âŒä¸å¯ç”¨"}`,
            "info"
          );
          addLog(`ä»Šæ—¥å·²ç”¨: ${harvestStatus.usedToday ? "æ˜¯" : "å¦"}`, "info");
          addLog(`å†·å»å‰©é¤˜: ${harvestStatus.cooldownRemaining}å¤©`, "info");

          // æ¸¬è©¦é™¢å­æ¡é›†
          if (gameApp.resourceManager.canHarvest()) {
            const harvestResult = gameApp.resourceManager.harvestYard();
            addLog(
              `åŸ·è¡Œé™¢å­æ¡é›†: ${harvestResult ? "âœ…æˆåŠŸ" : "âŒå¤±æ•—"}`,
              harvestResult ? "success" : "error"
            );
          } else {
            addLog(
              "ç„¡æ³•åŸ·è¡Œæ¡é›†ï¼š" +
                (harvestStatus.usedToday ? "ä»Šæ—¥å·²ä½¿ç”¨" : "å†·å»ä¸­"),
              "warning"
            );
          }

          updateSystemInfo();
        } catch (error) {
          addLog("æ¡é›†ç³»çµ±æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      // ========================================
      // TradeManager æ¸¬è©¦å‡½æ•¸
      // ========================================

      window.testRentCollection = function () {
        if (!gameApp || !gameApp.tradeManager) {
          addLog("TradeManager æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== TradeManager ç§Ÿé‡‘æ”¶å–æ¸¬è©¦ ===", "info");

          // æª¢æŸ¥æ˜¯å¦ä»Šæ—¥å·²æ”¶å–ç§Ÿé‡‘
          const rentCollected = gameApp.gameState
            ? gameApp.gameState.getStateValue(
                "dailyActions.rentCollected",
                false
              )
            : false;

          if (rentCollected) {
            addLog("ä»Šæ—¥å·²æ”¶å–ç§Ÿé‡‘ï¼Œé‡ç½®ç‹€æ…‹ä»¥é€²è¡Œæ¸¬è©¦...", "warning");
            if (gameApp.gameState) {
              gameApp.gameState.setStateValue(
                "dailyActions.rentCollected",
                false,
                "æ¸¬è©¦é‡ç½®"
              );
            }
          }

          // åŸ·è¡Œç§Ÿé‡‘æ”¶å–
          gameApp.tradeManager
            .processRentCollection()
            .then((result) => {
              if (result.success) {
                addLog(`ç§Ÿé‡‘æ”¶å–æˆåŠŸï¼`, "success");
                addLog(`ç¾é‡‘æ”¶å…¥: ${result.totalCashRent}`, "success");
                addLog(`åŠ æˆæ”¶å…¥: ${result.bonusIncome}`, "success");
                addLog(`è³‡æºæŠµä»˜: ${result.resourcePayments.length}ç­†`, "info");
                addLog(
                  `å¤±æ•—æ”¯ä»˜: ${result.failedPayments.length}ç­†`,
                  result.failedPayments.length > 0 ? "warning" : "info"
                );
                if (result.summary) addLog(result.summary, "info");
              } else {
                addLog(
                  `ç§Ÿé‡‘æ”¶å–å¤±æ•—: ${result.error || result.reason}`,
                  "error"
                );
              }
              updateSystemInfo();
            })
            .catch((error) => {
              addLog("ç§Ÿé‡‘æ”¶å–ç•°å¸¸: " + error.message, "error");
            });
        } catch (error) {
          addLog("ç§Ÿé‡‘æ”¶å–æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      window.testCaravanTrade = function () {
        if (!gameApp || !gameApp.tradeManager) {
          addLog("TradeManager æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== TradeManager å•†éšŠäº¤æ˜“æ¸¬è©¦ ===", "info");

          // ç²å–ä»Šæ—¥å•†éšŠé¸é …
          const caravanOffers = gameApp.tradeManager.generateTodaysCaravanOffers
            ? gameApp.tradeManager.generateTodaysCaravanOffers()
            : {};

          const offerKeys = Object.keys(caravanOffers);
          addLog(`å¯ç”¨å•†éšŠé¸é …: ${offerKeys.length}å€‹`, "info");

          if (offerKeys.length > 0) {
            const firstOfferId = offerKeys[0];
            const offer = caravanOffers[firstOfferId];

            addLog(`æ¸¬è©¦é¸é …: ${offer.description}`, "info");
            addLog(`éœ€ä»˜å‡º: ${JSON.stringify(offer.give)}`, "info");
            addLog(`å¯ç²å¾—: ${JSON.stringify(offer.receive)}`, "info");

            // åŸ·è¡Œå•†éšŠäº¤æ˜“
            gameApp.tradeManager
              .processCaravanTrade(firstOfferId)
              .then((result) => {
                addLog(
                  `å•†éšŠäº¤æ˜“: ${result.success ? "âœ…æˆåŠŸ" : "âŒå¤±æ•—"}`,
                  result.success ? "success" : "error"
                );
                if (result.error) addLog(`éŒ¯èª¤: ${result.error}`, "error");
                if (result.description) addLog(result.description, "info");
                updateSystemInfo();
              })
              .catch((error) => {
                addLog("å•†éšŠäº¤æ˜“ç•°å¸¸: " + error.message, "error");
              });
          } else {
            addLog("ä»Šæ—¥ç„¡å•†éšŠé¸é …å¯æ¸¬è©¦", "warning");
          }
        } catch (error) {
          addLog("å•†éšŠäº¤æ˜“æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      window.testMutualAid = function () {
        if (!gameApp || !gameApp.tradeManager) {
          addLog("TradeManager æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          addLog("=== TradeManager äº’åŠ©ç³»çµ±æ¸¬è©¦ ===", "info");

          // æª¢æŸ¥ç§Ÿå®¢æ•¸é‡
          const tenants = gameApp.gameState
            ? gameApp.gameState.getAllTenants()
            : [];
          addLog(`ç•¶å‰ç§Ÿå®¢æ•¸é‡: ${tenants.length}`, "info");

          if (tenants.length < 2) {
            addLog("äº’åŠ©ç³»çµ±éœ€è¦è‡³å°‘2åç§Ÿå®¢", "warning");
            return;
          }

          // åŸ·è¡Œäº’åŠ©ç³»çµ±
          gameApp.tradeManager
            .processMutualAid()
            .then((result) => {
              addLog(
                `äº’åŠ©ç³»çµ±: ${result.success ? "âœ…æˆåŠŸ" : "âŒå¤±æ•—"}`,
                result.success ? "success" : "error"
              );
              if (result.transfers && result.transfers.length > 0) {
                addLog(`åŸ·è¡Œè½‰ç§»: ${result.transfers.length}ç­†`, "success");
                result.transfers.forEach((transfer) => {
                  addLog(
                    `  ${transfer.from} â†’ ${transfer.to}: ${JSON.stringify(
                      transfer.resources
                    )}`,
                    "info"
                  );
                });
              } else {
                addLog("ç„¡éœ€é€²è¡Œäº’åŠ©è½‰ç§»", "info");
              }
              updateSystemInfo();
            })
            .catch((error) => {
              addLog("äº’åŠ©ç³»çµ±ç•°å¸¸: " + error.message, "error");
            });
        } catch (error) {
          addLog("äº’åŠ©ç³»çµ±æ¸¬è©¦å¤±æ•—: " + error.message, "error");
        }
      };

      window.advanceGameDay = function () {
        if (!gameApp || !gameApp.gameState) {
          addLog("éŠæˆ²ç‹€æ…‹æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          const currentDay = gameApp.gameState.getStateValue("day", 1);
          const newDay = currentDay + 1;

          gameApp.gameState.setState("day", newDay, "é–‹ç™¼æ¸¬è©¦æ¨é€²");
          gameApp.eventBus.emit("new_day", {
            newDay: newDay,
            previousDay: currentDay,
          });

          addLog(
            `éŠæˆ²å¤©æ•¸æ¨é€²: ç¬¬ ${currentDay} å¤© â†’ ç¬¬ ${newDay} å¤©`,
            "success"
          );
          updateSystemInfo();
        } catch (error) {
          addLog("æ¨é€²éŠæˆ²å¤©æ•¸å¤±æ•—: " + error.message, "error");
        }
      };

      window.exportGameState = function () {
        if (!gameApp || !gameApp.gameState) {
          addLog("éŠæˆ²ç‹€æ…‹æœªåˆå§‹åŒ–", "error");
          return;
        }

        try {
          const gameState = gameApp.gameState.getState();
          const stateJson = JSON.stringify(gameState, null, 2);

          const blob = new Blob([stateJson], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `game-state-${new Date()
            .toISOString()
            .slice(0, 19)}.json`;
          a.click();
          URL.revokeObjectURL(url);

          addLog("éŠæˆ²ç‹€æ…‹å·²åŒ¯å‡º", "success");
        } catch (error) {
          addLog("åŒ¯å‡ºéŠæˆ²ç‹€æ…‹å¤±æ•—: " + error.message, "error");
        }
      };

      window.toggleAutoScroll = function () {
        autoScroll = !autoScroll;
        addLog(`è‡ªå‹•æ»¾å‹•: ${autoScroll ? "å•Ÿç”¨" : "åœç”¨"}`, "info");
      };

      // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", initializeApp);

      // é é¢å¸è¼‰æ™‚æ¸…ç†
      window.addEventListener("beforeunload", () => {
        if (updateInterval) {
          clearInterval(updateInterval);
        }
      });
    </script>
  </body>
</html>
