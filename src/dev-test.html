<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨ v2.0 - é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ</title>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body {
            font-family: "Courier New", monospace;
            background-color: #2a2a2a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .main-area {
            background: #1a1a1a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 20px;
        }

        .sidebar {
            background: #1a1a1a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 15px;
        }

        /* é–‹ç™¼ç’°å¢ƒå°ˆç”¨æ¨™è­˜ */
        .dev-indicator {
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            color: white;
            text-align: center;
            padding: 8px;
            margin: -20px -20px 20px -20px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
        }

        /* ç³»çµ±ç‹€æ…‹æ¨£å¼ */
        .system-status {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .status-normal {
            background: rgba(102, 255, 102, 0.2);
            border: 1px solid #66ff66;
            color: #66ff66;
        }

        .status-fallback {
            background: rgba(255, 204, 102, 0.2);
            border: 1px solid #ffcc66;
            color: #ffcc66;
        }

        .status-error {
            background: rgba(255, 102, 102, 0.2);
            border: 1px solid #ff6666;
            color: #ff6666;
        }

        /* ç‹€æ…‹é¡¯ç¤º */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-item {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            background: #4a4a4a;
            border: 1px solid #666;
            color: #e0e0e0;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #555;
        }

        .btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        .btn.success {
            background: #446644;
            border-color: #66aa66;
        }

        .btn.warning {
            background: #666644;
            border-color: #aaaa66;
        }

        .btn.danger {
            background: #664444;
            border-color: #aa6666;
        }

        /* æ—¥èªŒæ¨£å¼ */
        .log {
            background: #222;
            border: 1px solid #444;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            font-size: 12px;
            border-radius: 4px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.system {
            color: #66ccff;
        }

        .log-entry.event {
            color: #ffcc66;
        }

        .log-entry.error {
            color: #ff6666;
        }

        /* é™¤éŒ¯é¢æ¿æ¨£å¼ */
        .debug-panel {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .debug-section {
            margin-bottom: 10px;
        }

        .debug-section h4 {
            margin: 0 0 5px 0;
            color: #66ccff;
            font-size: 14px;
        }

        .debug-info {
            font-size: 11px;
            color: #ccc;
            font-family: monospace;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-area">
            <div class="dev-indicator">
                ğŸ”§ é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ - æ¨¡çµ„åŒ–æ¶æ§‹é©—è­‰
            </div>
            
            <h1>æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨ v2.0 - é–‹ç™¼æ¸¬è©¦</h1>
            <p>æ¨¡çµ„åŒ–æ¶æ§‹æ¸¬è©¦ç’°å¢ƒ - æ ¸å¿ƒç³»çµ±èˆ‡æ¥­å‹™æ¨¡çµ„é©—è­‰</p>

            <!-- ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
            <div id="mainSystemStatus" class="system-status status-normal">
                ğŸ”§ é–‹ç™¼ç’°å¢ƒæ­£åœ¨åˆå§‹åŒ–...
            </div>

            <!-- éŠæˆ²ç‹€æ…‹é¡¯ç¤º -->
            <div class="status-grid">
                <div class="status-item">
                    å¤©æ•¸: <span id="gameDay">-</span>
                </div>
                <div class="status-item">
                    ç¾é‡‘: $<span id="gameCash">-</span>
                </div>
                <div class="status-item">
                    é£Ÿç‰©: <span id="gameFood">-</span>
                </div>
                <div class="status-item">
                    ç§Ÿå®¢: <span id="gameTenants">-</span>
                </div>
            </div>

            <!-- æ¸¬è©¦æ§åˆ¶ -->
            <div class="controls">
                <button class="btn success" onclick="testDataManager()">æ¸¬è©¦è³‡æ–™ç®¡ç†</button>
                <button class="btn success" onclick="testGameState()">æ¸¬è©¦ç‹€æ…‹ç®¡ç†</button>
                <button class="btn success" onclick="testEventBus()">æ¸¬è©¦äº‹ä»¶ç³»çµ±</button>
                <button class="btn warning" onclick="runAllTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
                <button class="btn" onclick="showDebugInfo()">é¡¯ç¤ºé™¤éŒ¯è³‡è¨Š</button>
                <button class="btn danger" onclick="triggerError()">è§¸ç™¼éŒ¯èª¤æ¸¬è©¦</button>
            </div>

            <!-- éŠæˆ²æ—¥èªŒ -->
            <h3>ç³»çµ±æ—¥èªŒ</h3>
            <div class="log" id="gameLog">
                <div class="log-entry system">é–‹ç™¼ç’°å¢ƒæ­£åœ¨å•Ÿå‹•...</div>
            </div>
        </div>

        <div class="sidebar">
            <h3>ç³»çµ±è³‡è¨Š</h3>
            
            <!-- ç³»çµ±ç‹€æ…‹ -->
            <div class="debug-panel">
                <div class="debug-section">
                    <h4>æ ¸å¿ƒç³»çµ±</h4>
                    <div class="debug-info" id="coreSystemInfo">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
                
                <div class="debug-section">
                    <h4>æ¨¡çµ„ç‹€æ…‹</h4>
                    <div class="debug-info" id="moduleStatusInfo">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
                
                <div class="debug-section">
                    <h4>äº‹ä»¶çµ±è¨ˆ</h4>
                    <div class="debug-info" id="eventStatsInfo">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
            </div>

            <h3>å¿«é€Ÿæ“ä½œ</h3>
            <div class="controls" style="flex-direction: column;">
                <button class="btn" onclick="advanceDay()">æ¨é€²ä¸€å¤©</button>
                <button class="btn" onclick="addTestResources()">å¢åŠ æ¸¬è©¦è³‡æº</button>
                <button class="btn" onclick="clearLogs()">æ¸…ç©ºæ—¥èªŒ</button>
                <button class="btn" onclick="exportGameState()">åŒ¯å‡ºç‹€æ…‹</button>
            </div>

            <h3>é–‹ç™¼å·¥å…·</h3>
            <div class="debug-info" style="font-size: 10px;">
                <p>åœ¨ç€è¦½å™¨æ§åˆ¶å°è¼¸å…¥ <code>gameApp.debug()</code> æŸ¥çœ‹è©³ç´°è³‡è¨Š</p>
                <p>åœ¨ URL åŠ ä¸Š <code>?debug=true</code> å•Ÿç”¨é™¤éŒ¯æ¨¡å¼</p>
                <p>ç³»çµ±æœƒè‡ªå‹•æª¢æ¸¬æ¨¡çµ„è¼‰å…¥å’Œ ES6 æ”¯æ´</p>
                <p><strong>ç”¨é€”</strong>ï¼šé©—è­‰æ ¸å¿ƒç³»çµ±èˆ‡æ¥­å‹™æ¨¡çµ„æ•´åˆç‹€æ…‹</p>
            </div>
        </div>
    </div>

    <!-- æ¸¬è©¦è…³æœ¬ -->
    <script>
        // æ¸¬è©¦å‡½æ•¸ï¼ˆåœ¨æ¨¡çµ„è¼‰å…¥å‰æä¾›åŸºæœ¬åŠŸèƒ½ï¼‰

        function addLog(message, type = 'system') {
            const logElement = document.getElementById('gameLog');
            const entryElement = document.createElement('div');
            entryElement.className = `log-entry ${type}`;
            entryElement.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logElement.appendChild(entryElement);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateSystemStatus(status, message) {
            const statusElement = document.getElementById('mainSystemStatus');
            statusElement.className = `system-status status-${status}`;
            statusElement.textContent = message;
        }

        function updateGameStats() {
            if (!gameApp || !gameApp.gameState) return;

            const stats = gameApp.gameState.getStateStats();
            const resources = gameApp.gameState.getStateValue('resources', {});

            document.getElementById('gameDay').textContent = stats.day || 0;
            document.getElementById('gameCash').textContent = resources.cash || 0;
            document.getElementById('gameFood').textContent = resources.food || 0;
            document.getElementById('gameTenants').textContent = stats.totalTenants || 0;
        }

        function updateDebugInfo() {
            if (!gameApp) return;

            const status = gameApp.getStatus();
            
            // æ ¸å¿ƒç³»çµ±è³‡è¨Š
            document.getElementById('coreSystemInfo').innerHTML = `
                åˆå§‹åŒ–: ${status.initialized ? 'âœ…' : 'âŒ'}<br>
                æ¨¡å¼: ${status.mode}<br>
                é‹è¡Œæ™‚é–“: ${((Date.now() - startTime) / 1000).toFixed(1)}s
            `;

            // æ¨¡çµ„ç‹€æ…‹
            document.getElementById('moduleStatusInfo').innerHTML = `
                DataManager: ${status.dataManager ? 'âœ…' : 'âŒ'}<br>
                GameState: ${status.gameState ? 'âœ…' : 'âŒ'}<br>
                EventBus: ${status.eventBus ? 'âœ…' : 'âŒ'}
            `;

            // äº‹ä»¶çµ±è¨ˆ
            if (status.eventBus) {
                document.getElementById('eventStatsInfo').innerHTML = `
                    äº‹ä»¶é¡å‹: ${status.eventBus.totalEventTypes}<br>
                    ç›£è½å™¨: ${status.eventBus.totalListeners}<br>
                    æ­·å²è¨˜éŒ„: ${status.eventBus.eventHistory}
                `;
            }
        }

        // æ¸¬è©¦å‡½æ•¸
        function testDataManager() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            try {
                const rules = gameApp.dataManager.getGameRules();
                const tenants = gameApp.dataManager.getTenantTypes();
                addLog(`è³‡æ–™æ¸¬è©¦: è¦å‰‡ ${!!rules ? 'âœ…' : 'âŒ'}, ç§Ÿå®¢ ${!!tenants ? 'âœ…' : 'âŒ'}`, 'system');
            } catch (error) {
                addLog(`è³‡æ–™ç®¡ç†å™¨æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testGameState() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            try {
                const oldCash = gameApp.gameState.getStateValue('resources.cash');
                gameApp.gameState.modifyResource('cash', 100, 'æ¸¬è©¦å¢åŠ ');
                const newCash = gameApp.gameState.getStateValue('resources.cash');
                addLog(`ç‹€æ…‹æ¸¬è©¦: ${oldCash} â†’ ${newCash} ${newCash > oldCash ? 'âœ…' : 'âŒ'}`, 'system');
                updateGameStats();
            } catch (error) {
                addLog(`éŠæˆ²ç‹€æ…‹æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testEventBus() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            try {
                let received = false;
                const unsubscribe = gameApp.eventBus.on('test_event', () => {
                    received = true;
                    addLog('äº‹ä»¶æ¸¬è©¦: æˆåŠŸæ¥æ”¶æ¸¬è©¦äº‹ä»¶ âœ…', 'system');
                    unsubscribe();
                });
                
                gameApp.eventBus.emit('test_event', { test: true });
                
                setTimeout(() => {
                    if (!received) {
                        addLog('äº‹ä»¶æ¸¬è©¦: æœªæ¥æ”¶åˆ°äº‹ä»¶ âŒ', 'error');
                    }
                }, 100);
            } catch (error) {
                addLog(`äº‹ä»¶ç³»çµ±æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function runAllTests() {
            addLog('é–‹å§‹åŸ·è¡Œå®Œæ•´ç³»çµ±æ¸¬è©¦', 'system');
            testDataManager();
            setTimeout(() => testGameState(), 200);
            setTimeout(() => testEventBus(), 400);
            setTimeout(() => addLog('æ‰€æœ‰æ¸¬è©¦å®Œæˆ', 'system'), 600);
        }

        function showDebugInfo() {
            if (gameApp) {
                gameApp.debug();
                addLog('é™¤éŒ¯è³‡è¨Šå·²è¼¸å‡ºåˆ°æ§åˆ¶å°', 'system');
            } else {
                addLog('ç³»çµ±æœªåˆå§‹åŒ–ï¼Œç„¡æ³•é¡¯ç¤ºé™¤éŒ¯è³‡è¨Š', 'error');
            }
        }

        function triggerError() {
            try {
                throw new Error('é€™æ˜¯ä¸€å€‹æ¸¬è©¦éŒ¯èª¤');
            } catch (error) {
                addLog(`éŒ¯èª¤æ¸¬è©¦: ${error.message}`, 'error');
                if (gameApp && gameApp.eventBus) {
                    gameApp.eventBus.emit('test_error', { error: error.message });
                }
            }
        }

        function advanceDay() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            const success = gameApp.gameState.advanceDay();
            if (success) {
                addLog('æˆåŠŸæ¨é€²åˆ°ä¸‹ä¸€å¤©', 'event');
                updateGameStats();
            } else {
                addLog('æ¨é€²æ—¥æœŸå¤±æ•—', 'error');
            }
        }

        function addTestResources() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            gameApp.gameState.setState({
                resources: {
                    food: gameApp.gameState.getStateValue('resources.food') + 10,
                    materials: gameApp.gameState.getStateValue('resources.materials') + 5,
                    medical: gameApp.gameState.getStateValue('resources.medical') + 3,
                    cash: gameApp.gameState.getStateValue('resources.cash') + 50
                }
            }, 'æ¸¬è©¦è³‡æºå¢åŠ ');
            
            addLog('å¢åŠ æ¸¬è©¦è³‡æº', 'event');
            updateGameStats();
        }

        function clearLogs() {
            document.getElementById('gameLog').innerHTML = '';
            addLog('æ—¥èªŒå·²æ¸…ç©º', 'system');
        }

        function exportGameState() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            const exported = gameApp.gameState.export();
            console.log('éŠæˆ²ç‹€æ…‹åŒ¯å‡º:', exported);
            addLog('ç‹€æ…‹å·²åŒ¯å‡ºåˆ°æ§åˆ¶å°', 'system');
        }

        // ç³»çµ±ç›£æ§
        const startTime = Date.now();
        
        setInterval(() => {
            if (gameApp && gameApp.isInitialized) {
                updateGameStats();
                updateDebugInfo();
            }
        }, 2000);

        // éŒ¯èª¤è™•ç†
        window.addEventListener('error', (event) => {
            addLog(`å…¨å±€éŒ¯èª¤: ${event.error.message}`, 'error');
            updateSystemStatus('error', 'ğŸ”´ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤');
        });

        // ES6 æ¨¡çµ„æ”¯æ´æª¢æ¸¬
        if (!window.fetch || !window.Promise) {
            updateSystemStatus('error', 'ğŸ”´ ç€è¦½å™¨ä¸æ”¯æ´å¿…è¦åŠŸèƒ½');
            addLog('ç€è¦½å™¨ç¼ºå°‘å¿…è¦çš„ API æ”¯æ´', 'error');
        } else {
            addLog('ç€è¦½å™¨ç’°å¢ƒæª¢æŸ¥é€šé', 'system');
        }
    </script>

    <!-- ä¸»æ¨¡çµ„è¼‰å…¥ -->
    <script type="module">
        import { gameApp } from './js/main.js';
        
        // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
        const checkInit = setInterval(() => {
            if (window.gameApp) {
                // æ¨¡çµ„å·²è¼‰å…¥
                clearInterval(checkInit);
                window.gameApp = window.gameApp;
                
                // è¨­å®šå…¨å±€åƒè€ƒ
                window.gameApp = window.gameApp;
                
                updateSystemStatus('normal', 'ğŸŸ¢ é–‹ç™¼ç’°å¢ƒ v2.0 - é‹è¡Œä¸­');
                addLog('ES6 æ¨¡çµ„è¼‰å…¥æˆåŠŸ', 'system');
                addLog('æ ¸å¿ƒç³»çµ±å·²åˆå§‹åŒ–', 'system');
                addLog('é–‹ç™¼æ¸¬è©¦ç’°å¢ƒæº–å‚™å°±ç·’', 'system');
                
                // è‡ªå‹•æ›´æ–°ç‹€æ…‹
                updateGameStats();
                updateDebugInfo();
                
            }
        }, 100);

        // è¶…æ™‚è™•ç†
        setTimeout(() => {
            if (!window.gameApp) {
                clearInterval(checkInit);
                updateSystemStatus('error', 'ğŸ”´ æ¨¡çµ„è¼‰å…¥è¶…æ™‚');
                addLog('æ¨¡çµ„è¼‰å…¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘', 'error');
            }
        }, 5000);
    </script>

    <!-- å¾Œå‚™æ¨¡å¼ -->
    <script nomodule>
        updateSystemStatus('error', 'ğŸ”´ ä¸æ”¯æ´ ES6 æ¨¡çµ„');
        addLog('ç€è¦½å™¨ä¸æ”¯æ´ ES6 æ¨¡çµ„ï¼Œè«‹ä½¿ç”¨ç¾ä»£ç€è¦½å™¨', 'error');
    </script>
</body>
</html>