<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨ v2.0 - é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ</title>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body {
            font-family: "Courier New", monospace;
            background-color: #2a2a2a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .main-area {
            background: #1a1a1a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 20px;
        }

        .sidebar {
            background: #1a1a1a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 15px;
        }

        /* é–‹ç™¼ç’°å¢ƒå°ˆç”¨æ¨™è­˜ */
        .dev-indicator {
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            color: white;
            text-align: center;
            padding: 8px;
            margin: -20px -20px 20px -20px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
        }

        /* ç³»çµ±ç‹€æ…‹æ¨£å¼ */
        .system-status {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .status-normal {
            background: rgba(102, 255, 102, 0.2);
            border: 1px solid #66ff66;
            color: #66ff66;
        }

        .status-fallback {
            background: rgba(255, 204, 102, 0.2);
            border: 1px solid #ffcc66;
            color: #ffcc66;
        }

        .status-error {
            background: rgba(255, 102, 102, 0.2);
            border: 1px solid #ff6666;
            color: #ff6666;
        }

        /* ç‹€æ…‹é¡¯ç¤º */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-item {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            background: #4a4a4a;
            border: 1px solid #666;
            color: #e0e0e0;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #555;
        }

        .btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        .btn.success {
            background: #446644;
            border-color: #66aa66;
        }

        .btn.warning {
            background: #666644;
            border-color: #aaaa66;
        }

        .btn.danger {
            background: #664444;
            border-color: #aa6666;
        }

        .btn.business {
            background: #4a6644;
            border-color: #66aa66;
        }

        .btn.tenant {
            background: #665544;
            border-color: #aa9966;
        }

        /* æ—¥èªŒæ¨£å¼ */
        .log {
            background: #222;
            border: 1px solid #444;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            font-size: 12px;
            border-radius: 4px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.system {
            color: #66ccff;
        }

        .log-entry.event {
            color: #ffcc66;
        }

        .log-entry.error {
            color: #ff6666;
        }

        .log-entry.business {
            color: #66ff99;
        }

        .log-entry.tenant {
            color: #cc99ff;
        }

        /* é™¤éŒ¯é¢æ¿æ¨£å¼ */
        .debug-panel {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .debug-section {
            margin-bottom: 10px;
        }

        .debug-section h4 {
            margin: 0 0 5px 0;
            color: #66ccff;
            font-size: 14px;
        }

        .debug-info {
            font-size: 11px;
            color: #ccc;
            font-family: monospace;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-area">
            <div class="dev-indicator">
                ğŸ”§ é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ - å®Œæ•´æ¥­å‹™ç³»çµ±é©—è­‰ï¼ˆå«ç§Ÿå®¢ç®¡ç†ï¼‰
            </div>
            
            <h1>æœ«æ—¥æˆ¿æ±æ¨¡æ“¬å™¨ v2.0 - é–‹ç™¼æ¸¬è©¦</h1>
            <p>å®Œæ•´æ¥­å‹™ç³»çµ±æ¸¬è©¦ç’°å¢ƒ - æ ¸å¿ƒç³»çµ± + è³‡æºã€äº¤æ˜“ã€ç§Ÿå®¢ç®¡ç†æ¨¡çµ„æ•´åˆ</p>

            <!-- ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
            <div id="mainSystemStatus" class="system-status status-normal">
                ğŸ”§ é–‹ç™¼ç’°å¢ƒæ­£åœ¨åˆå§‹åŒ–...
            </div>

            <!-- éŠæˆ²ç‹€æ…‹é¡¯ç¤º -->
            <div class="status-grid">
                <div class="status-item">
                    å¤©æ•¸: <span id="gameDay">-</span>
                </div>
                <div class="status-item">
                    ç¾é‡‘: $<span id="gameCash">-</span>
                </div>
                <div class="status-item">
                    é£Ÿç‰©: <span id="gameFood">-</span>
                </div>
                <div class="status-item">
                    ç§Ÿå®¢: <span id="gameTenants">-</span>
                </div>
            </div>

            <!-- æ ¸å¿ƒç³»çµ±æ¸¬è©¦ -->
            <h3>ğŸ—ï¸ æ ¸å¿ƒç³»çµ±æ¸¬è©¦</h3>
            <div class="controls">
                <button class="btn success" onclick="testDataManager()">æ¸¬è©¦è³‡æ–™ç®¡ç†</button>
                <button class="btn success" onclick="testGameState()">æ¸¬è©¦ç‹€æ…‹ç®¡ç†</button>
                <button class="btn success" onclick="testEventBus()">æ¸¬è©¦äº‹ä»¶ç³»çµ±</button>
                <button class="btn warning" onclick="runCoreTests()">åŸ·è¡Œæ ¸å¿ƒæ¸¬è©¦</button>
            </div>

            <!-- æ¥­å‹™ç³»çµ±æ¸¬è©¦ -->
            <h3>ğŸ’¼ æ¥­å‹™ç³»çµ±æ¸¬è©¦</h3>
            <div class="controls">
                <button class="btn success" onclick="testResourceManager()">æ¸¬è©¦è³‡æºç®¡ç†</button>
                <button class="btn business" onclick="testTradeManager()">æ¸¬è©¦äº¤æ˜“ç³»çµ±</button>
                <button class="btn business" onclick="testTradeConfig()">æ¸¬è©¦äº¤æ˜“é…ç½®</button>
                <button class="btn business" onclick="testTradeValidation()">æ¸¬è©¦äº¤æ˜“é©—è­‰</button>
                <button class="btn warning" onclick="runBusinessTests()">åŸ·è¡Œæ¥­å‹™æ¸¬è©¦</button>
            </div>

            <!-- ç§Ÿå®¢ç³»çµ±æ¸¬è©¦ -->
            <h3>ğŸ˜ï¸ ç§Ÿå®¢ç³»çµ±æ¸¬è©¦</h3>
            <div class="controls">
                <button class="btn tenant" onclick="testTenantManager()">æ¸¬è©¦ç§Ÿå®¢ç®¡ç†</button>
                <button class="btn tenant" onclick="testGenerateApplicants()">ç”Ÿæˆç”³è«‹è€…</button>
                <button class="btn tenant" onclick="testHireTenant()">æ¸¬è©¦é›‡ç”¨ç§Ÿå®¢</button>
                <button class="btn tenant" onclick="testSatisfactionSystem()">æ¸¬è©¦æ»¿æ„åº¦ç³»çµ±</button>
                <button class="btn tenant" onclick="testEvictTenant()">æ¸¬è©¦é©…é€ç§Ÿå®¢</button>
                <button class="btn warning" onclick="runTenantTests()">åŸ·è¡Œç§Ÿå®¢æ¸¬è©¦</button>
            </div>

            <!-- æ•´åˆæ¸¬è©¦ -->
            <h3>ğŸ”— æ•´åˆæ¸¬è©¦</h3>
            <div class="controls">
                <button class="btn" onclick="showDebugInfo()">é¡¯ç¤ºé™¤éŒ¯è³‡è¨Š</button>
                <button class="btn danger" onclick="triggerError()">è§¸ç™¼éŒ¯èª¤æ¸¬è©¦</button>
                <button class="btn warning" onclick="runAllTests()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
            </div>

            <!-- éŠæˆ²æ—¥èªŒ -->
            <h3>ç³»çµ±æ—¥èªŒ</h3>
            <div class="log" id="gameLog">
                <div class="log-entry system">é–‹ç™¼ç’°å¢ƒæ­£åœ¨å•Ÿå‹•...</div>
            </div>
        </div>

        <div class="sidebar">
            <h3>ç³»çµ±è³‡è¨Š</h3>
            
            <!-- æ ¸å¿ƒç³»çµ±ç‹€æ…‹ -->
            <div class="debug-panel">
                <div class="debug-section">
                    <h4>æ ¸å¿ƒç³»çµ±</h4>
                    <div class="debug-info" id="coreSystemInfo">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
                
                <div class="debug-section">
                    <h4>æ¨¡çµ„ç‹€æ…‹</h4>
                    <div class="debug-info" id="moduleStatusInfo">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
                
                <div class="debug-section">
                    <h4>äº‹ä»¶çµ±è¨ˆ</h4>
                    <div class="debug-info" id="eventStatsInfo">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
            </div>

            <!-- æ¥­å‹™ç³»çµ±ç‹€æ…‹ -->
            <div class="debug-panel">
                <div class="debug-section">
                    <h4>æ¥­å‹™ç³»çµ±</h4>
                    <div class="debug-info" id="businessSystemInfo">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
                
                <div class="debug-section">
                    <h4>äº¤æ˜“ç³»çµ±</h4>
                    <div class="debug-info" id="tradeSystemInfo">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>

                <div class="debug-section">
                    <h4>ç§Ÿå®¢ç³»çµ±</h4>
                    <div class="debug-info" id="tenantSystemInfo">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
            </div>

            <h3>å¿«é€Ÿæ“ä½œ</h3>
            <div class="controls" style="flex-direction: column;">
                <button class="btn" onclick="advanceDay()">æ¨é€²ä¸€å¤©</button>
                <button class="btn" onclick="addTestResources()">å¢åŠ æ¸¬è©¦è³‡æº</button>
                <button class="btn tenant" onclick="generateTestApplicants()">ç”Ÿæˆæ¸¬è©¦ç”³è«‹è€…</button>
                <button class="btn" onclick="clearLogs()">æ¸…ç©ºæ—¥èªŒ</button>
                <button class="btn" onclick="exportGameState()">åŒ¯å‡ºç‹€æ…‹</button>
            </div>

            <h3>é–‹ç™¼å·¥å…·</h3>
            <div class="debug-info" style="font-size: 10px;">
                <p>åœ¨ç€è¦½å™¨æ§åˆ¶å°è¼¸å…¥ <code>gameApp.debug()</code> æŸ¥çœ‹è©³ç´°è³‡è¨Š</p>
                <p>åœ¨ URL åŠ ä¸Š <code>?debug=true</code> å•Ÿç”¨é™¤éŒ¯æ¨¡å¼</p>
                <p>ç³»çµ±æœƒè‡ªå‹•æª¢æ¸¬æ¨¡çµ„è¼‰å…¥å’Œ ES6 æ”¯æ´</p>
                <p><strong>ç”¨é€”</strong>ï¼šé©—è­‰å®Œæ•´æ¥­å‹™ç³»çµ±æ•´åˆç‹€æ…‹</p>
                <p><strong>æ–°å¢</strong>ï¼šTenantManager ç§Ÿå®¢ç”Ÿå‘½é€±æœŸç®¡ç†å’Œæ»¿æ„åº¦ç³»çµ±</p>
            </div>
        </div>
    </div>

    <!-- æ¸¬è©¦è…³æœ¬ -->
    <script>
        // æ¸¬è©¦å‡½æ•¸ï¼ˆåœ¨æ¨¡çµ„è¼‰å…¥å‰æä¾›åŸºæœ¬åŠŸèƒ½ï¼‰
        function addLog(message, type = 'system') {
            const logElement = document.getElementById('gameLog');
            const entryElement = document.createElement('div');
            entryElement.className = `log-entry ${type}`;
            entryElement.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logElement.appendChild(entryElement);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateSystemStatus(status, message) {
            const statusElement = document.getElementById('mainSystemStatus');
            statusElement.className = `system-status status-${status}`;
            statusElement.textContent = message;
        }

        function updateGameStats() {
            if (!gameApp || !gameApp.gameState) return;

            const stats = gameApp.gameState.getStateStats();
            const resources = gameApp.gameState.getStateValue('resources', {});

            document.getElementById('gameDay').textContent = stats.day || 0;
            document.getElementById('gameCash').textContent = resources.cash || 0;
            document.getElementById('gameFood').textContent = resources.food || 0;
            document.getElementById('gameTenants').textContent = stats.totalTenants || 0;
        }

        function updateDebugInfo() {
            if (!gameApp) return;

            const status = gameApp.getStatus();
            
            // æ ¸å¿ƒç³»çµ±è³‡è¨Š
            document.getElementById('coreSystemInfo').innerHTML = `
                åˆå§‹åŒ–: ${status.initialized ? 'âœ…' : 'âŒ'}<br>
                æ¨¡å¼: ${status.mode}<br>
                é‹è¡Œæ™‚é–“: ${((Date.now() - startTime) / 1000).toFixed(1)}s
            `;

            // æ¨¡çµ„ç‹€æ…‹
            document.getElementById('moduleStatusInfo').innerHTML = `
                DataManager: ${status.dataManager ? 'âœ…' : 'âŒ'}<br>
                GameState: ${status.gameState ? 'âœ…' : 'âŒ'}<br>
                EventBus: ${status.eventBus ? 'âœ…' : 'âŒ'}
            `;

            // äº‹ä»¶çµ±è¨ˆ
            if (status.eventBus) {
                document.getElementById('eventStatsInfo').innerHTML = `
                    äº‹ä»¶é¡å‹: ${status.eventBus.totalEventTypes || 0}<br>
                    ç›£è½å™¨: ${status.eventBus.totalListeners || 0}<br>
                    æ­·å²è¨˜éŒ„: ${status.eventBus.eventHistory || 0}
                `;
            }

            // æ¥­å‹™ç³»çµ±è³‡è¨Š
            document.getElementById('businessSystemInfo').innerHTML = `
                ResourceManager: ${resourceManager ? 'âœ…' : 'âŒ'}<br>
                TradeManager: ${tradeManager ? 'âœ…' : 'âŒ'}<br>
                TenantManager: ${tenantManager ? 'âœ…' : 'âŒ'}<br>
                SkillManager: ğŸš§ æœªè¼‰å…¥<br>
                EventManager: ğŸš§ æœªè¼‰å…¥
            `;

            // äº¤æ˜“ç³»çµ±è©³ç´°è³‡è¨Š
            if (tradeManager) {
                const tradeStatus = tradeManager.getStatus();
                document.getElementById('tradeSystemInfo').innerHTML = `
                    åˆå§‹åŒ–: ${tradeStatus.initialized ? 'âœ…' : 'âŒ'}<br>
                    é…ç½®è¼‰å…¥: ${tradeStatus.configLoaded ? 'âœ…' : 'âŒ'}<br>
                    åŒ¯ç‡è¼‰å…¥: ${tradeStatus.exchangeRatesLoaded ? 'âœ…' : 'âŒ'}<br>
                    å•†äººæ¨¡æ¿: ${tradeStatus.merchantTemplatesLoaded ? 'âœ…' : 'âŒ'}<br>
                    å•†éšŠé¸é …: ${tradeStatus.caravanOffersLoaded ? 'âœ…' : 'âŒ'}<br>
                    ç³»çµ±å¥åº·: ${tradeStatus.systemHealth.healthy ? 'âœ…' : 'âš ï¸'}
                `;
            } else {
                document.getElementById('tradeSystemInfo').innerHTML = `
                    TradeManager æœªåˆå§‹åŒ–
                `;
            }

            // ç§Ÿå®¢ç³»çµ±è©³ç´°è³‡è¨Š
            if (tenantManager) {
                const tenantStatus = tenantManager.getStatus();
                const tenantStats = tenantStatus.stats;
                document.getElementById('tenantSystemInfo').innerHTML = `
                    åˆå§‹åŒ–: ${tenantStatus.initialized ? 'âœ…' : 'âŒ'}<br>
                    é…ç½®è¼‰å…¥: ${tenantStatus.configLoaded ? 'âœ…' : 'âŒ'}<br>
                    ç§Ÿå®¢ç¸½æ•¸: ${tenantStats.totalTenants}<br>
                    å¥åº·ç§Ÿå®¢: ${tenantStats.healthyTenants}<br>
                    æ„ŸæŸ“ç§Ÿå®¢: ${tenantStats.infectedTenants}<br>
                    å¹³å‡æ»¿æ„åº¦: ${tenantStats.averageSatisfaction}<br>
                    æ´»èºè¡çª: ${tenantStatus.activeConflicts}<br>
                    é©—è­‰å™¨: ${tenantStatus.validatorAvailable ? 'âœ…' : 'âŒ'}
                `;
            } else {
                document.getElementById('tenantSystemInfo').innerHTML = `
                    TenantManager æœªåˆå§‹åŒ–
                `;
            }
        }

        // ==========================================
        // æ ¸å¿ƒç³»çµ±æ¸¬è©¦å‡½æ•¸
        // ==========================================

        function testDataManager() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            try {
                const rules = gameApp.dataManager.getGameRules();
                const tenants = gameApp.dataManager.getTenantTypes();
                addLog(`è³‡æ–™æ¸¬è©¦: è¦å‰‡ ${!!rules ? 'âœ…' : 'âŒ'}, ç§Ÿå®¢ ${!!tenants ? 'âœ…' : 'âŒ'}`, 'system');
            } catch (error) {
                addLog(`è³‡æ–™ç®¡ç†å™¨æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testGameState() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            try {
                const oldCash = gameApp.gameState.getStateValue('resources.cash');
                gameApp.gameState.modifyResource('cash', 100, 'æ¸¬è©¦å¢åŠ ');
                const newCash = gameApp.gameState.getStateValue('resources.cash');
                addLog(`ç‹€æ…‹æ¸¬è©¦: ${oldCash} â†’ ${newCash} ${newCash > oldCash ? 'âœ…' : 'âŒ'}`, 'system');
                updateGameStats();
            } catch (error) {
                addLog(`éŠæˆ²ç‹€æ…‹æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testEventBus() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            try {
                let received = false;
                const unsubscribe = gameApp.eventBus.on('test_event', () => {
                    received = true;
                    addLog('äº‹ä»¶æ¸¬è©¦: æˆåŠŸæ¥æ”¶æ¸¬è©¦äº‹ä»¶ âœ…', 'system');
                    unsubscribe();
                });
                
                gameApp.eventBus.emit('test_event', { test: true });
                
                setTimeout(() => {
                    if (!received) {
                        addLog('äº‹ä»¶æ¸¬è©¦: æœªæ¥æ”¶åˆ°äº‹ä»¶ âŒ', 'error');
                    }
                }, 100);
            } catch (error) {
                addLog(`äº‹ä»¶ç³»çµ±æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function runCoreTests() {
            addLog('é–‹å§‹åŸ·è¡Œæ ¸å¿ƒç³»çµ±æ¸¬è©¦', 'system');
            testDataManager();
            setTimeout(() => testGameState(), 200);
            setTimeout(() => testEventBus(), 400);
            setTimeout(() => addLog('æ ¸å¿ƒç³»çµ±æ¸¬è©¦å®Œæˆ', 'system'), 600);
        }

        // ==========================================
        // æ¥­å‹™ç³»çµ±æ¸¬è©¦å‡½æ•¸
        // ==========================================
        function testResourceManager() {
            if (!gameApp.resourceManager) {
                return addLog('ResourceManager æœªåˆå§‹åŒ–', 'error');
            }
            
            try {
                // æ¸¬è©¦è³‡æºä¿®æ”¹åŠŸèƒ½
                const oldFood = gameApp.gameState.getStateValue('resources.food');
                const success = gameApp.resourceManager.modifyResource('food', 5, 'æ¸¬è©¦è³‡æºä¿®æ”¹');
                const newFood = gameApp.gameState.getStateValue('resources.food');
                
                // æ¸¬è©¦è³‡æºé©—è­‰åŠŸèƒ½
                const hasEnough = gameApp.resourceManager.hasEnoughResource('cash', 10);
                
                // æ¸¬è©¦è³‡æºç‹€æ…‹è©•ä¼°
                const foodStatus = gameApp.resourceManager.getResourceStatus('food');
                
                addLog(`ResourceManager æ¸¬è©¦: ä¿®æ”¹ ${success ? 'âœ…' : 'âŒ'}, é©—è­‰ ${hasEnough ? 'âœ…' : 'âŒ'}, ç‹€æ…‹ ${foodStatus ? 'âœ…' : 'âŒ'}`, 'system');
                addLog(`é£Ÿç‰©: ${oldFood} â†’ ${newFood}, ç‹€æ…‹: ${foodStatus.level}`, 'system');
                updateGameStats();
                
            } catch (error) {
                addLog(`ResourceManager æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testTradeManager() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            try {
                addLog('é–‹å§‹æ¸¬è©¦ TradeManager åˆå§‹åŒ–', 'business');
                
                if (!tradeManager) {
                    addLog('TradeManager æœªè¼‰å…¥ âŒ', 'error');
                    return;
                }

                // æ¸¬è©¦åŸºæœ¬ç‹€æ…‹
                const status = tradeManager.getStatus();
                addLog(`TradeManager ç‹€æ…‹: åˆå§‹åŒ– ${status.initialized ? 'âœ…' : 'âŒ'}`, 'business');
                addLog(`é…ç½®è¼‰å…¥: ${status.configLoaded ? 'âœ…' : 'âŒ'}`, 'business');
                
                // æ¸¬è©¦ç³»çµ±å¥åº·åº¦
                const health = status.systemHealth;
                addLog(`ç³»çµ±å¥åº·: ${health.healthy ? 'âœ…' : 'âš ï¸'}`, 'business');
                
                if (!health.healthy && health.issues.length > 0) {
                    health.issues.forEach(issue => {
                        addLog(`âš ï¸ å•é¡Œ: ${issue}`, 'error');
                    });
                } else {
                    addLog('TradeManager åŸºç¤åŠŸèƒ½æ¸¬è©¦é€šé âœ…', 'business');
                }
                
            } catch (error) {
                addLog(`TradeManager æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testTradeConfig() {
            if (!tradeManager) return addLog('TradeManager æœªåˆå§‹åŒ–', 'error');
            
            try {
                addLog('é–‹å§‹æ¸¬è©¦äº¤æ˜“é…ç½®', 'business');
                
                const status = tradeManager.getStatus();
                
                // æ¸¬è©¦åŒ¯ç‡è¼‰å…¥
                if (status.exchangeRatesLoaded) {
                    addLog('äº¤æ˜“åŒ¯ç‡è¼‰å…¥ âœ…', 'business');
                } else {
                    addLog('äº¤æ˜“åŒ¯ç‡è¼‰å…¥å¤±æ•— âŒ', 'error');
                }
                
                // æ¸¬è©¦å•†äººæ¨¡æ¿
                if (status.merchantTemplatesLoaded) {
                    addLog('å•†äººæ¨¡æ¿è¼‰å…¥ âœ…', 'business');
                } else {
                    addLog('å•†äººæ¨¡æ¿è¼‰å…¥å¤±æ•— âŒ', 'error');
                }
                
                // æ¸¬è©¦å•†éšŠé¸é …
                if (status.caravanOffersLoaded) {
                    addLog('å•†éšŠé¸é …è¼‰å…¥ âœ…', 'business');
                } else {
                    addLog('å•†éšŠé¸é …è¼‰å…¥å¤±æ•— âŒ', 'error');
                }
                
                // ç”Ÿæˆäº¤æ˜“å ±å‘Š
                const report = tradeManager.getTradeReport();
                addLog(`äº¤æ˜“é…ç½®æ¸¬è©¦å®Œæˆï¼Œç¸½é…ç½®é …ç›®: ${Object.keys(report.configuration).length}`, 'business');
                
            } catch (error) {
                addLog(`äº¤æ˜“é…ç½®æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testTradeValidation() {
            if (!tradeManager) return addLog('TradeManager æœªåˆå§‹åŒ–', 'error');
            
            try {
                addLog('é–‹å§‹æ¸¬è©¦äº¤æ˜“é©—è­‰åŠŸèƒ½', 'business');
                
                // æ¸¬è©¦å•†äººäº¤æ˜“é©—è­‰ï¼ˆæ¨¡æ“¬ï¼‰
                const mockMerchant = {
                    name: 'æ¸¬è©¦å•†äºº',
                    type: 'doctor',
                    isTrader: true
                };
                
                const mockOffer = {
                    type: 'service',
                    service: 'healthCheck',
                    price: 8,
                    description: 'æ¸¬è©¦å¥åº·æª¢æŸ¥'
                };
                
                const validation = tradeManager.validateMerchantTrade(mockMerchant, mockOffer);
                addLog(`å•†äººäº¤æ˜“é©—è­‰: ${validation.valid ? 'âœ…' : 'âŒ'}`, 'business');
                
                if (!validation.valid && validation.error) {
                    addLog(`é©—è­‰éŒ¯èª¤: ${validation.error}`, 'error');
                }
                
                // æ¸¬è©¦å•†éšŠäº¤æ˜“é©—è­‰ï¼ˆæ¨¡æ“¬ï¼‰
                const mockCaravanOffer = {
                    give: { fuel: 3 },
                    receive: { food: 10 },
                    description: 'æ¸¬è©¦å•†éšŠäº¤æ˜“'
                };
                
                const caravanValidation = tradeManager.validateCaravanTrade(mockCaravanOffer);
                addLog(`å•†éšŠäº¤æ˜“é©—è­‰: ${caravanValidation.valid ? 'âœ…' : 'âŒ'}`, 'business');
                
                addLog('äº¤æ˜“é©—è­‰æ¸¬è©¦å®Œæˆ', 'business');
                
            } catch (error) {
                addLog(`äº¤æ˜“é©—è­‰æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function runBusinessTests() {
            addLog('é–‹å§‹åŸ·è¡Œæ¥­å‹™ç³»çµ±æ¸¬è©¦', 'business');
            setTimeout(() => testResourceManager(), 200);
            setTimeout(() => testTradeManager(), 400);
            setTimeout(() => testTradeConfig(), 600);
            setTimeout(() => testTradeValidation(), 800);
            setTimeout(() => addLog('æ¥­å‹™ç³»çµ±æ¸¬è©¦å®Œæˆ', 'business'), 1000);
        }

        // ==========================================
        // ç§Ÿå®¢ç³»çµ±æ¸¬è©¦å‡½æ•¸
        // ==========================================

        function testTenantManager() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            try {
                addLog('é–‹å§‹æ¸¬è©¦ TenantManager åˆå§‹åŒ–', 'tenant');
                
                if (!tenantManager) {
                    addLog('TenantManager æœªè¼‰å…¥ âŒ', 'error');
                    return;
                }

                // æ¸¬è©¦åŸºæœ¬ç‹€æ…‹
                const status = tenantManager.getStatus();
                addLog(`TenantManager ç‹€æ…‹: åˆå§‹åŒ– ${status.initialized ? 'âœ…' : 'âŒ'}`, 'tenant');
                addLog(`é…ç½®è¼‰å…¥: ${status.configLoaded ? 'âœ…' : 'âŒ'}`, 'tenant');
                addLog(`é©—è­‰å™¨å¯ç”¨: ${status.validatorAvailable ? 'âœ…' : 'âŒ'}`, 'tenant');
                
                // æ¸¬è©¦çµ±è¨ˆåŠŸèƒ½
                const stats = tenantManager.getTenantStats();
                addLog(`ç§Ÿå®¢çµ±è¨ˆ: ç¸½æ•¸ ${stats.totalTenants}, å¥åº· ${stats.healthyTenants}, æ„ŸæŸ“ ${stats.infectedTenants}`, 'tenant');
                addLog(`å¹³å‡æ»¿æ„åº¦: ${stats.averageSatisfaction}`, 'tenant');
                
                addLog('TenantManager åŸºç¤åŠŸèƒ½æ¸¬è©¦é€šé âœ…', 'tenant');
                
            } catch (error) {
                addLog(`TenantManager æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testGenerateApplicants() {
            if (!tenantManager) return addLog('TenantManager æœªåˆå§‹åŒ–', 'error');
            
            try {
                addLog('é–‹å§‹æ¸¬è©¦ç”³è«‹è€…ç”Ÿæˆ', 'tenant');
                
                // ç”Ÿæˆç”³è«‹è€…
                const applicants = tenantManager.generateApplicants(3);
                addLog(`ç”Ÿæˆäº† ${applicants.length} å€‹ç”³è«‹è€…`, 'tenant');
                
                // é¡¯ç¤ºç”³è«‹è€…è©³æƒ…
                applicants.forEach((applicant, index) => {
                    addLog(`ç”³è«‹è€… ${index + 1}: ${applicant.name} (${applicant.type}) - æˆ¿ç§Ÿ $${applicant.rent}`, 'tenant');
                    addLog(`å¤–è§€: ${applicant.appearance}`, 'tenant');
                });
                
                addLog('ç”³è«‹è€…ç”Ÿæˆæ¸¬è©¦å®Œæˆ âœ…', 'tenant');
                
            } catch (error) {
                addLog(`ç”³è«‹è€…ç”Ÿæˆæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testHireTenant() {
            if (!tenantManager) return addLog('TenantManager æœªåˆå§‹åŒ–', 'error');
            
            try {
                addLog('é–‹å§‹æ¸¬è©¦ç§Ÿå®¢é›‡ç”¨', 'tenant');
                
                // å…ˆç”Ÿæˆç”³è«‹è€…
                const applicants = tenantManager.generateApplicants(1);
                if (applicants.length === 0) {
                    addLog('æ²’æœ‰å¯ç”¨çš„ç”³è«‹è€… âŒ', 'error');
                    return;
                }
                
                const applicant = applicants[0];
                addLog(`å˜—è©¦é›‡ç”¨: ${applicant.name} (${applicant.type})`, 'tenant');
                
                // æ¨¡æ“¬é›‡ç”¨æµç¨‹
                tenantManager.hireTenant(applicant).then(result => {
                    if (result.success) {
                        addLog(`é›‡ç”¨æˆåŠŸ: ${result.tenant.name} å…¥ä½æˆ¿é–“ ${result.roomId} âœ…`, 'tenant');
                        updateGameStats();
                    } else {
                        addLog(`é›‡ç”¨å¤±æ•—: ${result.error || result.reason} âŒ`, 'error');
                    }
                }).catch(error => {
                    addLog(`é›‡ç”¨éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                });
                
            } catch (error) {
                addLog(`ç§Ÿå®¢é›‡ç”¨æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testSatisfactionSystem() {
            if (!tenantManager) return addLog('TenantManager æœªåˆå§‹åŒ–', 'error');
            
            try {
                addLog('é–‹å§‹æ¸¬è©¦æ»¿æ„åº¦ç³»çµ±', 'tenant');
                
                // æ›´æ–°æ‰€æœ‰ç§Ÿå®¢æ»¿æ„åº¦
                tenantManager.updateTenantSatisfaction();
                
                // ç²å–æ»¿æ„åº¦æ•¸æ“š
                const satisfaction = tenantManager.getAllSatisfaction();
                const averageSatisfaction = tenantManager.calculateAverageSatisfaction();
                
                addLog(`ç•¶å‰ç§Ÿå®¢æ•¸é‡: ${satisfaction.size}`, 'tenant');
                addLog(`å¹³å‡æ»¿æ„åº¦: ${averageSatisfaction}`, 'tenant');
                
                // é¡¯ç¤ºå€‹åˆ¥æ»¿æ„åº¦
                satisfaction.forEach((value, tenantName) => {
                    const status = tenantManager.getSatisfactionStatus(value);
                    addLog(`${tenantName}: ${value} (${status.description} ${status.emoji})`, 'tenant');
                });
                
                addLog('æ»¿æ„åº¦ç³»çµ±æ¸¬è©¦å®Œæˆ âœ…', 'tenant');
                
            } catch (error) {
                addLog(`æ»¿æ„åº¦ç³»çµ±æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testEvictTenant() {
            if (!tenantManager) return addLog('TenantManager æœªåˆå§‹åŒ–', 'error');
            
            try {
                addLog('é–‹å§‹æ¸¬è©¦ç§Ÿå®¢é©…é€', 'tenant');
                
                // ç²å–ç¾æœ‰ç§Ÿå®¢
                const tenants = gameApp.gameState.getAllTenants();
                if (tenants.length === 0) {
                    addLog('æ²’æœ‰å¯é©…é€çš„ç§Ÿå®¢', 'tenant');
                    return;
                }
                
                const targetTenant = tenants[0];
                addLog(`å˜—è©¦é©…é€: ${targetTenant.name}`, 'tenant');
                
                // æ¨¡æ“¬é©…é€æµç¨‹
                tenantManager.evictTenant(targetTenant.name, false, 'æ¸¬è©¦é©…é€').then(result => {
                    if (result.success) {
                        addLog(`é©…é€æˆåŠŸ: ${targetTenant.name} å·²é›¢é–‹ âœ…`, 'tenant');
                        if (result.refund > 0) {
                            addLog(`é€€é‚„æŠ¼é‡‘: $${result.refund}`, 'tenant');
                        }
                        updateGameStats();
                    } else {
                        addLog(`é©…é€å¤±æ•—: ${result.error || result.reason} âŒ`, 'error');
                    }
                }).catch(error => {
                    addLog(`é©…é€éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                });
                
            } catch (error) {
                addLog(`ç§Ÿå®¢é©…é€æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function runTenantTests() {
            addLog('é–‹å§‹åŸ·è¡Œç§Ÿå®¢ç³»çµ±æ¸¬è©¦', 'tenant');
            addLog('==========================================', 'tenant');
            
            setTimeout(() => testTenantManager(), 200);
            setTimeout(() => testGenerateApplicants(), 400);
            setTimeout(() => testSatisfactionSystem(), 600);
            
            // æ¸¬è©¦é›‡ç”¨å’Œé©…é€ï¼ˆéœ€è¦æ›´é•·é–“éš”ç­‰å¾…ç•°æ­¥æ“ä½œï¼‰
            setTimeout(() => testHireTenant(), 800);
            
            setTimeout(() => {
                addLog('------------------------------------------', 'tenant');
                addLog('ç§Ÿå®¢ç³»çµ±æ¸¬è©¦å®Œæˆ', 'tenant');
                addLog('==========================================', 'tenant');
            }, 2000);
        }

        // ==========================================
        // æ•´åˆæ¸¬è©¦å‡½æ•¸
        // ==========================================

        function showDebugInfo() {
            if (gameApp) {
                gameApp.debug();
                addLog('é™¤éŒ¯è³‡è¨Šå·²è¼¸å‡ºåˆ°æ§åˆ¶å°', 'system');
                
                if (tradeManager) {
                    console.log('TradeManager ç‹€æ…‹:', tradeManager.getStatus());
                    console.log('TradeManager å ±å‘Š:', tradeManager.getTradeReport());
                    addLog('TradeManager é™¤éŒ¯è³‡è¨Šå·²è¼¸å‡º', 'business');
                }

                if (tenantManager) {
                    console.log('TenantManager ç‹€æ…‹:', tenantManager.getStatus());
                    console.log('TenantManager çµ±è¨ˆ:', tenantManager.getTenantStats());
                    console.log('TenantManager æ»¿æ„åº¦:', tenantManager.getAllSatisfaction());
                    addLog('TenantManager é™¤éŒ¯è³‡è¨Šå·²è¼¸å‡º', 'tenant');
                }
            } else {
                addLog('ç³»çµ±æœªåˆå§‹åŒ–ï¼Œç„¡æ³•é¡¯ç¤ºé™¤éŒ¯è³‡è¨Š', 'error');
            }
        }

        function triggerError() {
            try {
                throw new Error('é€™æ˜¯ä¸€å€‹æ¸¬è©¦éŒ¯èª¤');
            } catch (error) {
                addLog(`éŒ¯èª¤æ¸¬è©¦: ${error.message}`, 'error');
                if (gameApp && gameApp.eventBus) {
                    gameApp.eventBus.emit('test_error', { error: error.message });
                }
            }
        }

        function runAllTests() {
            addLog('ğŸ§ª é–‹å§‹åŸ·è¡Œå®Œæ•´ç³»çµ±æ¸¬è©¦', 'system');
            addLog('==========================================', 'system');
            
            // åŸ·è¡Œæ ¸å¿ƒæ¸¬è©¦
            runCoreTests();
            
            // å»¶é²åŸ·è¡Œæ¥­å‹™æ¸¬è©¦
            setTimeout(() => {
                addLog('------------------------------------------', 'system');
                runBusinessTests();
            }, 1000);
            
            // å»¶é²åŸ·è¡Œç§Ÿå®¢æ¸¬è©¦
            setTimeout(() => {
                addLog('------------------------------------------', 'system');
                runTenantTests();
            }, 2000);
            
            // å®Œæˆç¸½çµ
            setTimeout(() => {
                addLog('------------------------------------------', 'system');
                addLog('ğŸ‰ å®Œæ•´ç³»çµ±æ¸¬è©¦åŸ·è¡Œå®Œæˆ', 'system');
                addLog('==========================================', 'system');
            }, 4000);
        }

        // ==========================================
        // å¿«é€Ÿæ“ä½œå‡½æ•¸
        // ==========================================

        function advanceDay() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            const success = gameApp.gameState.advanceDay();
            if (success) {
                addLog('æˆåŠŸæ¨é€²åˆ°ä¸‹ä¸€å¤©', 'event');
                updateGameStats();
                
                // é‡ç½® TradeManager æ¯æ—¥çµ±è¨ˆ
                if (tradeManager) {
                    tradeManager.resetDailyStats();
                    addLog('TradeManager æ¯æ—¥çµ±è¨ˆå·²é‡ç½®', 'business');
                }

                // è§¸ç™¼ TenantManager æ¯æ—¥æ›´æ–°
                if (tenantManager) {
                    tenantManager.updateDailySatisfaction();
                    addLog('TenantManager æ¯æ—¥æ»¿æ„åº¦å·²æ›´æ–°', 'tenant');
                }
            } else {
                addLog('æ¨é€²æ—¥æœŸå¤±æ•—', 'error');
            }
        }

        function addTestResources() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            gameApp.gameState.setState({
                resources: {
                    food: gameApp.gameState.getStateValue('resources.food') + 10,
                    materials: gameApp.gameState.getStateValue('resources.materials') + 5,
                    medical: gameApp.gameState.getStateValue('resources.medical') + 3,
                    cash: gameApp.gameState.getStateValue('resources.cash') + 50
                }
            }, 'æ¸¬è©¦è³‡æºå¢åŠ ');
            
            addLog('å¢åŠ æ¸¬è©¦è³‡æº', 'event');
            updateGameStats();
        }

        function generateTestApplicants() {
            if (!tenantManager) return addLog('TenantManager æœªåˆå§‹åŒ–', 'error');
            
            const applicants = tenantManager.generateApplicants(2);
            addLog(`ç”Ÿæˆäº† ${applicants.length} å€‹æ¸¬è©¦ç”³è«‹è€…`, 'tenant');
            
            applicants.forEach((applicant, index) => {
                addLog(`ç”³è«‹è€… ${index + 1}: ${applicant.name} (${applicant.type})`, 'tenant');
            });
        }

        function clearLogs() {
            document.getElementById('gameLog').innerHTML = '';
            addLog('æ—¥èªŒå·²æ¸…ç©º', 'system');
        }

        function exportGameState() {
            if (!gameApp) return addLog('ç³»çµ±æœªåˆå§‹åŒ–', 'error');
            
            const exported = gameApp.gameState.export();
            console.log('éŠæˆ²ç‹€æ…‹åŒ¯å‡º:', exported);
            addLog('ç‹€æ…‹å·²åŒ¯å‡ºåˆ°æ§åˆ¶å°', 'system');
            
            if (tradeManager) {
                const tradeReport = tradeManager.getTradeReport();
                console.log('äº¤æ˜“ç³»çµ±å ±å‘Š:', tradeReport);
                addLog('äº¤æ˜“ç³»çµ±å ±å‘Šå·²åŒ¯å‡º', 'business');
            }

            if (tenantManager) {
                const tenantStats = tenantManager.getTenantStats();
                console.log('ç§Ÿå®¢ç³»çµ±çµ±è¨ˆ:', tenantStats);
                addLog('ç§Ÿå®¢ç³»çµ±çµ±è¨ˆå·²åŒ¯å‡º', 'tenant');
            }
        }

        // ç³»çµ±ç›£æ§
        const startTime = Date.now();
        
        setInterval(() => {
            if (gameApp && gameApp.isInitialized) {
                updateGameStats();
                updateDebugInfo();
            }
        }, 2000);

        // éŒ¯èª¤è™•ç†
        window.addEventListener('error', (event) => {
            addLog(`å…¨å±€éŒ¯èª¤: ${event.error.message}`, 'error');
            updateSystemStatus('error', 'ğŸ”´ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤');
        });

        // ES6 æ¨¡çµ„æ”¯æ´æª¢æ¸¬
        if (!window.fetch || !window.Promise) {
            updateSystemStatus('error', 'ğŸ”´ ç€è¦½å™¨ä¸æ”¯æ´å¿…è¦åŠŸèƒ½');
            addLog('ç€è¦½å™¨ç¼ºå°‘å¿…è¦çš„ API æ”¯æ´', 'error');
        } else {
            addLog('ç€è¦½å™¨ç’°å¢ƒæª¢æŸ¥é€šé', 'system');
        }
    </script>

    <!-- ä¸»æ¨¡çµ„è¼‰å…¥ -->
    <script type="module">
        import { gameApp } from './js/main.js';
        
        // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
        const checkInit = setInterval(async () => {
            if (window.gameApp) {
                // æ¨¡çµ„å·²è¼‰å…¥
                clearInterval(checkInit);

                // è¨­å®šå…¨å±€åƒè€ƒ
                window.gameApp = window.gameApp;
                window.resourceManager = gameApp.resourceManager;
                window.tradeManager = gameApp.tradeManager;
                window.tenantManager = gameApp.tenantManager;

                // åˆå§‹åŒ–äº¤æ˜“ç®¡ç†å™¨
                if (tradeManager) {
                    await tradeManager.initialize();
                }
                
                updateSystemStatus('normal', 'ğŸŸ¢ å®Œæ•´æ¥­å‹™ç³»çµ± v2.0 - é‹è¡Œä¸­ï¼ˆå«ç§Ÿå®¢ç®¡ç†ï¼‰');
                addLog('ES6 æ¨¡çµ„è¼‰å…¥æˆåŠŸ', 'system');
                addLog('æ ¸å¿ƒç³»çµ±å·²åˆå§‹åŒ–', 'system');
                addLog('æ¥­å‹™æ¨¡çµ„æ•´åˆæ¸¬è©¦ç’°å¢ƒæº–å‚™å°±ç·’', 'business');
                addLog('ç§Ÿå®¢ç®¡ç†ç³»çµ±å·²æ•´åˆ', 'tenant');

                // è‡ªå‹•æ›´æ–°ç‹€æ…‹
                updateGameStats();
                updateDebugInfo();
            }
        }, 100);

        // è¶…æ™‚è™•ç†
        setTimeout(() => {
            if (!window.gameApp) {
                clearInterval(checkInit);
                updateSystemStatus('error', 'ğŸ”´ æ¨¡çµ„è¼‰å…¥è¶…æ™‚');
                addLog('æ¨¡çµ„è¼‰å…¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘', 'error');
            }
        }, 15000); // å»¶é•·åˆ° 15 ç§’ï¼Œå› ç‚ºè¦è¼‰å…¥æ›´å¤šæ¨¡çµ„
    </script>

    <!-- å¾Œå‚™æ¨¡å¼ -->
    <script nomodule>
        updateSystemStatus('error', 'ğŸ”´ ä¸æ”¯æ´ ES6 æ¨¡çµ„');
        addLog('ç€è¦½å™¨ä¸æ”¯æ´ ES6 æ¨¡çµ„ï¼Œè«‹ä½¿ç”¨ç¾ä»£ç€è¦½å™¨', 'error');
    </script>
</body>
</html>