# 末日房東模擬器 - 架構設計文件 v2.0

## 📊 專案概述

### 當前狀態：基礎設施完成階段
本專案已成功建立**配置驅動的ES6模組化架構**，完成核心基礎設施建設，正在進入業務邏輯模組開發階段。

**重構策略**：直接模組分離重構（已驗證可行）  
**技術基礎**：ES6模組 + 配置驅動 + 事件通信  
**部署平台**：GitHub Pages（原生ES6支援）

### 核心成就
- ✅ **零依賴核心架構**：DataManager + GameState + EventBus
- ✅ **配置驅動體系**：rules.json集中配置，智慧後備模式
- ✅ **統一驗證系統**：validators.js輕量驗證機制
- ✅ **完整系統整合**：main.js協調，index.html測試驗證
- ✅ **詳細流程設計**：6張系統流程圖，20個技能架構

## 🏗️ 系統架構設計

### 六層架構模式

```
📊 配置層    │ rules.json, tenants.json, skills.json, events.json
🛠️ 工具層    │ constants.js, validators.js, helpers.js  
🏗️ 核心層    │ DataManager, GameState, EventBus (零依賴)
💼 業務層    │ ResourceManager → TradeManager → TenantManager → SkillManager → EventManager
🖥️ 介面層    │ UIManager, ModalManager, DisplayUpdater, InteractionHandler
🎮 應用層    │ main.js + index.html
```

### 關鍵設計原則

1. **單向依賴鏈**：每層只依賴下層，避免循環依賴
2. **配置驅動**：所有參數來自JSON檔案，無硬編碼
3. **事件解耦**：模組間透過EventBus通信
4. **統一驗證**：validators.js提供可選驗證機制
5. **智慧降級**：配置載入失敗時自動啟用後備模式

## 🔄 資料流架構

### 主要資料流向
```
JSON配置 → DataManager → GameState ← EventBus
    ↓         ↓           ↓        ↑
業務邏輯 → 資源管理 → 狀態更新 → 事件通知
    ↓         ↓           ↓        ↑  
UI更新 → 畫面渲染 → 使用者互動 → 事件觸發
```

### 資源管理流程
```
6種獲取渠道 → 中央資源庫(GameState) → 7種消費渠道
    ↓              ↓                    ↓
租客個人資源 → ResourceManager統一控制 → 閾值監控
```

## 🎯 核心系統設計

### DataManager - 統一資料管理
**職責**：載入並管理所有遊戲資料和配置
**特色**：
- 並行載入四個配置檔案
- 智慧後備模式（載入失敗時使用預設值）
- 統一存取介面：`getGameRules()`, `getTenantTypes()` 等
- 完整錯誤處理和重試機制

### GameState - 中央狀態管理  
**職責**：管理遊戲所有狀態，提供訂閱機制
**特色**：
- 深度複製保證狀態不變性
- 狀態變更歷史追蹤（50條記錄）
- 路徑式狀態存取：`getStateValue('resources.cash')`
- 資源管理輔助方法：`modifyResource()`, `hasEnoughResource()`
- 完整狀態匯入/匯出功能

### EventBus - 事件通信系統
**職責**：提供模組間事件驅動通信
**特色**：
- 標準發布/訂閱模式
- 一次性監聽和事件過濾
- 同步/非同步事件發送
- 完整事件統計和除錯功能
- 事件歷史記錄（100條記錄）

## 💼 業務系統設計

### 已設計待實作的業務模組

#### ResourceManager - 資源流轉控制
**依賴**：GameState, EventBus  
**職責**：
- 統一資源修改介面：`modifyResource()`, `transferResource()`
- 閾值監控：警告線、危險線自動檢查
- 資源驗證：防止負數、異常數值
- 轉移記錄：完整審計追蹤

#### TradeManager - 統一交易系統  
**依賴**：GameState, EventBus, ResourceManager  
**職責**：處理四種交易類型
- **租金交易**：現金優先→資源抵付→加固加成
- **商人交易**：基於職業的交易模板
- **商隊交易**：固定批量交易選項  
- **互助交易**：租客間自動互助邏輯

#### TenantManager - 租客生命週期
**依賴**：GameState, EventBus, ResourceManager, TradeManager  
**職責**：
- 租客雇用/驅逐流程
- 滿意度系統管理
- 租客關係和衝突處理
- 個人資源管理

#### SkillManager - 技能執行管理
**依賴**：GameState, EventBus, TenantManager  
**職責**：管理20個技能的執行
- **主動技能**：玩家手動觸發，消耗資源
- **被動技能**：自動觸發，條件滿足即生效  
- **特殊技能**：限制使用次數，永久效果
- 技能冷卻和使用次數管理

#### EventManager - 事件觸發處理
**依賴**：GameState, EventBus, ResourceManager, TenantManager  
**職責**：處理四類事件
- **隨機事件**：30%基礎機率（殭屍襲擊、商隊過路）
- **衝突事件**：動態機率基於滿意度和資源稀缺
- **特殊事件**：條件觸發（醫療緊急、建築危機）
- **腳本事件**：固定天數或成就觸發

## 🖥️ 介面系統設計

### 待實作的UI模組

#### UIManager - 介面狀態管理
**依賴**：GameState, EventBus  
**職責**：
- 統一畫面更新協調
- 狀態變更到UI的映射
- 介面元素生命週期管理

#### ModalManager - 彈窗系統
**依賴**：EventBus  
**職責**：
- 統一彈窗顯示/隱藏
- 彈窗堆疊管理
- 事件選擇介面

## 📈 每日循環流程

### 完整的遊戲日循環
```
🌅 新的一天 → 🌞 白天活動 → 🌆 傍晚準備 → 🌙 夜間事件 → 🔄 日終處理 → 💤 進入下一天
```

**白天活動**：收租 → 面試 → 維修 → 派遣 → 糾紛 → 採集 → 技能  
**夜間事件**：隨機事件觸發（殭屍襲擊、商隊過路、突發狀況）  
**日終處理**：資源消費 → 被動技能 → 租客互助 → 狀態更新

## 🎯 技能系統架構

### 20個技能分類管理
- **醫生技能(4個)**：治療感染、健康檢查、醫療生產、急救培訓
- **工人技能(4個)**：專業維修、房間加固、日常維護、建築升級  
- **農夫技能(4個)**：採集加成、種植作物、野外採集、食物保存
- **軍人技能(4個)**：戰鬥加成、夜間警戒、防禦工事、巡邏系統
- **長者技能(4個)**：和諧氛圍、糾紛調解、生活指導、人際網絡

### 技能執行流程
```
技能配置(JSON) → SkillManager → 驗證條件/成本 → 執行效果 → 更新狀態 → 記錄日誌
```

## 🚀 實作進度與規劃

### 當前完成狀態 (70%)
- ✅ **配置驅動核心架構** (100%)
- ✅ **統一驗證機制** (100%)  
- ✅ **系統級常數管理** (100%)
- ✅ **主程式系統整合** (100%)
- ✅ **完整架構設計** (100%)

### 下階段實作順序
1. **ResourceManager** (關鍵：為交易系統提供基礎)
2. **TradeManager** (核心：統一四種交易類型)  
3. **TenantManager** (重要：租客生命週期管理)
4. **SkillManager** (複雜：20個技能的執行邏輯)
5. **EventManager** (最複雜：動態事件系統)
6. **UI模組群** (最後：使用者介面完善)

### 技術驗證結果
- ✅ **ES6模組載入**：GitHub Pages原生支援
- ✅ **配置驅動架構**：JSON載入和後備模式正常
- ✅ **事件系統通信**：模組間解耦通信驗證
- ✅ **狀態管理機制**：訂閱/發布模式運作正常
- ✅ **錯誤處理機制**：優雅降級和錯誤恢復

## 🔒 品質保證機制

### 架構穩定性保證
1. **零循環依賴**：嚴格單向依賴鏈
2. **介面穩定性**：模組間通過標準化介面通信
3. **錯誤隔離**：單一模組錯誤不影響其他模組
4. **配置驅動**：減少程式碼修改，提高穩定性

### 開發效率保證  
1. **模組化開發**：支援並行開發不同模組
2. **即時驗證**：每個模組完成後立即整合測試
3. **統一除錯**：完整的日誌和統計機制
4. **文檔驅動**：詳細的介面和流程文檔

## 📋 部署與維護

### 部署策略
- **主版本**：GitHub Pages直接部署ES6模組
- **開發版本**：本地測試環境 + 即時重載
- **向後相容**：現代瀏覽器優先，提供降級提示

### 維護策略
- **配置熱更新**：修改JSON檔案無需重新部署
- **模組獨立更新**：單一模組更新不影響其他功能
- **版本控制**：語意化版本管理
- **效能監控**：內建統計和除錯功能

## 🎯 商業化準備

### 技術基礎已就緒
- **現代化架構**：支援快速功能迭代
- **擴展性設計**：新功能可無縫整合
- **效能優化**：模組按需載入，記憶體使用優化  
- **使用者體驗**：響應式設計，優雅錯誤處理

### 未來擴展方向
- **多平台支援**：PWA、Electron桌面版
- **雲端存檔**：遊戲進度雲端同步
- **多人互動**：房東間交易和競爭
- **內容創作**：使用者自定義租客和事件

---

**架構設計總結**：本架構實現了**配置驅動的模組化系統**，具備高度的可維護性、擴展性和穩定性。核心基礎設施已驗證完成，為後續商業化發展奠定了堅實的技術基礎。